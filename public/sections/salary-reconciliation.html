<style>
  .error-row {
    background-color: #fff5f5;
  }

  .error-row:hover {
    background-color: #ffe8e8;
  }

  tbody tr {
    border-bottom: 1px solid #e5e7eb;
    transition: background-color 0.2s;
  }

  tbody tr:hover {
    background-color: #f9fafb;
  }

  .highlight-error {
    color: #dc2626;
    font-weight: bold;
  }

  .highlight-success {
    color: #059669;
    font-weight: bold;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.2s ease;
  }

  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background-color: white;
    padding: 0;
    border-radius: 12px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
  }

  .modal-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
  }

  .modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .modal-body {
    padding: 30px;
  }

  /* Alert Modal Styles */
  .alert-modal .modal-content {
    max-width: 500px;
  }

  .alert-modal .modal-header.success {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
  }

  .alert-modal .modal-header.error {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  }

  .alert-modal .modal-header.warning {
    background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
  }

  .alert-modal .modal-header.info {
    background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @media print {
    body {
      background: white;
      padding: 0;
    }

    .no-print {
      display: none !important;
    }

    .shadow-2xl,
    .shadow-lg,
    .shadow-md {
      box-shadow: none !important;
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>

<!-- Content Container -->
<div class="p-6">
  
  <!-- Filter Form -->
  <div id="filterForm" class="border rounded-lg max-w-lg mx-auto p-6 mb-4">
    
    <form id="salarySummaryForm" class="space-y-4">
      <div>
        <label for="yearFilter" class="block font-semibold mb-2 text-gray-700 text-sm">Processing Year</label>
          <input type="number" disabled id="yearFilter"  class="w-full border rounded px-3 py-2 focus:ring focus:ring-green-300">
      </div>

      <div>
        <label for="monthFilter" class="block font-semibold mb-2 text-gray-700 text-sm">Processing Month</label>
        <select id="monthFilter" disabled class="bg-transparent w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
          <option value="">Select Month</option>
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>

      <div>
        <label for="errorFilter" class="block font-semibold mb-2 text-gray-700 text-sm">Filter</label>
        <select id="errorFilter" class="bg-transparent w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
          <option value="errors">Errors Only</option>
          <option value="all">All Records</option>
        </select>
      </div>

      <div class="flex justify-end items-center gap-2 pt-2">
        <button type="button" onclick="window.loadReconciliation()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          Generate Report
        </button>
      </div>
    </form>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" class="hidden">
    
    <!-- Show Form Button -->
    <div class="flex justify-between items-center mb-6 bg-green-50 text-green-900 p-4 rounded-lg mb-6 flex flex-wrap justify-between items-center gap-4">
      <button onclick="window.toggleForm()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
        Show Filters
      </button>
      
      <!-- Report Metadata -->
      <div id="reportMeta">
        <div>
          <div class="text-sm">
            <strong class="text-green-900">Produced On:</strong> <span id="reportDate"></span>
          </div>
          <div class="text-sm">
            <strong class="text-green-900">Period:</strong> <span id="reportPeriod"></span>
          </div>
        </div>
      </div>
      <button onclick="window.exportReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Export PDF
      </button>
    </div>

    <!-- Summary Cards -->
    <div id="summarySection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Cards will be inserted here -->
    </div>

    <!-- Overall Summary Table -->
    <div id="overallStatus" class="mb-8">
      <!-- Status will be inserted here -->
    </div>

    <!-- Employee Reconciliation Table -->
    <div id="employeeSection" class="mb-8">
      <div class="flex justify-between items-center mb-4 pb-3 border-b-4 border-indigo-600">
        <h3 class="text-xl font-semibold text-gray-800">Personnel Reconciliation Details</h3>
        <span id="errorCount" class="px-4 py-2 bg-red-100 text-red-800 rounded-full text-xs font-bold uppercase tracking-wide">0 Errors</span>
      </div>
      <div class="overflow-x-auto rounded-lg">
        <table id="employeeTable" class="min-w-full border border-gray-200 rounded-lg">
          <thead class="bg-green-50 text-green-900">
            <tr>
              <th class="border px-2 py-3 text-left border">Svc No</th>
              <th style="width: 25%;" class="border px-2 py-3 text-left border">Name</th>
              <th class="border px-2 py-3 text-left border">Basic Pay</th>
              <th class="border px-2 py-3 text-left border">Allowances</th>
              <th class="border px-2 py-3 text-left border">Deductions</th>
              <th class="border px-2 py-3 text-left border">Tax</th>
              <th class="border px-2 py-3 text-left border">Net Pay</th>
              <th class="border px-2 py-3 text-left border">Variance</th>
              <th class="border px-2 py-3 text-left border">Status</th>
              <th class="border px-2 py-3 text-left border no-print">Action</th>
            </tr>
          </thead>
          <tbody id="employeeTableBody">
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="hidden text-center py-12">
    <div class="inline-block w-12 h-12 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
    <p class="text-gray-600 text-lg">Loading reconciliation data...</p>
  </div>
</div>

<!-- Breakdown Modal -->
<div id="breakdownModal" class="modal">
  <div class="modal-content mx-4 max-h-[90vh] overflow-hidden">
    <div class="modal-header">
      <h3 id="modalTitle">Payment Breakdown</h3>
      <button class="modal-close" onclick="window.closeModal('breakdownModal')">&times;</button>
    </div>
    <div class="modal-body overflow-y-auto max-h-[70vh]">
      <div id="modalContent"></div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="modal alert-modal">
  <div class="modal-content">
    <div class="modal-header info">
      <h3>Processing</h3>
    </div>
    <div class="modal-body text-center py-8">
      <div class="inline-block w-16 h-16 border-4 border-gray-200 border-t-green-600 rounded-full animate-spin mb-4"></div>
      <p id="loadingMessage" class="text-gray-600 text-lg">Loading data...</p>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal alert-modal">
  <div class="modal-content">
    <div class="modal-header success">
      <h3>Success</h3>
      <button class="modal-close" onclick="window.closeModal('successModal')">&times;</button>
    </div>
    <div class="modal-body text-center py-8">
      <svg class="w-16 h-16 mx-auto text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p id="successMessage" class="text-gray-700 text-lg mb-6">Operation completed successfully!</p>
      <button onclick="window.closeModal('successModal')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal alert-modal">
  <div class="modal-content">
    <div class="modal-header error">
      <h3>Error</h3>
      <button class="modal-close" onclick="window.closeModal('errorModal')">&times;</button>
    </div>
    <div class="modal-body text-center py-8">
      <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p id="errorMessage" class="text-gray-700 text-lg mb-6">An error occurred</p>
      <button onclick="window.closeModal('errorModal')" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="modal alert-modal">
  <div class="modal-content">
    <div class="modal-header warning">
      <h3>Warning</h3>
      <button class="modal-close" onclick="window.closeModal('warningModal')">&times;</button>
    </div>
    <div class="modal-body text-center py-8">
      <svg class="w-16 h-16 mx-auto text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
      <p id="warningMessage" class="text-gray-700 text-lg mb-6">Please review this warning</p>
      <button onclick="window.closeModal('warningModal')" class="px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Info Modal -->
<div id="infoModal" class="modal alert-modal">
  <div class="modal-content">
    <div class="modal-header info">
      <h3>Information</h3>
      <button class="modal-close" onclick="window.closeModal('infoModal')">&times;</button>
    </div>
    <div class="modal-body text-center py-8">
      <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p id="infoMessage" class="text-gray-700 text-lg mb-6">Information message</p>
      <button onclick="window.closeModal('infoModal')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        Got it
      </button>
    </div>
  </div>
</div>

<script>
// Configuration
const API_BASE = '/salaryreconcile';
const token = localStorage.getItem('token');

// Modal functions
window.showModal = function(modalId) {
  document.getElementById(modalId).classList.add('show');
}

window.closeModal = function(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

window.showLoading = function(message = 'Loading data...') {
  document.getElementById('loadingMessage').textContent = message;
  showModal('loadingModal');
}

window.hideLoading = function() {
  closeModal('loadingModal');
}

window.showSuccess = function(message) {
  document.getElementById('successMessage').textContent = message;
  showModal('successModal');
}

window.showError = function(message) {
  document.getElementById('errorMessage').textContent = message;
  showModal('errorModal');
}

window.showWarning = function(message) {
  document.getElementById('warningMessage').textContent = message;
  showModal('warningModal');
}

window.showInfo = function(message) {
  document.getElementById('infoMessage').textContent = message;
  showModal('infoModal');
}

// Toggle form visibility
window.toggleForm = function() {
  const form = document.getElementById('filterForm');
  const results = document.getElementById('resultsSection');
  
  if (form.classList.contains('hidden')) {
    form.classList.remove('hidden');
    results.classList.add('hidden');
  } else {
    form.classList.add('hidden');
    results.classList.remove('hidden');
  }
}


// Helper function to convert month name to number
function getMonthNumber(monthName) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return months.indexOf(monthName) + 1;
}

// Helper function to convert month number to name
function getMonthName(monthNum) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return months[monthNum - 1] || '';
}

// Load filter options
async function loadFilters() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/salarysummary/filter-options`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success && result.data) {
        const period = result.data.currentPeriod;
        document.getElementById('yearFilter').value = period.year;
        document.getElementById('monthFilter').value = period.month;

        console.log('Current Period:', period);
      }
    }
  } catch (error) {
    console.error('Error loading current period:', error);
  }
}

// Load reconciliation data
window.loadReconciliation = async function() {
  const year = document.getElementById('yearFilter').value;
  const month = document.getElementById('monthFilter').value;
  const showErrorsOnly = document.getElementById('errorFilter').value === 'errors';

  if (!year || !month) {
    showWarning('Please select both year and month');
    return;
  }

  showLoading('Loading reconciliation data...');

  try {
    const periodCode = `${year}${month}`;
    
    // Load summary
    const summaryResponse = await fetch(
      `${API_BASE}/summary?year=${year}&month=${periodCode}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );

    let summaryData = null;
    if (summaryResponse.ok) {
      const summaryResult = await summaryResponse.json();
      if (summaryResult.success && summaryResult.data && summaryResult.data.length > 0) {
        summaryData = summaryResult.data[0];
      }
    }

    // Load employee details
    const employeesResponse = await fetch(
      `${API_BASE}/employees?year=${year}&month=${periodCode}&showErrorsOnly=${showErrorsOnly}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );

    if (!employeesResponse.ok) {
      throw new Error('Failed to load employee reconciliation data');
    }

    const employeesResult = await employeesResponse.json();
    
    if (!employeesResult.success) {
      throw new Error(employeesResult.error || 'Failed to load employee data');
    }

    const employeeDetails = employeesResult.data || [];

    const aggregatedData = {
      summary: summaryData,
      total_employees_checked: employeeDetails.length,
      employees_with_errors: employeeDetails.filter(e => e.status === 'ERROR').length,
      total_error_amount: employeeDetails.reduce((sum, e) => sum + Math.abs(e.error_amount || 0), 0),
      details: employeeDetails
    };

    hideLoading();
    displayReport(aggregatedData, year, month);

  } catch (error) {
    console.error('Error loading reconciliation:', error);
    hideLoading();
    showError('Error loading reconciliation: ' + error.message);
  }
}

// Display report
function displayReport(data, year, month) {
  document.getElementById('filterForm').classList.add('hidden');
  document.getElementById('resultsSection').classList.remove('hidden');
  //document.getElementById('noDataState').classList.add('hidden');
  
  document.getElementById('reportDate').textContent = new Date().toLocaleString();
  document.getElementById('reportPeriod').textContent = `${getMonthName(month)} ${year}`;

  displaySummaryCards(data);
  displayOverallStatus(data.summary);
  displayEmployeeTable(data.details);
}

// Display summary cards
function displaySummaryCards(data) {
  const container = document.getElementById('summarySection');

  const totalErrorAmount = data.total_error_amount || 0;
  const status = Math.abs(totalErrorAmount) < 0.01 ? 'BALANCED' : 'VARIANCE DETECTED';
  const errorRate = data.total_employees_checked > 0 
    ? ((data.employees_with_errors / data.total_employees_checked) * 100).toFixed(1)
    : 0;

  container.innerHTML = `
    <!--<div>
      <h3 class="text-sm uppercase tracking-wide opacity-90 mb-2">Total Employees</h3>
      <div class="text-4xl font-bold mb-1">${data.total_employees_checked.toLocaleString()}</div>
      <div class="text-xs opacity-80">Checked in reconciliation</div>
    </div>

    <div>
      <h3 class="text-sm uppercase tracking-wide opacity-90 mb-2">Employees with Errors</h3>
      <div class="text-4xl font-bold mb-1">${data.employees_with_errors.toLocaleString()}</div>
      <div class="text-xs opacity-80">${errorRate}% error rate</div>
    </div>

    <div>
      <h3 class="text-sm uppercase tracking-wide opacity-90 mb-2">Total Error Amount</h3>
      <div class="text-4xl font-bold mb-1">₦${Math.abs(totalErrorAmount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
      <div class="text-xs opacity-80">Cumulative variance</div>
    </div>

    <div>
      <h3 class="text-sm uppercase tracking-wide opacity-90 mb-2">Overall Status</h3>
      <div class="text-xl font-bold mb-1">${status}</div>
      <div class="text-xs opacity-80">Reconciliation result</div>
    </div>-->
  `;
}

// Display overall status
function displayOverallStatus(summary) {
  if (!summary) return;

  const container = document.getElementById('overallStatus');

  const variance = parseFloat(summary.calculated_variance) || 0;
  const statusClass = Math.abs(variance) < 0.01 ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';

  container.innerHTML = `
    <div class="flex justify-between items-center mb-4 pb-3 border-b-4 border-indigo-600">
      <h3 class="text-xl font-semibold text-gray-800">Overall Summary</h3>
      <span class="px-4 py-2 ${statusClass} rounded-full text-xs font-bold uppercase tracking-wide">${summary.status || 'Unknown'}</span>
    </div>
    <div class="overflow-x-auto rounded-lg">
      <table class="min-w-full border border-gray-200 rounded-lg">
        <thead class="bg-green-50 text-green-900">
          <tr>
            <th class="border px-2 py-3 text-left border">Total Gross</th>
            <th class="border px-2 py-3 text-left border">Total Tax</th>
            <th class="border px-2 py-3 text-left border">Total Net</th>
            <th class="border px-2 py-3 text-left border">Total Earnings</th>
            <th class="border px-2 py-3 text-left border">Total Deductions</th>
            <th class="border px-2 py-3 text-left border">Variance</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(summary.total_gross)}</td>
            <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(summary.total_tax)}</td>
            <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(summary.total_net)}</td>
            <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(summary.detail_earnings)}</td>
            <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(summary.detail_deductions)}</td>
            <td class="px-4 py-3 text-sm border font-bold ${Math.abs(variance) >= 0.01 ? 'highlight-error' : 'highlight-success'}">
              ₦${formatNumber(Math.abs(variance))}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

// Display employee table
function displayEmployeeTable(details) {
  const container = document.getElementById('employeeSection');
  const tbody = document.getElementById('employeeTableBody');

  if (!details || details.length === 0) {
    container.classList.add('hidden');
    return;
  }

  container.classList.remove('hidden');
  const errorCount = details.filter(d => d.status === 'ERROR').length;
  document.getElementById('errorCount').textContent = `${errorCount} Error${errorCount !== 1 ? 's' : ''}`;

  tbody.innerHTML = details.map((emp, index) => {
    // Group payments by categories - only those with amounts > 0
    const breakdown = emp.payment_breakdown || [];
    const grossPay = breakdown.filter(p => ['BP', 'BT'].includes(p.type.substring(0, 2)) && p.amount > 0).reduce((sum, p) => sum + p.amount, 0);
    const allowances = breakdown.filter(p => ['PT', 'PU'].includes(p.type.substring(0, 2)) && p.amount > 0).reduce((sum, p) => sum + p.amount, 0);
    const deductions = breakdown.filter(p => ['PR', 'PL'].includes(p.type.substring(0, 2)) && p.amount > 0).reduce((sum, p) => sum + p.amount, 0);
    const tax = emp.tax_from_cum || 0;
    const netCum = emp.net_from_cum || 0;
    const variance = emp.error_amount || 0;
    
    // Determine status badge
    let statusBadge = '';
    if (Math.abs(variance) < 0.01) {
      statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold uppercase">Balanced</span>';
    } else if (variance > 0) {
      statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold uppercase">Underpayment</span>';
    } else {
      statusBadge = '<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-bold uppercase">Overpayment</span>';
    }

    return `
      <tr class="${emp.status === 'ERROR' ? 'error-row' : ''} border-b">
        <td class="px-4 py-3 border font-semibold">${escapeHtml(emp.employee_number)}</td>
        <td class="px-4 py-3 text-sm border border font-bold">${escapeHtml(emp.employee_name)}</td>
        <td class="px-4 py-3 text-sm border">₦${formatNumber(grossPay)}</td>
        <td class="px-4 py-3 text-sm border">₦${formatNumber(allowances)}</td>
        <td class="px-4 py-3 text-sm border">₦${formatNumber(deductions)}</td>
        <td class="px-4 py-3 text-sm border">₦${formatNumber(tax)}</td>
        <td class="px-4 py-3 text-sm border font-semibold">₦${formatNumber(netCum)}</td>
        <td class="px-4 py-3 text-sm border font-bold ${emp.status === 'ERROR' ? 'highlight-error' : 'highlight-success'}">
          ₦${formatNumber(Math.abs(variance))}
        </td>
        <td class="px-4 py-3 text-center text-sm">${statusBadge}</td>
        <td class="px-4 py-3 text-center no-print">
          <button onclick="window.showBreakdown(${index})" class="view-btn text-sm text-blue-600 hover:underline">
            View
          </button>
        </td>
      </tr>
    `;
  }).join('');

  // Store details globally for modal access
  window.employeeDetails = details;
}

// Show breakdown modal
window.showBreakdown = function(index) {
  const emp = window.employeeDetails[index];
  const breakdown = emp.payment_breakdown || [];
  
  // Group by category - only show items with amounts > 0
  const groups = {
    'Basic Pay': breakdown.filter(p => ['BP', 'BT'].includes(p.type.substring(0, 2)) && p.amount > 0),
    'Allowances': breakdown.filter(p => ['PT', 'PU'].includes(p.type.substring(0, 2)) && p.amount > 0),
    'Deductions': breakdown.filter(p => ['PR', 'PL'].includes(p.type.substring(0, 2)) && p.amount > 0)
  };

  document.getElementById('modalTitle').textContent = `${emp.employee_number} - ${emp.employee_name}`;
  
  let html = `
    <div class="space-y-6">
      <div class="bg-gray-50 p-4 rounded-lg">
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div><strong>Service Number:</strong> ${emp.employee_number}</div>
          <div><strong>Name:</strong> ${emp.employee_name}</div>
          <div><strong>Rank:</strong> ${emp.title_description || 'N/A'}</div>
          <div><strong>Period:</strong> ${getMonthName(emp.period.substring(4, 6))} ${emp.period.substring(0, 4)}</div>
        </div>
      </div>
  `;

  // Only show groups that have items
  Object.entries(groups).forEach(([groupName, items]) => {
    if (items.length > 0) {
      const total = items.reduce((sum, item) => sum + item.amount, 0);
      html += `
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-100 px-4 py-3 font-semibold flex justify-between items-center">
            <span>${groupName}</span>
            <span class="text-indigo-600">₦${formatNumber(total)}</span>
          </div>
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold">Type</th>
                <th class="px-4 py-2 text-left text-xs font-semibold">Description</th>
                <!--<th class="px-4 py-2 text-left text-xs font-semibold">Category</th>-->
                <th class="px-4 py-2 text-right text-xs font-semibold">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(item => `
                <tr class="border-t">
                  <td class="px-4 py-2 text-sm">${item.type}</td>
                  <td class="px-4 py-2 text-sm">${item.type_description}</td>
                  <!--<td class="px-4 py-2 text-sm">${item.category}</td>-->
                  <td class="px-4 py-2 text-sm text-right">₦${formatNumber(item.amount)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
  });

  // Add reconciliation summary
  html += `
    <div class="border-t-2 border-gray-300 pt-4 mt-4">
      <h4 class="font-semibold mb-3">Reconciliation Summary</h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span>Total Earnings:</span><span class="font-semibold">₦${formatNumber(emp.total_earnings)}</span></div>
        <div class="flex justify-between"><span>Total Deductions:</span><span class="font-semibold">₦${formatNumber(emp.total_deductions)}</span></div>
        <div class="flex justify-between"><span>Tax:</span><span class="font-semibold">₦${formatNumber(emp.tax_from_cum)}</span></div>
        <div class="flex justify-between"><span>Net from Cumulative:</span><span class="font-semibold">₦${formatNumber(emp.net_from_cum)}</span></div>
        <div class="flex justify-between border-t-2 pt-2 mt-2">
          <span class="font-bold">Variance:</span>
          <span class="font-bold ${emp.status === 'ERROR' ? 'text-red-600' : 'text-blue-600'}">
            ₦${formatNumber(Math.abs(emp.error_amount))}
          </span>
        </div>
        <div class="text-center mt-2">
          ${emp.error_amount > 0 ? '<span class="text-red-600 font-semibold">UNDERPAYMENT</span>' : emp.error_amount < 0 ? '<span class="text-orange-600 font-semibold">OVERPAYMENT</span>' : '<span class="text-blue-600 font-semibold">BALANCED</span>'}
        </div>
      </div>
    </div>
  `;

  html += `</div>`;

  document.getElementById('modalContent').innerHTML = html;
  showModal('breakdownModal');
}

// Export report as PDF
window.exportReport = async function() {
  const year = document.getElementById('yearFilter').value;
  const month = document.getElementById('monthFilter').value;
  const errorFilter = document.getElementById('errorFilter').value;
  
  // Convert filter value to boolean
  const showErrorsOnly = errorFilter === 'errors';

  if (!year || !month) {
    showWarning('Please select both year and month');
    return;
  }

  showLoading('Exporting report...');

  try {
    // Build query parameters
    const params = new URLSearchParams({
      year: year,
      month: `${year}${month}`,
      showErrorsOnly: showErrorsOnly
    });

    const response = await fetch(
      `${API_BASE}/export?${params.toString()}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      }
    );

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to export report');
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    window.open(url, '_blank');

    const a = document.createElement('a');
    a.href = url;
    a.download = `salary_reconciliation_${year}_${month}.pdf`;
    
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);

    hideLoading();
    showSuccess(`Report exported successfully! (${showErrorsOnly ? 'Errors only' : 'All employees'})`);

  } catch (error) {
    console.error('Error exporting report:', error);
    hideLoading();
    showError('Error exporting report: ' + error.message);
  }
}

// Helper functions
function formatNumber(num) {
  if (num === null || num === undefined) return '0.00';
  return parseFloat(num).toLocaleString('en-NG', { 
    minimumFractionDigits: 2, 
    maximumFractionDigits: 2 
  });
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getMonthName(month) {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  const monthNum = parseInt(month) - 1;
  return months[monthNum] || month;
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modals = ['breakdownModal', 'successModal', 'errorModal', 'warningModal', 'infoModal'];
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (event.target === modal) {
      closeModal(modalId);
    }
  });
}

// Initialize
loadFilters();
</script>



