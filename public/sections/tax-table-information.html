<div class="p-6">
  <div class="flex flex-wrap justify-between">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Tax Table Configuration</h2>
    <div class="mb-4 flex justify-end gap-2">
      <button id="showFormBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add New</button>
      <button id="configureMfpBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Configure Minimum Free Pay</button>
      <button id="generateReportBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
        <i class="fas fa-file-alt mr-2"></i>Generate Report</button>
    </div>
  </div>

  <!-- Band Form -->
  <form id="bandForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 hidden">
    <div>
      <label class="block text-sm font-medium text-gray-700">Interval</label>
      <input type="text" id="interval" class="w-full border border-green-500 rounded-md px-3 py-2" placeholder="e.g., 1">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Value</label>
      <input type="number" id="value" class="w-full border border-green-500 rounded-md px-3 py-2" placeholder="Enter value">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Percentage</label>
      <input type="number" id="percentage" step="0.01" class="w-full border border-green-500 rounded-md px-3 py-2" placeholder="Enter percentage">
    </div>
    <div class="col-span-1 md:col-span-3 flex justify-end gap-2">
      <button type="button" id="saveBandBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      <button type="button" id="cancelBandBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
    </div>
  </form>

  <!-- Minimum Free Pay Form -->
  <form id="mfpForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
    <div>
      <label class="block text-sm font-medium text-gray-700">Free Pay Value</label>
      <input type="number" id="mfpValue" class="w-full border border-purple-500 rounded-md px-3 py-2" placeholder="e.g., 800000">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Percentage</label>
      <input type="number" id="mfpPerc" class="w-full border border-purple-500 rounded-md px-3 py-2" placeholder="e.g., 0">
    </div>
    <div class="col-span-1 md:col-span-2 flex justify-end gap-2">
      <button type="button" id="saveMfpBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      <button type="button" id="cancelMfpBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
    </div>
  </form>

  <!-- Data Display Table -->
  <div class="p-6 overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-green-100 text-green-900">
        <tr>
          <th class="border px-2 py-3 text-left">Interval</th>
          <th class="border px-2 py-3 text-left">Value</th>
          <th class="border px-2 py-3 text-left">Percentage</th>
          <th class="border px-2 py-3 text-left">Cumulative</th>
          <th class="border px-2 py-3 text-left">Lower Bound</th>
          <th class="border px-2 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="bandTableBody">
        <!-- Data will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-2 text-blue-600">Success!</h3>
    <p class="mb-4 text-gray-700">Action completed successfully!</p>
    <button id="closeSuccessModal" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">OK</button>
  </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
    <h3 id="alertTitle" class="text-lg font-semibold text-gray-800 mb-2">Alert!</h3>
    <p id="alertMessage" class="text-gray-600 mb-4"></p>
    <button id="alertOkBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="confirmMessage" class="mb-4 text-gray-700">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-2">
      <button id="cancelDeleteBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
  const API_URL = "/api/tax";
  const token = localStorage.getItem("token");
  let bandData = [];
  let editingIndex = null;

  const bandForm = document.getElementById("bandForm");
  const mfpForm = document.getElementById("mfpForm");
  const bandTableBody = document.getElementById("bandTableBody");

  // Load all bands (INTER<>999)
  async function loadBands() {
    try {
      const res = await fetch(API_URL, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Failed to load bands");
      bandData = await res.json();
      renderBandTable();
    } catch (err) {
      console.error(err);
      showAlert("Error loading bands.");
    }
  }

  function renderBandTable() {
    bandTableBody.innerHTML = bandData.map((item, index) => `
      <tr class="hover:bg-yellow-50">
        <td class="border px-2 py-3">${item.INTER}</td>
        <td class="border px-2 py-3">${item.val}</td>
        <td class="border px-2 py-3">${item.perc}%</td>
        <td class="border px-2 py-3">${item.cumval ?? "N/A"}</td>
        <td class="border px-2 py-3">${item.lowbound ?? "N/A"}</td>
        <td class="border px-2 py-3 text-sm">
          <button onclick="editBand(${index})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
          <button onclick="deleteBand(${index})" class="text-red-600 hover:text-red-900">Delete</button>
        </td>
      </tr>
    `).join("");
  }

  // --- Band CRUD ---
  document.getElementById("showFormBtn").addEventListener("click", () => {
    bandForm.classList.remove("hidden");
    editingIndex = null;
    resetBandForm();
  });

  document.getElementById("cancelBandBtn").addEventListener("click", () => {
    bandForm.classList.add("hidden");
    resetBandForm();
  });

  document.getElementById("saveBandBtn").addEventListener("click", async () => {
    const payload = {
      INTER: document.getElementById("interval").value.trim(),
      val: parseInt(document.getElementById("value").value.trim()),
      perc: parseFloat(document.getElementById("percentage").value.trim())
    };

    const requiredFields = ["INTER", "val", "perc"];

    let missingFields = requiredFields.filter(field => !payload[field] && payload[field] !== 0);
    
    if (missingFields.length) {
      return showAlert(`Please fill in all required fields: ${missingFields.join(", ")}`);
    }

    try {
      let response;
      if (editingIndex !== null) {
        response = await fetch(`${API_URL}/${payload.INTER}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
      } else {
        response = await fetch(`${API_URL}/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
      }
      if (!response.ok) throw new Error("Save failed");
      await loadBands();
      bandForm.classList.add("hidden");
      showSuccessModal();
    } catch (err) {
      showAlert(err.message);
    }
  });

  window.editBand = function(index) {
    const item = bandData[index];
    document.getElementById("interval").value = item.INTER;
    document.getElementById("value").value = item.val;
    document.getElementById("percentage").value = item.perc;
    editingIndex = index;
    bandForm.classList.remove("hidden");
  };

  window.deleteBand = async function(index) {
    const item = bandData[index];
    if (await confirmModal("Delete this band?")) {
      await fetch(`${API_URL}/${item.INTER}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      await loadBands();
      showSuccessModal();
    }
  };

  function resetBandForm() {
    ["interval", "value", "percentage"].forEach(id => document.getElementById(id).value = "");
  }

  // --- Minimum Free Pay ---
  document.getElementById("configureMfpBtn").addEventListener("click", async () => {
    try {
      const res = await fetch(`${API_URL}/999`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.ok) {
        const mfp = await res.json();
        document.getElementById("mfpValue").value = mfp.val || "";
        document.getElementById("mfpPerc").value = mfp.perc || "";
      }
    } catch {}
    mfpForm.classList.remove("hidden");
  });

  document.getElementById("cancelMfpBtn").addEventListener("click", () => {
    mfpForm.classList.add("hidden");
  });

  document.getElementById("saveMfpBtn").addEventListener("click", async () => {
    const val = document.getElementById("mfpValue").value.trim();
    const perc = document.getElementById("mfpPerc").value.trim();
    const payload = { INTER: 999, val: parseInt(val), perc: parseFloat(perc) || 0 };
    try {
      const res = await fetch(`${API_URL}/999`, { headers: { Authorization: `Bearer ${token}` } });
      let response;
      if (res.ok) {
        response = await fetch(`${API_URL}/999`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
      } else {
        response = await fetch(`${API_URL}/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
      }
      if (!response.ok) throw new Error("Save failed");
      showSuccessModal();
      mfpForm.classList.add("hidden");
    } catch {
      showAlert("Error saving Minimum Free Pay");
    }
  });

  // --- Modals ---
  function showSuccessModal() { document.getElementById("successModal").classList.remove("hidden"); }
  document.getElementById("closeSuccessModal").addEventListener("click", () => document.getElementById("successModal").classList.add("hidden"));

  function showAlert(message, title="Alert") {
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertMessage").textContent = message;
    document.getElementById("alertModal").classList.remove("hidden");
    document.getElementById("alertOkBtn").onclick = () => document.getElementById("alertModal").classList.add("hidden");
  }

  function confirmModal(message="Are you sure?") {
    return new Promise(resolve => {
      const modal = document.getElementById("confirmModal");
      document.getElementById("confirmMessage").textContent = message;
      modal.classList.remove("hidden");
      document.getElementById("cancelDeleteBtn").onclick = () => { modal.classList.add("hidden"); resolve(false); };
      document.getElementById("confirmDeleteBtn").onclick = () => { modal.classList.add("hidden"); resolve(true); };
    });
  }

async function generateReport() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  const timeStr = now.toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });

  // Fetch MFP separately
  let mfpData = null;
  try {
    const res = await fetch(`${API_URL}/999`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (res.ok) mfpData = await res.json();
  } catch (err) {
    console.warn("MFP not found");
  }

  const generatedBy = localStorage.getItem("full_name") || "System User";

  const printWindow = window.open('', '_blank');

  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Tax Table Configuration Report</title>
      <style>
        @page { 
          size: A4 portrait; 
          margin: 0.5mm; 
          background-color: #f8fbff; 
        }
        
        body { 
          font-family: Helvetica, Arial, sans-serif; 
          font-size: 8pt;
          margin: 40px;
          position: relative;
          color: #333;
        }

        /* Faint logo overlay */
        body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-image: url('photos/logo.png');
          background-size: auto 100%;
          background-repeat: no-repeat;
          background-position: center center;
          opacity: 0.02;
          z-index: -1;
          pointer-events: none;
        }

        .header-wrapper {
          display: flex;
          align-items: flex-start;
          margin-bottom: 8px;
          border-bottom: 2px solid #1a1a1a;
          padding-bottom: 5px;
        }

        .header {
          flex-grow: 1;
          text-align: center;
        }
        
        .header h1 {
          font-size: 13pt;
          font-weight: bold;
          margin-bottom: 2px;
          letter-spacing: 1.5px;
          color: #15803d;
          font-family: 'Libre Baskerville', Georgia, serif;
        }
        
        .header h2 {
          font-size: 10pt;
          font-weight: normal;
          margin-top: 2px;
          color: #4a4a4a;
          font-family: 'Libre Baskerville', Georgia, serif;
        }

        .header-info {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 10px 0;
          font-size: 9pt;
        }

        .summary-box {
          border-top: 1.5px solid #0070C0;
          border-bottom: 1.5px solid #0070C0;
          padding: 8px 0;
          margin-bottom: 15px;
          display: flex;
          justify-content: space-around;
          align-items: center;
        }

        .summary-item {
          text-align: center;
          padding: 0 15px;
          background: none;
          border: none;
          border-right: 1px solid #ddd;
          flex-grow: 1;
        }

        .summary-item:last-child {
          border-right: none;
        }

        .summary-item .label {
          font-size: 8px;
          color: #666;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 2px;
        }

        .summary-item .value {
          font-size: 12px;
          font-weight: bold;
          color: #1F4E78;
        }

        .section-title {
          font-size: 10pt;
          color: #15803d;
          margin: 20px 0 10px 0;
          padding: 10px;
          font-weight: bold;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        table.tax-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
          font-size: 8pt;
        }

        .tax-table th {
          color: #15803d;
          padding: 10px 6px;
          text-align: left;
          font-weight: bold;
          font-size: 8pt;
          text-transform: uppercase;
          letter-spacing: 0.3px;
          border-bottom: 1px solid #0056A0;
          background-color: transparent;
        }

        .tax-table td {
          padding: 8px 6px;
          border: none;
          vertical-align: middle;
          border-bottom: 0.5px solid #e5e7eb;
        }

        .tax-table tr:hover {
          background-color: rgba(30, 64, 175, 0.05);
        }

        .amount {
          font-family: 'Courier New', monospace;
          font-weight: 600;
        }

        .text-center {
          text-align: center;
        }

        .mfp-section {
          background: #f9fafb;
          padding: 15px;
          border: 1px solid #d1d5db;
          border-radius: 5px;
          margin: 20px 0;
        }

        .highlight-value {
          color: #006100;
          font-weight: bold;
        }

        .print-footer {
          padding-top: 10px;
          border-top: 0.5px solid #1a1a1a;
          text-align: center;
          font-size: 8pt;
          color: #64748b;
          margin-top: 20px;
        }

        .print-footer p {
          margin: 3px 0;
        }

        @media print {
          body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
          }
          
          /* Faint logo overlay */
          body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('photos/logo.png');
            background-size: auto 100%;
            background-repeat: no-repeat;
            background-position: center center;
            opacity: 0.02;
            z-index: -1;
            pointer-events: none;
          }
        }
      </style>
    </head>
    <body>
      <div class="header-wrapper">
        <div class="header">
          <h1>DEFENCE INTELLIGENCE AGENCY</h1>
          <h2>ASOKORO - ABUJA - DEFENCE INTELIGENCE AGENCY</h2>
        </div>
      </div>

      <div class="header-info">
        <div class="left">
          <strong>TAX TABLE CONFIGURATION REPORT</strong>
        </div>
        <div class="center">
          <span>PRODUCED ON</span> 
          <strong>${dateStr}</strong> 
          <span>AT</span> 
          <strong>${timeStr}</strong>
        </div>
        <div class="right">
          <strong>${bandData.length}</strong>
          <span>TAX BANDS</span>
        </div>
      </div>

      <!-- Statistics Summary Box 
      <div class="summary-box">
        <div class="summary-item">
          <div class="label">Total Tax Bands</div>
          <div class="value">${bandData.length}</div>
        </div>
        <div class="summary-item">
          <div class="label">Min Free Pay</div>
          <div class="value highlight-value">₦${mfpData?.val?.toLocaleString('en-NG') || '0'}</div>
        </div>
        <div class="summary-item">
          <div class="label">MFP Percentage</div>
          <div class="value">${mfpData?.perc || 0}%</div>
        </div>
        <div class="summary-item">
          <div class="label">Generated By</div>
          <div class="value">${generatedBy}</div>
        </div>
      </div> -->

      <!-- Tax Bands Section -->
      <div class="section-title"></div>
      <table class="tax-table">
        <thead>
          <tr>
            <th style="width: 8%;" class="text-center">S/N</th>
            <th style="width: 20%;">Interval</th>
            <th style="width: 15%;" class="amount">Value (₦)</th>
            <th style="width: 12%;" class="text-center">Tax Rate (%)</th>
            <th style="width: 18%;" class="amount">Cumulative (₦)</th>
            <th style="width: 18%;" class="amount">Lower Bound (₦)</th>
          </tr>
        </thead>
        <tbody>
          ${bandData.map((item, index) => `
            <tr>
              <td class="text-center"><strong>${index + 1}</strong></td>
              <td><strong>${item.INTER}</strong></td>
              <td class="amount">${item.val?.toLocaleString('en-NG', {minimumFractionDigits: 2}) || '-'}</td>
              <td class="text-center"><strong>${item.perc}%</strong></td>
              <td class="amount">${item.cumval?.toLocaleString('en-NG', {minimumFractionDigits: 2}) || '-'}</td>
              <td class="amount">${item.lowbound?.toLocaleString('en-NG', {minimumFractionDigits: 2}) || '-'}</td>
            </tr>`).join("")}
        </tbody>
      </table>

      <!-- MFP Section -->
      <div class="mfp-section">
        <div class="section-title" style="margin-top: 0;">Minimum Free Pay Configuration</div>
        <table class="tax-table">
          <thead>
            <tr>
              <th style="width: 50%;">Description</th>
              <th style="width: 30%;" class="amount">Value (₦)</th>
              <th style="width: 20%;" class="text-center">Percentage (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Minimum Free Pay (MFP)</strong></td>
              <td class="amount highlight-value" style="font-size: 10pt;">₦${mfpData?.val?.toLocaleString('en-NG', {minimumFractionDigits: 2}) || '0.00'}</td>
              <td class="text-center"><strong>${mfpData?.perc || 0}%</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="print-footer">
        <p><strong>Total Tax Bands: ${bandData.length}</strong></p>
        <p>Generated by: ${generatedBy}</p>
        <p>All rights reserved &#xA9; Hicad Systems Limited.</p>
      </div>
    </body>
    </html>
  `;

  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.onload = () => printWindow.print();
}

// Add event listener to generate report button
document.getElementById('generateReportBtn').addEventListener('click', generateReport);

  // Init
  loadBands();
</script>



