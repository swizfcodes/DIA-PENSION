<!-- Payslip Section -->
<section class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <h2 class="text-xl text-center border-b font-bold text-green-600 mb-4">Generate and Print Payslips</h2>

  <form id="payslipForm" class="space-y-4">
    <!-- Radio selection -->
    <div>
      <label class="block font-medium mb-2">Select People</label>
      <div class="flex space-x-4">
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="people" value="all" checked>
          <span>All</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="people" value="specific">
          <span>Specific</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="people" value="individual">
          <span>Individual</span>
        </label>
      </div>
    </div>

    <!-- Service Number Inputs - Side by Side -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label for="startNo" class="block text-sm font-medium mb-1">Start Service No</label>
        <input type="text" id="startNo" name="startNo"
          class="w-full border rounded px-3 py-2 focus:ring focus:ring-green-300" disabled />
      </div>

      <div>
        <label for="endNo" class="block text-sm font-medium mb-1">End Service No</label>
        <input type="text" id="endNo" name="endNo"
          class="w-full border rounded px-3 py-2 focus:ring focus:ring-green-300" disabled />
      </div>
    </div>

    <!-- Payroll Class -->
    <div>
      <label for="payrollClass" class="block text-sm font-medium mb-1">Payroll Class</label>
      <select id="payrollClass" name="payrollClass"
        class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" disabled>
      </select>
    </div>

    <!-- Output Format -->
    <div>
      <label class="block font-medium mb-2">Output Format</label>
      <div class="flex space-x-4">
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="format" value="pdf" checked>
          <span>PDF</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="format" value="excel">
          <span>Excel</span>
        </label>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-2 justify-end pt-2">
      <button type="reset" id="clearBtn"
        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
        Clear
      </button>
      <button type="button" id="generateBtn"
        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Generate
      </button>
    </div>
  </form>
</section>


<!-- Loading Indicator -->
<div id="loadingIndicator" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-80 p-6 text-center">
    <div class="animate-spin h-10 w-10 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-4"></div>
  <span class="text-gray-700">Generating payslips...</span>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h3 class="text-lg font-semibold mb-4">Confirm Payslip Generation</h3>
    <p class="mb-6 text-gray-700">Do you want to continue and generate payslips?</p>

    <div class="flex justify-end space-x-2">
      <button id="cancelBtn"
        class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
        Cancel
      </button>
      <button id="continueBtn"
        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Continue
      </button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-blue-600 mb-4">Success</h3>
    <p class="mb-6 text-gray-700" id="successMessage">Payslips generated successfully!</p>
    <button id="successOkBtn"
      class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      OK
    </button>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Error</h3>
    <p class="mb-6 text-gray-700" id="errorMessage">Please fill in Start and End Service Numbers.</p>
    <button id="errorOkBtn"
      class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
      OK
    </button>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-50 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
    <div class="sticky top-0 bg-gray-50 border-b px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-semibold">Payslip Preview</h3>
      <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    
    <div id="previewContent" class="p-6 overflow-y-auto max-h-[70vh]">
      <!-- Payslip content will be inserted here -->
    </div>
    
    <div class="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex justify-end space-x-2">
      <button id="cancelPreviewBtn" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
        Cancel
      </button>
      <button id="downloadPreviewBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Download PDF
      </button>
    </div>
  </div>
</div>

<script>
  const peopleRadios = document.querySelectorAll('input[name="people"]');
  const startNo = document.getElementById("startNo");
  const endNo = document.getElementById("endNo");
  const generateBtn = document.getElementById("generateBtn");
  const clearBtn = document.getElementById("clearBtn");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const payrollClass = document.getElementById("payrollClass");

  const confirmModal = document.getElementById("confirmModal");
  const cancelBtn = document.getElementById("cancelBtn");
  const continueBtn = document.getElementById("continueBtn");

  const successModal = document.getElementById("successModal");
  const successOkBtn = document.getElementById("successOkBtn");
  const successMessage = document.getElementById("successMessage");

  const errorModal = document.getElementById("errorModal");
  const errorOkBtn = document.getElementById("errorOkBtn");
  const errorMessage = document.getElementById("errorMessage");

    // Load payroll classes
  async function loadPayrollClasses() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/payslips/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.locations) {
          payrollClass.innerHTML = '<option value="">All Locations</option>';
          result.data.locations.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.classcode;
            option.textContent = cls.classname || cls.classcode;
            payrollClass.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading locations:', error);
    }
  }

  async function fetchDatabaseName() {
    try {
    const token = localStorage.getItem("token");

    const res = await fetch("/payslips/database",{
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }                 
    });

    const data = await res.json();


    payrollClass.innerHTML = ""; // clear old options

    const option = document.createElement("option");
    option.value = data.database;
    option.textContent = data.class_name;
    option.selected = true;

    payrollClass.appendChild(option);
    } catch (err) {
    console.error("Failed to load payroll class:", err);
    }
  }

  function toggleInputs() {
    const selectedValue = document.querySelector('input[name="people"]:checked').value;
    
    if (selectedValue === 'all') {
      startNo.disabled = true;
      endNo.disabled = true;
      startNo.value = '';
      endNo.value = '';
    } else if (selectedValue === 'specific') {
      startNo.disabled = false;
      endNo.disabled = false;
    } else if (selectedValue === 'individual') {
      startNo.disabled = false;
      endNo.disabled = true;
      endNo.value = '';
    }
  }

  function updateFormatOptions() {
    const selectedPeople = document.querySelector('input[name="people"]:checked').value;
    const excelRadio = document.querySelector('input[name="format"][value="excel"]');
    const pdfRadio = document.querySelector('input[name="format"][value="pdf"]');
    
    if (selectedPeople === 'individual') {
      excelRadio.disabled = true;
      excelRadio.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
      pdfRadio.checked = true;
    } else {
      excelRadio.disabled = false;
      excelRadio.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }

  // radio change listener:
  peopleRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      toggleInputs();
      updateFormatOptions();
    });
  });

  generateBtn.addEventListener("click", () => {
    const selectedPeople = document.querySelector('input[name="people"]:checked').value;
    
    // Validation
    if (selectedPeople === 'specific' && (!startNo.value || !endNo.value)) {
      errorMessage.textContent = 'Please fill in both Start and End Service Numbers for range selection.';
      errorModal.classList.remove("hidden");
      return;
    }
    
    if (selectedPeople === 'individual' && !startNo.value) {
      errorMessage.textContent = 'Please enter a Service Number.';
      errorModal.classList.remove("hidden");
      return;
    }

    confirmModal.classList.remove("hidden");
  });

  cancelBtn.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
  });

  continueBtn.addEventListener("click", async () => {
    confirmModal.classList.add("hidden");
    loadingIndicator.classList.remove("hidden");
    generateBtn.disabled = true;

    const selectedPeople = document.querySelector('input[name="people"]:checked').value;
    const payrollClass = document.getElementById("payrollClass").value;
    const format = document.querySelector('input[name="format"]:checked').value;

    try {
      const token = localStorage.getItem('token');
      
      // Step 1: Build query parameters
      const params = new URLSearchParams();
      
      if (selectedPeople === 'all') {
        params.append('optall', '1');
        params.append('empno1', '');
        params.append('empno2', '');
      } else if (selectedPeople === 'specific') {
        params.append('optrange', '1');
        params.append('empno1', startNo.value);
        params.append('empno2', endNo.value);
      } else if (selectedPeople === 'individual') {
        params.append('optindividual', '1');
        params.append('empno1', startNo.value);
        params.append('empno2', '');
      }
      
      params.append('branch', payrollClass);
      params.append('wxdate', new Date().toISOString().split('T')[0]);
      
      // Step 2: Generate payslip data
      const dataResponse = await fetch(`/payslips/generate?${params.toString()}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!dataResponse.ok) {
        const errorData = await dataResponse.json();
        throw new Error(errorData.error || 'Failed to generate payslip data');
      }

      const result = await dataResponse.json();
      
      if (!result.success || !result.data || result.data.length === 0) {
        throw new Error('No payslip data generated. Please check your selection.');
      }

      loadingIndicator.classList.add("hidden");
      generateBtn.disabled = false;

      // Step 3: If individual, show preview modal
      if (selectedPeople === 'individual') {
        showPreviewModal(result.data[0], token);
      } else {
        // Step 4: Direct download for multiple
        await downloadPayslips(result.data, format, token);
        successMessage.textContent = `${result.data.length} payslip(s) generated successfully! Your ${format.toUpperCase()} is downloading.`;
        successModal.classList.remove("hidden");
      }

    } catch (error) {
      loadingIndicator.classList.add("hidden");
      generateBtn.disabled = false;
      errorMessage.textContent = error.message || 'Failed to generate payslips. Please try again.';
      errorModal.classList.remove("hidden");
      console.error('Error:', error);
    }
  });
    
  successOkBtn.addEventListener("click", () => {
    successModal.classList.add("hidden");
  });

  errorOkBtn.addEventListener("click", () => {
    errorModal.classList.add("hidden");
  });

  clearBtn.addEventListener("click", () => {
    document.querySelector('input[name="people"][value="all"]').checked = true;
    toggleInputs();
  });

  // Preview modal functions
  function showPreviewModal(payslipData, token) {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = generatePayslipHTML(payslipData);
    
    document.getElementById('previewModal').classList.remove('hidden');
    
    // Store data for download
    window.currentPayslipData = payslipData;
    window.currentToken = token;
  }

  function generatePayslipHTML(data) {
    const grossPayItems = data.earnings.filter(e => e.type === 'Taxable');
    const allowanceItems = data.earnings.filter(e => e.type === 'Non-Taxable');
    const grossTotal = grossPayItems.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    const allowanceTotal = allowanceItems.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    
    return `
      <div style="font-family: Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; background: #f8fbff; padding: 20px; border: 1px solid #e0e0e0;">
        <!-- Header -->
        <div style="text-align: center; border-bottom: 2px solid #1a1a1a; padding-bottom: 10px; margin-bottom: 15px; font-family: 'Libre Baskerville', Georgia, serif;">
          <h1 style="font-size: 18pt; font-weight: bold; margin: 0 0 5px 0; letter-spacing: 1.0px; color : #15803d;">DEFENCE INTELLIGENCE AGENCY</h1>
          <p style="font-size: 9pt; margin: 5px 0 0 0; color: #666;">ASOKORO - ABUJA - DEFENCE INTELIGENCE AGENCY</p>
        </div>

        <!-- Pay Period -->
        <div style="display: flex; justify-content: space-between; background: #fafafa; padding: 8px; margin-bottom: 10px; font-size: 8pt;">
          <span><strong>Pay Period:</strong> ${data.payroll_month} ${data.payroll_year}</span>
          <span><strong>Pay Date:</strong> ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
        </div>

        <!-- Personnel Info -->
        <div style="background: #2c5aa0; color: white; padding: 5px 8px; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">PERSONNEL INFORMATION</div>
        <div style="background: #fafafa; border: 1px solid #d0d0d0; padding: 10px; margin-bottom: 10px; font-size: 8pt;">
          <div style="display: flex; margin-bottom: 5px; border-bottom: 1px solid #f0f0f0; padding: 3px 0;">
            <span style="font-weight: 600; min-width: 120px;">Name:</span>
            <span>${data.title} ${data.surname} ${data.othername}</span>
          </div>
          <div style="display: flex; margin-bottom: 5px; border-bottom: 1px solid #f0f0f0; padding: 3px 0;">
            <span style="font-weight: 600; min-width: 120px;">Service No.:</span>
            <span>${data.employee_id}</span>
          </div>
          <div style="display: flex; margin-bottom: 5px; border-bottom: 1px solid #f0f0f0; padding: 3px 0;">
            <span style="font-weight: 600; min-width: 120px;">Grade:</span>
            <span>${data.gradelevel}${data.gradetype ? ' - ' + data.gradetype : ''}</span>
          </div>
          <div style="display: flex; margin-bottom: 5px; border-bottom: 1px solid #f0f0f0; padding: 3px 0;">
            <span style="font-weight: 600; min-width: 120px;">Department:</span>
            <span>${data.department}</span>
          </div>
          <div style="display: flex; padding: 3px 0;">
            <span style="font-weight: 600; min-width: 120px;">Bank Account:</span>
            <span>${data.bank_account_number}${data.bank_name ? ' (' + data.bank_name + ')' : ''}</span>
          </div>
        </div>

        <!-- Gross Pay -->
        <div style="background: #2c5aa0; color: white; padding: 5px 8px; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">GROSS PAY (TAXABLE)</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 8pt;">
          ${grossPayItems.map(item => `
            <tr style="border-bottom: 1px solid #f0f0f0;">
              <td style="padding: 5px;">${item.description}</td>
              <td style="padding: 5px; text-align: right; font-family: 'Courier New', monospace; font-weight: 700;">NGN ${parseFloat(item.amount).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>
          `).join('')}
        </table>
        <div style="background: #f5f5f5; border-top: 1px solid #d0d0d0; padding: 6px 8px; margin: 8px 0; display: flex; justify-content: space-between; font-size: 9pt; font-weight: 600;">
          <span>TOTAL</span>
          <span style="font-family: 'Courier New', monospace;">NGN ${grossTotal.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>

        <!-- Deductions -->
        <div style="background: #2c5aa0; color: white; padding: 5px 8px; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">DEDUCTIONS</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 8pt;">
          ${data.deductions.map(item => `
            <tr style="border-bottom: 1px solid #f0f0f0;">
              <td style="padding: 5px;">
                ${item.description}
                ${item.is_loan && item.loan_balance ? `<span style="color: #d32f2f; font-size: 7pt; font-weight: 600;"> (Bal: NGN ${parseFloat(item.loan_balance).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})})</span>` : ''}
              </td>
              <td style="padding: 5px; text-align: right; font-family: 'Courier New', monospace; font-weight: 700;">NGN ${parseFloat(item.amount).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>
          `).join('')}
        </table>
        <div style="background: #f5f5f5; border-top: 1px solid #d0d0d0; padding: 6px 8px; margin: 8px 0; display: flex; justify-content: space-between; font-size: 9pt; font-weight: 600;">
          <span>TOTAL DEDUCTIONS</span>
          <span style="font-family: 'Courier New', monospace;">NGN ${data.total_deductions.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>

        <!-- Allowances -->
        <div style="background: #2c5aa0; color: white; padding: 5px 8px; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">ALLOWANCES (NON-TAXABLE)</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 8pt;">
          ${allowanceItems.map(item => `
            <tr style="border-bottom: 1px solid #f0f0f0;">
              <td style="padding: 5px;">${item.description}</td>
              <td style="padding: 5px; text-align: right; font-family: 'Courier New', monospace; font-weight: 700;">NGN ${parseFloat(item.amount).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>
          `).join('')}
        </table>
        <div style="background: #f5f5f5; border-top: 1px solid #d0d0d0; padding: 6px 8px; margin: 8px 0; display: flex; justify-content: space-between; font-size: 9pt; font-weight: 600;">
          <span>TOTAL</span>
          <span style="font-family: 'Courier New', monospace;">NGN ${allowanceTotal.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>

        <!-- Net Pay -->
        <div style="background: #f0f0f0; border: 2px solid #1a1a1a; padding: 8px; margin: 12px 0; display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold;">
          <span>NET PAY</span>
          <span style="font-family: 'Courier New', monospace;">NGN ${data.net_pay.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>

        <!-- YTD -->
        <div style="border: 1px solid #d0d0d0; padding: 10px; margin-top: 10px; background: #fafafa; font-size: 8pt;">
          <div style="font-weight: 600; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid #d0d0d0;">YEAR-TO-DATE TOTALS (JAN - ${data.payroll_month} ${data.payroll_year})</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px; padding: 4px;">
            <span style="font-weight: 600;">YTD Gross:</span>
            <span style="font-family: 'Courier New', monospace; font-weight: 700;">NGN ${data.ytd_gross.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px; padding: 4px;">
            <span style="font-weight: 600;">YTD Tax:</span>
            <span style="font-family: 'Courier New', monospace; font-weight: 700;">NGN ${data.ytd_tax.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 4px;">
            <span style="font-weight: 600;">YTD Net:</span>
            <span style="font-family: 'Courier New', monospace; font-weight: 700;">NGN ${(data.ytd_gross - data.ytd_tax).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
          </div>
        </div>

        <!-- Footer -->
        <div style="margin-top: 15px; padding-top: 8px; border-top: 2px solid #d0d0d0; text-align: center; font-size: 7pt; color: #666;">
          <p style="margin: 4px 0; font-weight: 600;">This is a computer-generated document. No signature required.</p>
          <p style="margin: 4px 0;">For queries, contact the Human Resources Department</p>
        </div>
      </div>
    `;
  }

  async function downloadPayslips(data, format, token) {
    const exportEndpoint = format === 'pdf' ? '/payslips/export/pdf' : '/payslips/export/excel';
    
    const exportResponse = await fetch(exportEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ data: data })
    });

    if (!exportResponse.ok) {
      throw new Error('Failed to generate file');
    }

    const blob = await exportResponse.blob();
    const url = window.URL.createObjectURL(blob);

    // Open PDF in new tab
    if (format === 'pdf') {
      window.open(url, '_blank');
    }

    const a = document.createElement('a');
    a.href = url;
    a.download = `payslips_${new Date().getTime()}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => window.URL.revokeObjectURL(url), 100);
  }

  // Preview modal event listeners
  document.getElementById('closePreviewBtn').addEventListener('click', () => {
    document.getElementById('previewModal').classList.add('hidden');
  });

  document.getElementById('cancelPreviewBtn').addEventListener('click', () => {
    document.getElementById('previewModal').classList.add('hidden');
  });

  document.getElementById('downloadPreviewBtn').addEventListener('click', async () => {
    try {
      await downloadPayslips([window.currentPayslipData], 'pdf', window.currentToken);
      document.getElementById('previewModal').classList.add('hidden');
      successMessage.textContent = 'Payslip downloaded successfully!';
      successModal.classList.remove('hidden');
    } catch (error) {
      errorMessage.textContent = 'Failed to download payslip. Please try again.';
      errorModal.classList.remove('hidden');
    }
  });

  toggleInputs();
  updateFormatOptions();
  loadPayrollClasses();
  fetchDatabaseName();
</script>



