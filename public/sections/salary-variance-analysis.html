<section class="items border rounded-lg m-6 max-w-2xl mr-auto p-6 mx-auto">
  <h2 class="text-2xl text-center border-b font-bold text-green-600 mb-6">Salary Variance Analysis</h2>

  <!-- Step 1: Select Payment Types -->
  <div id="paymentTypeSection" class="space-y-4 mb-6">
    <label class="block font-medium text-gray-900">
      <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>Select Payment Type(s)
    </label>
    <select id="paymentTypeSelect" class="w-full bg-transparent border border-slate-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500">
      <option value="">-- Choose Payment Type --</option>
    </select>

    <!-- Action Buttons -->
    <div class="flex gap-3">
      <button id="addPaymentType" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors shadow-md">
        <i class="fas fa-plus mr-2"></i>Add Type
      </button>
      <button id="generatePaymentTypes" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors shadow-md">
        <i class="fas fa-arrow-right mr-2"></i>Continue
      </button>
    </div>
  </div>

  <!-- Step 2: Tabular List of Added Payment Types -->
  <div id="addedPaymentsWrapper" class="hidden mb-6">
    <h3 class="font-semibold text-gray-800 mb-2">Selected Payment Types:</h3>
    <div class="border rounded-lg overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-green-100">
          <tr>
            <th class="px-4 py-2 text-left border-b">Code</th>
            <th class="px-4 py-2 text-left border-b">Description</th>
            <th class="px-4 py-2 text-center border-b">Actions</th>
          </tr>
        </thead>
        <tbody id="addedPaymentsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Step 3: Period Selection Form -->
  <div id="periodForm" class="hidden space-y-4 border-t border-slate-300 pt-6">
    <h3 class="font-semibold text-gray-800 mb-3">
      <i class="fas fa-calendar text-green-600 mr-2"></i>Select Analysis Period
    </h3>

    <div class="border border-green-400 p-4 rounded-lg">
      <label class="block text-sm font-medium text-gray-900 mb-2">Period (YYYYMM)</label>
      <select id="periodSelect" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
        <option value="">-- Select Period --</option>
      </select>
      <p class="text-xs text-gray-600 mt-1">
        <i class="fas fa-info-circle mr-1"></i>
        Current period will compare with last year. Previous periods compare with prior month.
      </p>
    </div>

    <!-- Export Format -->
    <div class="border border-gray-500 p-4 rounded-lg">
      <label class="block text-sm font-medium text-gray-900 mb-2">
        <i class="fas fa-file-export text-gray-600 mr-2"></i>Export Format
      </label>
      <div class="flex gap-4">
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="excel" class="text-green-600 w-4 h-4" checked>
          <span class="ml-2">Excel</span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="pdf" class="text-green-600 w-4 h-4">
          <span class="ml-2">PDF</span>
        </label>
        <label class="hidden flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="json" class="text-green-600 w-4 h-4">
          <span class="ml-2">JSON</span>
        </label>
      </div>
    </div>

    <div class="flex justify-end gap-3 pt-2">
      <button id="cancelReport" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-6 rounded-lg transition-colors">
        <i class="fas fa-times mr-2"></i>Cancel
      </button>
      <button id="proceedReport" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg transition-colors shadow-lg">
        <i class="fas fa-chart-line mr-2"></i>Generate Report
      </button>
    </div>
  </div>
</section>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-8 text-center">
    <div class="mb-4">
      <i class="fas fa-spinner fa-spin text-4xl text-green-600"></i>
    </div>
    <h3 class="text-lg font-semibold mb-2">Generating Report...</h3>
    <p class="text-gray-600">Please wait while we analyze salary variances.</p>
  </div>
</div>

<!-- Message Modal -->
<div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex items-start mb-4">
      <div id="modalIcon" class="mr-3 text-2xl"></div>
      <div class="flex-1">
        <h3 id="modalTitle" class="text-lg font-semibold mb-2"></h3>
        <p id="modalMessage" class="text-gray-700"></p>
      </div>
    </div>
    <div class="flex justify-end">
      <button id="modalCloseBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
  </div>
</div>

<script>
  const paymentTypeSelect = document.getElementById("paymentTypeSelect");
  const addPaymentTypeBtn = document.getElementById("addPaymentType");
  const generatePaymentTypesBtn = document.getElementById("generatePaymentTypes");
  const addedPaymentsWrapper = document.getElementById("addedPaymentsWrapper");
  const addedPaymentsTable = document.getElementById("addedPaymentsTable");
  const periodForm = document.getElementById("periodForm");
  const periodSelect = document.getElementById("periodSelect");
  const proceedReportBtn = document.getElementById("proceedReport");
  const cancelReportBtn = document.getElementById("cancelReport");

  const messageModal = document.getElementById("messageModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalMessage = document.getElementById("modalMessage");
  const modalIcon = document.getElementById("modalIcon");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const loadingModal = document.getElementById("loadingModal");

  let addedPayments = [];
  let filterOptions = null;

  // Load filter options on page load
  async function loadFilterOptions() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/salaryvariance/filter-options', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await response.json();
      
      console.log('Full API Response:', result);
      
      if (result.success) {
        filterOptions = result.data;
        
        // Populate pay types (if they exist)
        if (filterOptions.payTypes && filterOptions.payTypes.length > 0) {
          filterOptions.payTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.code;
            option.textContent = `${type.code} - ${type.description}`;
            paymentTypeSelect.appendChild(option);
          });
        } else {
          console.warn('No payTypes in response');
        }
        
        // Populate periods
        if (filterOptions.periods && filterOptions.periods.length > 0) {
          filterOptions.periods.forEach(period => {
            const option = document.createElement('option');
            option.value = period.value;
            option.textContent = period.label;
            periodSelect.appendChild(option);

            console.log('Added period option:', period.value, period.label);
          });
          
          // Set default to current period
          if (filterOptions.currentPeriod) {
            const currentPeriod = `${filterOptions.currentPeriod.year}${String(filterOptions.currentPeriod.month).padStart(2, '0')}`;
            periodSelect.value = currentPeriod;
            console.log('Set default period to:', currentPeriod);
          }
        } else {
          console.error('No periods found in response!');
        }
      }
    } catch (error) {
      console.error('Error loading filter options:', error);
      showModal('Error', 'Failed to load filter options. Please refresh the page.', true);
    }
  }

  // Format period YYYYMM to readable string
  function formatPeriod(period) {
    if (!period || period.length !== 6) return period;
    const year = period.substring(0, 4);
    const month = period.substring(4, 6);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthName = months[parseInt(month) - 1] || month;
    return `${monthName} ${year}`;
  }

  // Show modal
  function showModal(title, message, isError = false) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalIcon.innerHTML = isError 
      ? '<i class="fas fa-exclamation-circle text-red-500"></i>'
      : '<i class="fas fa-check-circle text-blue-500"></i>';
    messageModal.classList.remove("hidden");
  }

  modalCloseBtn.onclick = () => messageModal.classList.add("hidden");

  // Add Payment Type
  addPaymentTypeBtn.onclick = () => {
    const paymentType = paymentTypeSelect.value;
    const paymentText = paymentTypeSelect.options[paymentTypeSelect.selectedIndex].text;
    
    if (!paymentType) return showModal("Validation Error", "Please select a payment type to add!", true);
    if (addedPayments.some(p => p.code === paymentType)) {
      return showModal("Duplicate Entry", "This payment type has already been added!", true);
    }

    addedPayments.push({ code: paymentType, description: paymentText });
    showModal("Success", `${paymentType} added successfully!`);
    paymentTypeSelect.value = "";
    
    // Update table display if visible
    if (!addedPaymentsWrapper.classList.contains('hidden')) {
      updatePaymentTypesTable();
    }
  };

  // Update payment types table
  function updatePaymentTypesTable() {
    addedPaymentsTable.innerHTML = "";
    addedPayments.forEach(pt => {
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50";
      row.innerHTML = `
        <td class="px-4 py-2 border-b">${pt.code}</td>
        <td class="px-4 py-2 border-b">${pt.description}</td>
        <td class="px-4 py-2 border-b text-center">
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs deleteBtn">
            <i class="fas fa-trash mr-1"></i>Remove
          </button>
        </td>`;
      addedPaymentsTable.appendChild(row);

      // Delete functionality
      row.querySelector(".deleteBtn").onclick = () => {
        addedPayments = addedPayments.filter(p => p.code !== pt.code);
        row.remove();
        if (addedPayments.length === 0) {
          addedPaymentsWrapper.classList.add("hidden");
          periodForm.classList.add("hidden");
        }
      };
    });
  }

  // Generate table of added payment types
  generatePaymentTypesBtn.onclick = () => {
    if (addedPayments.length === 0) {
      return showModal("Validation Error", "Please add at least one payment type before continuing!", true);
    }

    addedPaymentsWrapper.classList.remove("hidden");
    periodForm.classList.remove("hidden");
    updatePaymentTypesTable();
  };

  // Proceed to generate report
  proceedReportBtn.onclick = async () => {
    const period = periodSelect.value;
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';

    if (!period) {
      return showModal("Validation Error", "Please select a period!", true);
    }

    // Build query parameters
    const payTypesParam = addedPayments.map(p => p.code).join(',');
    const queryParams = `period=${period}&payTypes=${payTypesParam}&format=${exportFormat}`;

    // Show loading
    loadingModal.classList.remove("hidden");

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/salaryvariance?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || errorData.error || 'Failed to generate report');
      }

      if (exportFormat === 'json') {
        const result = await response.json();
        loadingModal.classList.add("hidden");
        
        if (result.success) {
          if (result.data.length === 0) {
            showModal("No Variance Found", result.message || "No salary variances detected for the selected criteria.");
          } else {
            showModal("Success", `Report generated! Found ${result.data.length} employee(s) with variance.`);
            console.log('Variance Report Data:', result);
          }
        } else {
          showModal("Report Error", result.message || "Failed to generate report", true);
        }
      } else {
        // Handle file download for Excel/PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `salary_variance_${period}.${exportFormat === 'excel' ? 'xlsx' : 'pdf'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        loadingModal.classList.add("hidden");
        showModal("Success", `Salary Variance Report downloaded successfully!`);
      }
    } catch (error) {
      loadingModal.classList.add("hidden");
      console.error('Error generating report:', error);
      showModal("Error", `Failed to generate report: ${error.message}`, true);
    }
  };

  // Cancel
  cancelReportBtn.onclick = () => {
    addedPayments = [];
    addedPaymentsWrapper.classList.add("hidden");
    periodForm.classList.add("hidden");
    addedPaymentsTable.innerHTML = "";
    paymentTypeSelect.value = "";
  };

  // Initialize
  loadFilterOptions();
</script>



