<section class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">

  <!-- Report Title -->
  <div class="hidden mb-6 text-center">
    <h2 class="text-2xl font-bold text-red-700">Duplicate Account Numbers</h2>
    <p class="text-sm text-gray-600 mt-1">Detect and manage duplicate bank account numbers</p>
  </div>

  <!-- Radio Selection -->
  <div class="mb-2 border-b border-red-500 p-4 rounded-lg">
    <span class="text-red-600 font-semibold text-lg block mb-3">Select Report Scope:</span>
    <div class="flex gap-6">
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="dupScope" value="all" class="text-red-600 w-4 h-4" checked>
        <span class="ml-2 font-medium">All Banks</span>
      </label>

      <label class="flex items-center cursor-pointer">
        <input type="radio" name="dupScope" value="specific" class="text-red-600 w-4 h-4">
        <span class="ml-2 font-medium">Specific Bank</span>
      </label>
    </div>
  </div>

  <!-- Dynamic Form Fields -->
  <div id="dupForm" class="space-y-2">

    <!-- Bank Select (Hidden by default) -->
    <div id="bankSelectWrapper" class="hidden border-b border-green-500 p-4 rounded-lg">
      <label class="block text-sm font-medium text-gray-900 mb-2">
        <i class="fas fa-university text-green-600 mr-2"></i>Select Bank
      </label>
      <select id="bankSelect" class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-green-300">
        <!--<option value="">-- Choose Bank --</option>-->
      </select>
    </div>

    <!-- Include Inactive Toggle -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <label class="flex items-center cursor-pointer">
        <input type="checkbox" id="includeInactive" class="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500">
        <span class="ml-2 text-sm font-medium text-gray-900">
          <i class="fas fa-user-slash text-gray-600 mr-2"></i>Include Inactive/Separated Employees
        </span>
      </label>
      <p class="text-xs text-gray-500 mt-1 ml-6">Check this to include employees who have left the service</p>
    </div>

    <!-- Export Format Selection -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <label class="block text-sm font-medium text-gray-900 mb-2">
        <i class="fas fa-file-export text-gray-600 mr-2"></i>Export Format
      </label>
      <div class="flex gap-4">
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="pdf" class="text-green-600 w-4 h-4" checked>
          <span class="ml-2">PDF</span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="excel" class="text-green-600 w-4 h-4">
          <span class="ml-2">Excel (.xlsx)</span>
        </label>
        <label class="hidden flex items-center cursor-pointer">
          <input type="radio" name="exportFormat" value="json" class="text-green-600 w-4 h-4">
          <span class="ml-2">JSON</span>
        </label>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end gap-3 pt-4 border-t">
      <button id="cancelDup" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg transition-colors">
        <i class="fas fa-times mr-2"></i>Clear
      </button>

      <button id="generateDup" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition-colors shadow-lg hover:shadow-xl">
        <i class="fas fa-search mr-2"></i>Scan for Duplicates
      </button>
    </div>
  </div>
</section>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-8 text-center">
    <div class="mb-4">
      <i class="fas fa-spinner fa-spin text-4xl text-red-600"></i>
    </div>
    <h3 class="text-lg font-semibold mb-2">Scanning for Duplicates...</h3>
    <p class="text-gray-600">Please wait while we analyze account numbers.</p>
  </div>
</div>

<!-- Reusable Modal -->
<div id="dupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex items-start mb-4">
      <div id="dupModalIcon" class="mr-3 text-2xl"></div>
      <div class="flex-1">
        <h3 id="dupModalTitle" class="text-lg font-semibold mb-2"></h3>
        <p id="dupModalMessage" class="text-gray-700"></p>
      </div>
    </div>
    <div class="flex justify-end">
      <button id="dupModalCloseBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
  </div>
</div>

<script>
  const dupRadios = document.querySelectorAll('input[name="dupScope"]');
  const bankSelectWrapper = document.getElementById("bankSelectWrapper");
  const bankSelect = document.getElementById("bankSelect");
  const includeInactiveCheckbox = document.getElementById("includeInactive");
  
  const generateDupBtn = document.getElementById("generateDup");
  const cancelDupBtn = document.getElementById("cancelDup");

  const dupModal = document.getElementById("dupModal");
  const dupModalTitle = document.getElementById("dupModalTitle");
  const dupModalMessage = document.getElementById("dupModalMessage");
  const dupModalIcon = document.getElementById("dupModalIcon");
  const dupModalCloseBtn = document.getElementById("dupModalCloseBtn");
  const loadingModal = document.getElementById("loadingModal");

  let filterOptions = null;

  // Load filter options on page load
  async function loadFilterOptions() {
    try {
      const token = localStorage.getItem('token') || '';
      const response = await fetch('/duplicate/filter-options', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await response.json();
      
      if (result.success) {
        filterOptions = result.data;
        
        // Populate banks
        if (filterOptions.banks && filterOptions.banks.length > 0) {
          filterOptions.banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.code;
            option.textContent = `${bank.code} - ${bank.description}`;
            bankSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading filter options:', error);
      showDupModal('Error', 'Failed to load filter options. Please refresh the page.', true);
    }
  }

  // Show modal
  function showDupModal(title, message, isError = false) {
    dupModalTitle.textContent = title;
    dupModalMessage.textContent = message;
    dupModalIcon.innerHTML = isError 
      ? '<i class="fas fa-exclamation-circle text-red-500"></i>'
      : '<i class="fas fa-check-circle text-blue-500"></i>';
    dupModal.classList.remove("hidden");
  }

  dupModalCloseBtn.onclick = () => dupModal.classList.add("hidden");

  // Radio change event
  dupRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      bankSelectWrapper.classList.add("hidden");

      if (radio.value === "specific") {
        bankSelectWrapper.classList.remove("hidden");
      }
    });
  });

  // Generate button
  generateDupBtn.onclick = async () => {
    const selectedScope = document.querySelector('input[name="dupScope"]:checked')?.value;
    const includeInactive = includeInactiveCheckbox.checked;
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';

    // Validation
    if (!selectedScope) {
      return showDupModal("Validation Error", "Please select a report scope!", true);
    }

    // Build query parameters
    let queryParams = `includeInactive=${includeInactive}&format=${exportFormat}`;

    // Add bank filter if selected
    if (selectedScope === "specific") {
      const bankCode = bankSelect.value;
      if (!bankCode) {
        return showDupModal("Validation Error", "Please select a bank!", true);
      }
      queryParams += `&bankCode=${bankCode}`;
    }

    // Show loading modal
    loadingModal.classList.remove("hidden");

    try {
      const token = localStorage.getItem('token') || '';
      const response = await fetch(`/duplicate?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
      }

      if (exportFormat === 'json') {
        const result = await response.json();
        loadingModal.classList.add("hidden");
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            showDupModal(
              "Duplicates Found!", 
              `Found ${result.statistics.total_duplicate_accounts} duplicate account numbers affecting ${result.statistics.total_affected_employees} employees.`,
              true
            );
            console.log('Report data:', result);
          } else {
            showDupModal(
              "No Duplicates Found", 
              result.message || "All account numbers are unique!"
            );
          }
        } else {
          showDupModal("Error", result.error || "Failed to generate report", true);
        }
      } else {
        // Handle file download for Excel/PDF
        const blob = await response.blob();
        
        // Check if response is actually JSON (error response)
        if (blob.type === 'application/json') {
          const text = await blob.text();
          const errorData = JSON.parse(text);
          throw new Error(errorData.error || 'Failed to generate report');
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `duplicate_accounts_${new Date().toISOString().split('T')[0]}.${exportFormat === 'excel' ? 'xlsx' : 'pdf'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        loadingModal.classList.add("hidden");
        showDupModal(
          "Report Downloaded", 
          `Duplicate account report has been downloaded successfully!`
        );
      }
    } catch (error) {
      loadingModal.classList.add("hidden");
      console.error('Error generating report:', error);
      showDupModal("Error", error.message || 'Failed to generate report', true);
    }
  };

  // Cancel/Clear button
  cancelDupBtn.onclick = () => {
    // Hide bank wrapper
    bankSelectWrapper.classList.add("hidden");

    // Reset all form fields
    document.getElementById("bankSelect").value = "";
    document.getElementById("includeInactive").checked = false;
    
    // Reset radio to "all"
    document.querySelector('input[name="dupScope"][value="all"]').checked = true;
    
    // Reset export format to PDF
    document.querySelector('input[name="exportFormat"][value="pdf"]').checked = true;
  };

  // Initialize
  loadFilterOptions();
</script>



