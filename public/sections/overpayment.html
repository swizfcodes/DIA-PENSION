<section class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <h2 class="text-2xl text-center border-b font-bold text-red-600 mb-6">
    <i class="fas fa-exclamation-triangle mr-2"></i>Overpayment Analysis
  </h2>

  <!-- Alert Info Box -->
  <div class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-info-circle text-red-500"></i>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">About This Report</h3>
        <p class="text-xs text-red-700 mt-1">
          This report identifies employees with net pay increases exceeding the configured threshold 
          by comparing current month against previous month.
        </p>
      </div>
    </div>
  </div>

  <!-- Period Selection -->
  <div class="mb-6 border-b border-gray-500 p-4">
    <label class="block font-medium text-gray-900 mb-2">
      <i class="fas fa-calendar-alt text-green-600 mr-2"></i>Select Analysis Period
    </label>
    <select id="periodSelect" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500">
      <option value="">-- Select Month--</option>
      <option value="1">January</option>
      <option value="2">February</option>
      <option value="3">March</option>
      <option value="4">April</option>
      <option value="5">May</option>
      <option value="6">June</option>
      <option value="7">July</option>
      <option value="8">August</option>
      <option value="9">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>
  </div>

  <!-- Threshold Display -->
  <div id="thresholdDisplay" class="hidden mb-6 bg-yellow-50 border border-yellow-300 p-4 rounded-lg">
    <div class="flex items-center">
      <i class="fas fa-percentage text-yellow-600 text-xl mr-3"></i>
      <div>
        <p class="text-sm font-semibold text-gray-800">Configured Threshold</p>
        <p class="text-xs text-gray-600">Employees exceeding <span id="thresholdValue" class="font-bold text-red-600">--</span> variance will be flagged</p>
      </div>
    </div>
  </div>

  <!-- Export Format -->
  <div class="mb-6 p-4 rounded-lg">
    <label class="block font-medium text-gray-900 mb-2">
      <i class="fas fa-file-export text-gray-600 mr-2"></i>Export Format
    </label>
    <div class="flex gap-4">
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="exportFormat" value="excel" class="text-red-600 w-4 h-4" checked>
        <span class="ml-2">Excel</span>
      </label>
      <label class="flex items-center cursor-pointer">
        <input type="radio" name="exportFormat" value="pdf" class="text-red-600 w-4 h-4">
        <span class="ml-2">PDF</span>
      </label>
      <label class="hidden flex items-center cursor-pointer">
        <input type="radio" name="exportFormat" value="json" class="text-red-600 w-4 h-4">
        <span class="ml-2">JSON</span>
      </label>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex justify-end gap-3 pt-4 border-t">
    <button id="cancelOverpay" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-6 rounded-lg transition-colors">
      <i class="fas fa-times mr-2"></i>Clear
    </button>
    <button id="generateOverpay" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg transition-colors shadow-lg">
      <i class="fas fa-search mr-2"></i>Analyze
    </button>
  </div>
</section>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-8 text-center">
    <div class="mb-4">
      <i class="fas fa-spinner fa-spin text-4xl text-red-600"></i>
    </div>
    <h3 class="text-lg font-semibold mb-2">Analyzing Overpayments...</h3>
    <p class="text-gray-600">Please wait while we check for payment anomalies.</p>
  </div>
</div>

<!-- Message Modal -->
<div id="overpayModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex items-start mb-4">
      <div id="modalIcon" class="mr-3 text-2xl"></div>
      <div class="flex-1">
        <h3 id="overpayModalTitle" class="text-lg font-semibold mb-2"></h3>
        <p id="overpayModalMessage" class="text-gray-700"></p>
      </div>
    </div>
    <div class="flex justify-end">
      <button id="overpayModalCloseBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
  </div>
</div>

<script>
  const periodSelect = document.getElementById("periodSelect");
  const thresholdDisplay = document.getElementById("thresholdDisplay");
  const thresholdValue = document.getElementById("thresholdValue");
  const generateBtn = document.getElementById("generateOverpay");
  const cancelBtn = document.getElementById("cancelOverpay");

  const modal = document.getElementById("overpayModal");
  const modalTitle = document.getElementById("overpayModalTitle");
  const modalMessage = document.getElementById("overpayModalMessage");
  const modalIcon = document.getElementById("modalIcon");
  const modalCloseBtn = document.getElementById("overpayModalCloseBtn");
  const loadingModal = document.getElementById("loadingModal");

  let filterOptions = null;

  // Load filter options on page load
  /*async function loadFilterOptions() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/overpayment/filter-options', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await response.json();
      
      if (result.success) {
        filterOptions = result.data;
        
        // Populate periods
        if (filterOptions.periods && filterOptions.periods.length > 0) {
          filterOptions.periods.forEach(period => {
            const option = document.createElement('option');
            option.value = period.period;
            option.textContent = formatPeriod(period.period);
            periodSelect.appendChild(option);
          });
          
          // Set default to current period
          if (filterOptions.currentPeriod) {
            const currentPeriod = `${filterOptions.currentPeriod.year}${String(filterOptions.currentPeriod.month).padStart(2, '0')}`;
            periodSelect.value = currentPeriod;
          }
        }
        
        // Note: Threshold will be loaded when we fetch BT04 config
        // For now, we can show a placeholder
        //showThresholdInfo();
      }
    } catch (error) {
      console.error('Error loading filter options:', error);
      showModal('Error', 'Failed to load filter options. Please refresh the page.', true);
    }
  }*/

  // Format period YYYYMM to readable string
  function formatPeriod(period) {
    if (!period || period.length !== 6) return period;
    const year = period.substring(0, 4);
    const month = period.substring(4, 6);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthName = months[parseInt(month) - 1] || month;
    return `${monthName} ${year}`;
  }

  // Show modal
  function showModal(title, message, isError = false) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalIcon.innerHTML = isError 
      ? '<i class="fas fa-exclamation-circle text-red-500"></i>'
      : '<i class="fas fa-check-circle text-blue-500"></i>';
    modal.classList.remove("hidden");
  }

  modalCloseBtn.onclick = () => modal.classList.add("hidden");

  // Generate button
  generateBtn.onclick = async () => {
    const period = periodSelect.value;
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';

    if (!period) {
      return showModal("Validation Error", "Please select a period for analysis!", true);
    }

    // Build query parameters
    const queryParams = `period=${period}&format=${exportFormat}`;

    // Show loading
    loadingModal.classList.remove("hidden");

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/overpayment/get?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || errorData.error || 'Failed to generate report');
      }

      if (exportFormat === 'json') {
        const result = await response.json();
        loadingModal.classList.add("hidden");
        
        if (result.success) {
          // Update threshold display
          if (result.threshold_percentage) {
            thresholdValue.textContent = `${result.threshold_percentage}%`;
          }
          
          if (result.data.length === 0) {
            showModal(
              "No Overpayments Detected", 
              result.message || `No employees exceeded the ${result.threshold_percentage}% threshold.`
            );
          } else {
            showModal(
              "Overpayments Found!", 
              `⚠️ ${result.data.length} employee(s) flagged with overpayment exceeding ${result.threshold_percentage}% threshold.`
            );
            console.log('Overpayment Report Data:', result);
          }
        } else {
          showModal("Report Error", result.message || "Failed to generate report", true);
        }
      } else {
        // Handle file download for Excel/PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `overpayment_analysis_${period}.${exportFormat === 'excel' ? 'xlsx' : 'pdf'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        loadingModal.classList.add("hidden");
        showModal("Success", `Overpayment Analysis Report downloaded successfully!`);
      }
    } catch (error) {
      loadingModal.classList.add("hidden");
      console.error('Error generating report:', error);
      showModal("Error", `Failed to generate report: ${error.message}`, true);
    }
  };

  // Cancel button
  cancelBtn.onclick = () => {
    periodSelect.value = "";
    document.querySelector('input[name="exportFormat"][value="excel"]').checked = true;
    
    // Reset to default period if available
    if (filterOptions && filterOptions.currentPeriod) {
      const currentPeriod = `${filterOptions.currentPeriod.year}${String(filterOptions.currentPeriod.month).padStart(2, '0')}`;
      periodSelect.value = currentPeriod;
    }
  };

  // Initialize
  //loadFilterOptions();
</script>



