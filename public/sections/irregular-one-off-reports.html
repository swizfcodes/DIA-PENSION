<!-- One-Off Payments Report Section -->
<div class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-3">
    <h3 class="text-lg font-bold text-green-700 flex items-center gap-2">
      Select an option and Print One-Off Payments Report
    </h3>
  </div>

  <form id="oneoffReportForm" class="space-y-4">
    <!-- Radio + Checkboxes Grid -->
    <div class="grid grid-cols-2 gap-3">
      <label class="flex items-center space-x-2">
        <input type="radio" name="reportType" value="bank" class="text-green-600" checked>
        <span class="text-gray-700">Bank Report</span>
      </label>
      <label class="flex items-center space-x-2">
        <input type="checkbox" id="chkAllClasses" class="text-green-600">
        <span class="text-gray-700">All Classes</span>
      </label>

      <label class="flex items-center space-x-2">
        <input type="radio" name="reportType" value="analysis" class="text-green-600">
        <span class="text-gray-700">Payment Analysis</span>
      </label>
      <label class="hidden flex items-center space-x-2">
        <input type="checkbox" id="chkUbaUpload" class="text-green-600">
        <span class="text-gray-700">UBA Data Upload</span>
      </label>

      <label class="flex items-center space-x-2">
        <input type="radio" name="reportType" value="remittance" class="text-green-600">
        <span class="text-gray-700">Remittance Advice</span>
      </label>
      <label class="hidden flex items-center space-x-2">
        <input type="checkbox" id="chkIppis" class="text-green-600">
        <span class="text-gray-700 font-semibold">IPPIS</span>
      </label>

      <label class="flex items-center space-x-2">
        <input type="radio" name="reportType" value="summary" class="text-green-600">
        <span class="text-gray-700">Summary</span>
      </label>
      <label class="flex items-center space-x-2">
        <input type="checkbox" id="chkCopyToHistory" class="text-green-600">
        <span class="text-gray-700">Copy To History</span>
      </label>
    </div>

    <!-- Payroll Class -->
    <div>
      <label for="reportPayrollClass" class="block text-sm font-medium text-gray-700 mb-1">
        Payroll Class <span class="text-red-500">*</span>
      </label>
      <select 
        id="reportPayrollClass" 
        name="reportPayrollClass"
        class="w-full border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500"
        required>
        <option value="">Select Payroll Class...</option>
      </select>
    </div>

    <!-- Payment Type Selection (for remittance) -->
    <div id="paymentTypeSection" class="hidden">
      <label for="specificPaymentType" class="block text-sm font-medium text-gray-700 mb-1">
        Select Payment Type
      </label>
      <select 
        id="specificPaymentType"
        class="w-full border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500">
        <option value="">All Payment Types</option>
      </select>
    </div>

    <!-- Output Format -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Output Format <span class="text-red-500">*</span>
      </label>
      <div class="flex space-x-4">
        <label class="flex items-center space-x-2">
          <input type="radio" name="outputFormat" value="excel" class="text-green-600" checked>
          <span class="text-gray-700">Excel</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="radio" name="outputFormat" value="pdf" class="text-green-600">
          <span class="text-gray-700">PDF</span>
        </label>
      </div>
    </div>

    <!-- Bottom Row -->
    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
      <label class="flex items-center space-x-2">
        <input type="checkbox" id="chkAllMembers" class="text-green-600" checked>
        <span class="text-gray-700 font-medium">ALL Members</span>
      </label>

      <div class="flex gap-2">
        <button 
          type="button"
          id="reportCancelBtn"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded border border-gray-300">
          Cancel
        </button>
        <button 
          type="submit"
          id="reportGenerateBtn"
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow">
          Generate Report
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Loading Indicator -->
<div id="reportLoadingIndicator" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <div class="animate-spin h-12 w-12 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-4"></div>
    <p class="text-lg font-semibold mb-2" id="loadingTitle">Generating Report</p>
    <p class="text-sm text-gray-600" id="loadingMessage">Please wait while we process your request...</p>
  </div>
</div>

<!-- Success Modal -->
<div id="reportSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h3 class="text-xl font-semibold text-green-600 mb-2">Download Complete!</h3>
    <p class="mb-6 text-gray-700" id="reportSuccessMessage">Your report has been downloaded successfully.</p>
    <button id="reportSuccessOkBtn" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
      OK
    </button>
  </div>
</div>

<!-- Error Modal -->
<div id="reportErrorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </div>
    <h3 class="text-xl font-semibold text-red-600 mb-2">Error</h3>
    <p class="mb-6 text-gray-700" id="reportErrorMessage">An error occurred while generating the report.</p>
    <button id="reportErrorOkBtn" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">
      OK
    </button>
  </div>
</div>

<script>
(function() {
  const API_BASE = '/oneoffreports';
  const token = localStorage.getItem('token');

  // DOM Elements
  const form = document.getElementById('oneoffReportForm');
  const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');
  const payrollClassSelect = document.getElementById('reportPayrollClass');
  const paymentTypeSection = document.getElementById('paymentTypeSection');
  const specificPaymentType = document.getElementById('specificPaymentType');
  const chkAllClasses = document.getElementById('chkAllClasses');
  const chkUbaUpload = document.getElementById('chkUbaUpload');
  const chkIppis = document.getElementById('chkIppis');
  const chkCopyToHistory = document.getElementById('chkCopyToHistory');
  const chkAllMembers = document.getElementById('chkAllMembers');
  const reportCancelBtn = document.getElementById('reportCancelBtn');

  // Modals
  const loadingIndicator = document.getElementById('reportLoadingIndicator');
  const loadingTitle = document.getElementById('loadingTitle');
  const loadingMessage = document.getElementById('loadingMessage');
  //const progressBar = document.getElementById('progressBar');
  const successModal = document.getElementById('reportSuccessModal');
  const successMessage = document.getElementById('reportSuccessMessage');
  const successOkBtn = document.getElementById('reportSuccessOkBtn');
  const errorModal = document.getElementById('reportErrorModal');
  const errorMessage = document.getElementById('reportErrorMessage');
  const errorOkBtn = document.getElementById('reportErrorOkBtn');

  // Toggle payment type section
  reportTypeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'remittance') {
        paymentTypeSection.classList.remove('hidden');
      } else {
        paymentTypeSection.classList.add('hidden');
        specificPaymentType.value = '';
      }
    });
  });

  // Disable payroll class when All Classes is checked
  chkAllClasses.addEventListener('change', (e) => {
    payrollClassSelect.disabled = e.target.checked;
    if (e.target.checked) {
      payrollClassSelect.value = '';
    }
  });

  // Load payroll classes
  async function loadPayrollClasses() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/payslips/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.locations) {
          payrollClassSelect.innerHTML = '<option value="">All Locations</option>';
          result.data.locations.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.classcode;
            option.textContent = cls.classname || cls.classcode;
            payrollClassSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading locations:', error);
    }
  }

  async function fetchDatabaseName() {
    try {
    const token = localStorage.getItem("token");

    const res = await fetch("/payslips/database",{
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }                 
    });

    const data = await res.json();


    payrollClassSelect.innerHTML = ""; // clear old options

    const option = document.createElement("option");
    option.value = data.database;
    option.textContent = data.class_name;
    option.selected = true;

    payrollClassSelect.appendChild(option);
    } catch (err) {
    console.error("Failed to load payroll class:", err);
    }
  }

  // Load payment types for filter
  async function loadPaymentTypes() {
    try {
      const response = await fetch(`/off/oneofftypes`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();

      specificPaymentType.innerHTML = '<option value="">All Payment Types</option>';
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.one_type;
        option.textContent = `${item.one_type}`;
        specificPaymentType.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading payment types:', error);
    }
  }

  // Generate Report
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
    const payrollClass = payrollClassSelect.value;
    const allClasses = chkAllClasses.checked;
    const ubaUpload = chkUbaUpload.checked;
    const ippis = chkIppis.checked;
    const copyToHistory = chkCopyToHistory.checked;

    if (!payrollClass && !allClasses) {
      errorMessage.textContent = 'Please select a payroll class or check "All Classes"';
      errorModal.classList.remove('hidden');
      return;
    }

    // Show loading
    loadingTitle.textContent = 'Generating Report';
    loadingMessage.textContent = 'Processing data...';
    loadingIndicator.classList.remove('hidden');

    try {
      const requestBody = {
        reportType: reportType,
        payrollClass: payrollClass,
        allClasses: allClasses,
        ubaUpload: ubaUpload,
        ippis: ippis
      };

      if (reportType === 'remittance' && specificPaymentType.value) {
        requestBody.specificType = specificPaymentType.value;
      }

      loadingMessage.textContent = `Generating ${outputFormat.toUpperCase()} file...`;

      const endpoint = outputFormat === 'excel' 
        ? `${API_BASE}/generate-excel-report`
        : `${API_BASE}/generate-pdf-report`;

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to generate report');
      }

      loadingMessage.textContent = 'Downloading file...';

      // Download file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `oneoff_${reportType}_${Date.now()}.${outputFormat === 'excel' ? 'xlsx' : 'pdf'}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      // Hide loading and show success
      loadingIndicator.classList.add('hidden');
      successMessage.textContent = `Your ${reportType} report has been downloaded as ${outputFormat.toUpperCase()}.`;
      successModal.classList.remove('hidden');

      // Copy to history if checked
      if (copyToHistory) {
        // TODO: Implement copy to history functionality
        console.log('Copy to history feature to be implemented');
      }

    } catch (error) {
      console.error('Error generating report:', error);
      //clearInterval(progressInterval);
      loadingIndicator.classList.add('hidden');
      errorMessage.textContent = error.message || 'An error occurred while generating the report';
      errorModal.classList.remove('hidden');
    }
  });

  // Close modals
  successOkBtn.addEventListener('click', () => {
    successModal.classList.add('hidden');
  });

  errorOkBtn.addEventListener('click', () => {
    errorModal.classList.add('hidden');
  });

  reportCancelBtn.addEventListener('click', () => {
    form.reset();
    chkAllMembers.checked = true;
    payrollClassSelect.disabled = false;
  });

  // Initialize
  loadPayrollClasses();
  fetchDatabaseName();
  loadPaymentTypes();
})();
</script>
