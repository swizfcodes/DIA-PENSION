<!-- Payroll Register -->
<section class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <h2 class="text-xl text-center border-b font-bold text-green-600 mb-4">Generate And Print Payroll Register Report</h2>

  <form id="payrollForm" class="space-y-4">
    <!-- Location Selection -->
    <div>
      <label class="block font-medium mb-2">Select Location</label>
      <div class="flex gap-6">
        <label class="flex text-sm items-center gap-2">
          <input type="radio" id="allPayrollLocations" name="payrollLocationChoice" value="all" checked>
          <span>All Locations</span>
        </label>
        <label class="flex text-sm items-center gap-2">
          <input type="radio" id="specificPayrollLocation" name="payrollLocationChoice" value="specific">
          <span>Specific Location</span>
        </label>
      </div>
      <select id="payrollLocationDropdown"
        class="mt-2 w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" disabled>
        <option value="">Select Location</option>
        <!-- Options will be loaded from API -->
      </select>
    </div>

    <!-- Processing Month -->
    <div>
      <label for="payrollMonth" class="block text-sm font-medium mb-2">Processing Month</label>
      <select id="payrollMonth"
        class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
        <option value="">Select Month</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
    </div>

    <!-- Processing Year -->
    <div>
      <label for="payrollYear" class="block text-sm font-medium mb-2">Processing Year</label>
      <input type="number" id="payrollYear"
        class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"
        placeholder="e.g., 2025" min="2020" max="2099">
    </div>

    <!-- Output Format -->
    <div>
      <label class="block font-medium mb-2">Output Format</label>
      <div class="flex space-x-4">
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="payrollFormat" value="pdf" checked>
          <span>PDF</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="payrollFormat" value="excel">
          <span>Excel</span>
        </label>

        <div class="flex items-center gap-2 ">
          <input type="checkbox" id="payrollSummary" class="h-4 w-4">
          <label for="payrollSummary" class="text-sm">Summary Report</label>
        </div>
        <div class="hidden flex items-center gap-2 ">
          <input type="checkbox" id="payrollElements" class="h-4 w-4">
          <label for="payrollElements" class="text-sm">Include Pay Elements</label>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex flex-wrap justify-end gap-2 pt-2">
      <button type="reset" id="payrollClearBtn"
        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
        Clear
      </button>
      <button type="button" id="payrollPrintBtn"
        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Generate
      </button>
    </div>
  </form>
</section>

<!-- Loading Indicator -->
<div id="payrollLoadingIndicator" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-80 p-6 text-center">
      <div class="animate-spin h-10 w-10 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-4"></div>
    <span>Generating report...</span>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="payrollConfirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h3 class="text-lg font-semibold mb-4">Confirm Generation</h3>
    <p class="mb-6 text-gray-700">Proceed to generate payroll register?</p>
    <div class="flex justify-end gap-2">
      <button id="payrollCancelBtn" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
      <button id="payrollContinueBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Continue</button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="payrollSuccessModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-blue-600 mb-4">Success</h3>
    <p class="mb-6 text-gray-700" id="payrollSuccessMessage">Payroll register is ready.</p>
    <button id="payrollSuccessOkBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
  </div>
</div>

<!-- Error Modal -->
<div id="payrollErrorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Error</h3>
    <p id="payrollErrorText" class="mb-6 text-gray-700">Please complete required fields.</p>
    <button id="payrollErrorOkBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">OK</button>
  </div>
</div>

<script>
  const PAYROLL_API_BASE = '/payrollRegister';
  
  // Elements
  const allPayrollLocations = document.getElementById('allPayrollLocations');
  const specificPayrollLocation = document.getElementById('specificPayrollLocation');
  const payrollLocationDropdown = document.getElementById('payrollLocationDropdown');
  const payrollMonth = document.getElementById('payrollMonth');
  const payrollYear = document.getElementById('payrollYear');
  const payrollLoadingIndicator = document.getElementById('payrollLoadingIndicator');

  const payrollPrintBtn = document.getElementById('payrollPrintBtn');
  const payrollClearBtn = document.getElementById('payrollClearBtn');

  const payrollConfirmModal = document.getElementById('payrollConfirmModal');
  const payrollCancelBtn = document.getElementById('payrollCancelBtn');
  const payrollContinueBtn = document.getElementById('payrollContinueBtn');

  const payrollSuccessModal = document.getElementById('payrollSuccessModal');
  const payrollSuccessOkBtn = document.getElementById('payrollSuccessOkBtn');
  const payrollSuccessMessage = document.getElementById('payrollSuccessMessage');

  const payrollErrorModal = document.getElementById('payrollErrorModal');
  const payrollErrorOkBtn = document.getElementById('payrollErrorOkBtn');
  const payrollErrorText = document.getElementById('payrollErrorText');

  // Load current period and set default values
  async function loadCurrentPeriod() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/salarysummary/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data) {
          const period = result.data.currentPeriod;
          payrollYear.value = period.year;
          payrollMonth.value = period.month;
        }
      }
    } catch (error) {
      console.error('Error loading current period:', error);
    }
  }

  // Load locations on page load
  async function loadLocations() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/salarysummary/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.locations) {
          payrollLocationDropdown.innerHTML = '<option value="">All Locations</option>';
          result.data.locations.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc.location_code;
            option.textContent = loc.location_name || loc.location_code;
            payrollLocationDropdown.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading locations:', error);
    }
  }

  // Toggle location select
  function togglePayrollLocation() {
    payrollLocationDropdown.disabled = allPayrollLocations.checked;
    if (allPayrollLocations.checked) payrollLocationDropdown.value = '';
  }
  allPayrollLocations.addEventListener('change', togglePayrollLocation);
  specificPayrollLocation.addEventListener('change', togglePayrollLocation);

  // Open confirm
  payrollPrintBtn.addEventListener('click', () => {
    // Validation
    if (!payrollMonth.value) {
      payrollErrorText.textContent = 'Please select a processing month.';
      payrollErrorModal.classList.remove('hidden');
      return;
    }
    if (!payrollYear.value) {
      payrollErrorText.textContent = 'Please enter a processing year.';
      payrollErrorModal.classList.remove('hidden');
      return;
    }
    if (specificPayrollLocation.checked && !payrollLocationDropdown.value) {
      payrollErrorText.textContent = 'Please choose a location when "Specific Location" is selected.';
      payrollErrorModal.classList.remove('hidden');
      return;
    }

    payrollConfirmModal.classList.remove('hidden');
  });

  // Cancel confirm
  payrollCancelBtn.addEventListener('click', () => {
    payrollConfirmModal.classList.add('hidden');
  });

  // Continue -> process
  payrollContinueBtn.addEventListener('click', async () => {
    payrollConfirmModal.classList.add('hidden');
    payrollLoadingIndicator.classList.remove('hidden');
    payrollPrintBtn.disabled = true;

    const format = document.querySelector('input[name="payrollFormat"]:checked').value;
    const month = payrollMonth.value;
    const year = payrollYear.value;
    const summary = document.getElementById('payrollSummary').checked;
    const includeElements = document.getElementById('payrollElements').checked;

    try {
      const token = localStorage.getItem('token');
      
      // Build query parameters
      const params = new URLSearchParams({
        format: format,
        month: month,
        year: year,
        summary: summary ? '1' : '0',
        include_elements: includeElements ? '1' : '0'
      });

      if (specificPayrollLocation.checked && payrollLocationDropdown.value) {
        params.append('location', payrollLocationDropdown.value);
      }

      const response = await fetch(`${PAYROLL_API_BASE}/generate?${params.toString()}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Failed to generate report');
      }

      // Download file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      // Open PDF in new tab
      if (format === 'pdf') {
        window.open(url, '_blank');
      }

      const a = document.createElement('a');
      a.href = url;
      a.download = `payroll_register_${month}_${year}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      
      // Clean up blob URL after a delay
      setTimeout(() => window.URL.revokeObjectURL(url), 100);

      payrollLoadingIndicator.classList.add('hidden');
      payrollPrintBtn.disabled = false;
      payrollSuccessMessage.textContent = `Payroll register generated successfully! Your ${format.toUpperCase()} is downloading.`;
      payrollSuccessModal.classList.remove('hidden');

    } catch (error) {
      payrollLoadingIndicator.classList.add('hidden');
      payrollPrintBtn.disabled = false;
      payrollErrorText.textContent = error.message || 'Failed to generate report. Please try again.';
      payrollErrorModal.classList.remove('hidden');
      console.error('Error:', error);
    }
  });

  // Error OK
  payrollErrorOkBtn.addEventListener('click', () => {
    payrollErrorModal.classList.add('hidden');
  });

  // Success OK
  payrollSuccessOkBtn.addEventListener('click', () => {
    payrollSuccessModal.classList.add('hidden');
  });

  // Reset form
  payrollClearBtn.addEventListener('click', () => {
    setTimeout(() => {
      allPayrollLocations.checked = true;
      togglePayrollLocation();
      payrollYear.value = new Date().getFullYear();
    }, 0);
  });

  // Initialize
  togglePayrollLocation();
  loadLocations();
  loadCurrentPeriod();
</script>



