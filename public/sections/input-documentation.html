<style>
  .dropdown-container {
    position: relative;
  }
  .dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 50;
  }
  .dropdown-item:hover {
    background-color: #eff6ff;
  }
</style>

<!-- Input Documentation Section -->
<div class="p-6">
  
  <!-- Add New Button -->
  <div class="mb-4 flex flex-wrap gap-2 items-center justify-between">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Input Documentation Form</h3>

    <div class="flex flex-wrap gap-2 justify-end">
      <button type="button" id="printAllBtn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
        <i class="fa-solid fa-print mr-2"></i>
        Print All
      </button>
      <button type="button" id="addNewBtn"
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">
        + Add New
      </button>
    </div>
  </div>

  <!-- Add New Form -->
  <div id="addNewForm" class="hidden my-6">
    <h4 class="text-lg font-semibold text-yellow-600 mb-4">Add New Record</h4>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="dropdown-container">
        <label for="newName" class="block text-sm font-medium text-gray-700">Select Name</label>
        <div class="relative">
          <input type="text" id="newName" placeholder="Search employee..."
            class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500" />
          <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input type="hidden" id="newNameId" />
        <div id="newNameDropdown" class="dropdown-list hidden">
          <div id="newNameDropdownItems"></div>
        </div>
      </div>
      <div>
        <label for="newYear" class="block text-sm font-medium text-gray-700">Year</label>
        <input id="newYear" type="text" placeholder="Enter year"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" />
      </div>
      <div>
        <label for="newMonth" class="block text-sm font-medium text-gray-700">Month</label>
        <select id="newMonth"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
          <option value="">-- Select Month --</option>
          <option value="01">January</option>
          <option value="02">February</option>
          <option value="03">March</option>
          <option value="04">April</option>
          <option value="05">May</option>
          <option value="06">June</option>
          <option value="07">July</option>
          <option value="08">August</option>
          <option value="09">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>
      <div>
        <label for="newRef" class="block text-sm font-medium text-gray-700">Reference No</label>
        <input id="newRef" type="text" placeholder="Enter reference"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" />
      </div>
      <div>
        <label for="newComments" class="block text-sm font-medium text-gray-700">Comments</label>
        <input id="newComments" type="text" placeholder="Enter comments"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" />
      </div>
    </div>

    <!-- Add New Action Buttons -->
    <div class="flex justify-end space-x-4 pt-4">
      <button type="button" id="saveNewBtn"
        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
        Save
      </button>
      <button type="button" id="cancelNewBtn"
        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow">
        Cancel
      </button>
    </div>
  </div>

  <form id="inputDocForm" class="space-y-4">
    <!-- Name Dropdown - Conditionally Visible -->
    <div class="dropdown-container" id="mainSelectContainer">
      <label for="docName" class="block text-sm font-medium text-gray-700">Select Name</label>
      <div class="relative w-full lg:w-1/2 md:w-1/2">
        <input type="text" id="docName" placeholder="Search employee..."
          class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500" />
        <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input type="hidden" id="docNameId" />
      <div id="docNameDropdown" class="dropdown-list hidden" style="width: 50%;">
        <div id="docNameDropdownItems"></div>
      </div>
    </div>

    <!-- Form Fields -->
    <div id="formFields" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="docYear" class="block text-sm font-medium text-gray-700">Year</label>
          <input id="docYear" type="text" placeholder="Year"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" readonly />
        </div>
        <div>
          <label for="docMonth" class="block text-sm font-medium text-gray-700">Month</label>
          <select id="docMonth"  placeholder="Month"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" disabled>
            <option value="">-- Select Month --</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div>
          <label for="docRef" class="block text-sm font-medium text-gray-700">Reference No</label>
          <input id="docRef" type="text" placeholder="Reference No"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" readonly />
        </div>
        <div>
          <label for="docComments" class="block text-sm font-medium text-gray-700">Comments</label>
          <input id="docComments" type="text" placeholder="Comments"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" readonly />
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-2 pt-4">
        <!-- View Mode Buttons -->
        <!-- Clear Button for Main Form -->
        


        <div id="viewButtons" class="flex space-x-4">
          <button type="button" id="clearBtn"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow">
            Close
          </button>
          <button type="button" id="printBtn"
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">
            <i class="fa-solid fa-print mr-2"></i>
            Print
          </button>
          <button type="button" id="editBtn"
            class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg shadow">
            Edit
          </button>
        </div>

        <!-- Edit Mode Buttons -->
        <div id="editButtons" class="hidden flex space-x-4">
          <button type="button" id="saveBtn"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
            Save
          </button>
          <button type="button" id="cancelEditBtn"
            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
      <div id="loadingSpinner" class="flex justify-center mb-4">
          <div class="w-10 h-10 border-4 border-gray-200 border-t-green-600 rounded-full animate-spin"></div>
      </div>
      <div id="successTick" class="hidden flex justify-center mb-4">
          <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
          </div>
      </div>
      <div id="errorIcon" class="hidden flex justify-center mb-4">
          <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
          </div>
      </div>
      <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
  </div>
</div>


<script>
(function () {
  const API_BASE = '/documentation';

  function getAuthToken() {
    return localStorage.getItem('token')
  }

  // State management
  let isEditing = false;
  let originalData = {};
  let allEmployees = [];
  let allDocumentation = [];

  // Month mapping for converting 2-digit format to full names
  const monthMap = {
    '01': 'January', '02': 'February', '03': 'March', '04': 'April',
    '05': 'May', '06': 'June', '07': 'July', '08': 'August',
    '09': 'September', '10': 'October', '11': 'November', '12': 'December'
  };

  // DOM elements
  const docNameInput = document.getElementById("docName");
  const docNameId = document.getElementById("docNameId");
  const docNameDropdown = document.getElementById("docNameDropdown");
  const docNameDropdownItems = document.getElementById("docNameDropdownItems");
  const mainSelectContainer = document.getElementById("mainSelectContainer");
  
  const formFields = document.getElementById("formFields");
  const addNewForm = document.getElementById("addNewForm");
  const addNewBtn = document.getElementById("addNewBtn");
  //const clearFormBtnContainer = document.getElementById("clearFormBtnContainer");
  const viewButtons = document.getElementById("viewButtons");
  const editButtons = document.getElementById("editButtons");
  
  // Modals
  const confirmModal = document.getElementById("confirmModal");
  const successModal = document.getElementById("successModal");
  const loadingSpinner = document.getElementById("loadingSpinner");
  const successTick = document.getElementById("successTick");
  const errorIcon = document.getElementById("errorIcon");
  const successMessage = document.getElementById("successMessage");

  // New form elements
  const newNameInput = document.getElementById("newName");
  const newNameId = document.getElementById("newNameId");
  const newNameDropdown = document.getElementById("newNameDropdown");
  const newNameDropdownItems = document.getElementById("newNameDropdownItems");

  // Field elements
  const docYear = document.getElementById("docYear");
  const docMonth = document.getElementById("docMonth");
  const docRef = document.getElementById("docRef");
  const docComments = document.getElementById("docComments");

  // API Functions
  async function fetchEmployees() {
    try {
      const token = getAuthToken();
      const response = await fetch('/personnel/employees-current', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await response.json();
      
      if (result.success) {
        allEmployees = result.data;
        renderEmployeeDropdown(allEmployees, docNameDropdownItems);
        renderEmployeeDropdown(allEmployees, newNameDropdownItems);
      }
    } catch (error) {
      console.error('Error fetching employees:', error);
    }
  }

  async function fetchDocumentation() {
    try {
      const token = getAuthToken();
      const response = await fetch(API_BASE, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      allDocumentation = await response.json();
    } catch (error) {
      console.error('Error fetching documentation:', error);
    }
  }

  async function loadDocumentation(doc_numb) {
    try {
      const token = getAuthToken();

      // Slash handling
      const pathSegment = `${doc_numb}`;
      const encodedId = encodeURIComponent(pathSegment);
      
      const response = await fetch(`${API_BASE}/${encodedId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const data = await response.json();
      
      if (data) {
        docYear.value = data.doc_year || '';
        docMonth.value = data.doc_month || '';       
        docRef.value = data.doc_ref || '';
        docComments.value = data.doc_remark || '';
        
        formFields.classList.remove("hidden");
        //clearFormBtnContainer.classList.remove("hidden");
        setViewMode();
      }
    } catch (error) {
      console.error('Error loading documentation:', error);
    }
  }

  async function createDocumentation(data) {
    try {
      const token = getAuthToken();
      const response = await fetch(`${API_BASE}/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      
      if (response.ok) {
        showSuccessModal('Record created successfully!');
        await fetchDocumentation();
        return true;
      } else {
        showError(result.error || 'Failed to create record');
        return false;
      }
    } catch (error) {
      console.error('Error creating documentation:', error);
      showError('Error creating record');
      return false;
    }
  }

  async function updateDocumentation(doc_numb, data) {
    try {
      const token = getAuthToken();

      // Slash handling
      const pathSegment = `${doc_numb}`;
      const encodedId = encodeURIComponent(pathSegment);
      
      const response = await fetch(`${API_BASE}/${encodedId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      const result = await response.json();
      
      if (response.ok) {
        showSuccessModal('Record updated successfully!');
        await fetchDocumentation();
        return true;
      } else {
        showError(result.error || 'Failed to update record');
        return false;
      }
    } catch (error) {
      console.error('Error updating documentation:', error);
      showError('Error updating record');
      return false;
    }
  }

  // UI Functions
  function renderEmployeeDropdown(employees, containerElement) {
    containerElement.innerHTML = '';
    
    // Filter employees based on which dropdown this is
    let filteredEmployees = employees;
    if (containerElement === docNameDropdownItems) {
      // Main dropdown: only show employees with documentation records
      filteredEmployees = employees.filter(emp => 
        allDocumentation.some(doc => doc.doc_numb === emp.Empl_ID)
      );
    }
    
    filteredEmployees.forEach(emp => {
      const div = document.createElement('div');
      div.className = 'dropdown-item px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-gray-100';
      div.setAttribute('data-value', emp.Empl_ID);
      div.innerHTML = `
        <span class="font-semibold text-green-600">${emp.Empl_ID}</span> - ${emp.Surname} ${emp.OtherName}
      `;
      
      div.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        const text = this.textContent.trim();
        
        if (containerElement === docNameDropdownItems) {
          docNameInput.value = text;
          docNameId.value = value;
          docNameDropdown.classList.add('hidden');
          loadDocumentation(value);
        } else {
          newNameInput.value = text;
          newNameId.value = value;
          newNameDropdown.classList.add('hidden');
          prefillNewFormIfExists(value);
        }
      });
      
      containerElement.appendChild(div);
    });
  }
  
  function prefillNewFormIfExists(emplId) {
    const existingDoc = allDocumentation.find(doc => doc.doc_numb === emplId);
    
    if (existingDoc) {
      document.getElementById("newYear").value = existingDoc.doc_year || '';
      document.getElementById("newMonth").value = existingDoc.doc_month || '';
      document.getElementById("newRef").value = existingDoc.doc_ref || '';
      document.getElementById("newComments").value = existingDoc.doc_remark || '';
    } else {
      // Clear fields if no existing record
      document.getElementById("newYear").value = '';
      document.getElementById("newMonth").value = '';
      document.getElementById("newRef").value = '';
      document.getElementById("newComments").value = '';
    }
  }

  function filterDropdown(searchText, dropdownItems) {
    const items = dropdownItems.querySelectorAll('.dropdown-item');
    
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      const shouldShow = text.includes(searchText.toLowerCase());
      item.style.display = shouldShow ? 'block' : 'none';
    });
  }

  function setViewMode() {
    isEditing = false;
    viewButtons.classList.remove("hidden");
    editButtons.classList.add("hidden");
    
    docYear.readOnly = true;
    docMonth.disabled = true;
    docRef.readOnly = true;
    docComments.readOnly = true;
    
    [docYear, docMonth, docRef, docComments].forEach(field => {
      field.classList.remove("bg-yellow-50", "border-yellow-300");
    });
  }

  function setEditMode() {
    isEditing = true;
    
    originalData = {
      year: docYear.value,
      month: docMonth.value,
      ref: docRef.value,
      comments: docComments.value
    };
    
    viewButtons.classList.add("hidden");
    editButtons.classList.remove("hidden");
    
    docYear.readOnly = false;
    docMonth.disabled = false;
    docRef.readOnly = false;
    docComments.readOnly = false;
    
    [docYear, docMonth, docRef, docComments].forEach(field => {
      field.classList.add("bg-yellow-50", "border-yellow-300");
    });
  }

  async function saveChanges() {
    const data = {
      doc_year: docYear.value,
      doc_month: docMonth.value,
      doc_ref: docRef.value,
      doc_remark: docComments.value
    };
    
    const success = await updateDocumentation(docNameId.value, data);
    if (success) {
      setTimeout(() => {
        setViewMode();
      }, 2000);
    }
  }

  function cancelEdit() {
    docYear.value = originalData.year;
    docMonth.value = originalData.month;
    docRef.value = originalData.ref;
    docComments.value = originalData.comments;
    
    setViewMode();
  }

  function clearMainForm() {
    docNameInput.value = "";
    docNameId.value = "";
    docYear.value = "";
    docMonth.value = "";
    docRef.value = "";
    docComments.value = "";
    formFields.classList.add("hidden");
    //clearFormBtnContainer.classList.add("hidden");
    isEditing = false;
  }

  async function saveNewRecord() {
    const doc_numb = newNameId.value;
    const doc_year = document.getElementById("newYear").value;
    const doc_month = document.getElementById("newMonth").value;
    const doc_ref = document.getElementById("newRef").value;
    const doc_remark = document.getElementById("newComments").value;
    
    if (!doc_numb || !doc_year || !doc_month || !doc_ref) {
      showError("Please fill in all required fields");
      return;
    }
    
    const data = {
      doc_numb,
      doc_year,
      doc_month,
      doc_ref,
      doc_remark
    };
    
    const success = await createDocumentation(data);
    if (success) {
      setTimeout(() => {
        cancelNew();
      }, 2000);
    }
  }

  function cancelNew() {
    addNewForm.classList.add("hidden");
    mainSelectContainer.classList.remove("hidden");
    clearNewFields();
  }

  function clearNewFields() {
    newNameInput.value = "";
    newNameId.value = "";
    document.getElementById("newYear").value = "";
    document.getElementById("newMonth").value = "";
    document.getElementById("newRef").value = "";
    document.getElementById("newComments").value = "";
  }

  function showSuccessModal(message, isError = false) {
    successMessage.textContent = "Processing...";
    loadingSpinner.classList.remove("hidden");
    successTick.classList.add("hidden");
    errorIcon.classList.add("hidden");
    successModal.classList.remove("hidden");

    setTimeout(() => {
      loadingSpinner.classList.add("hidden");
      
      if (isError) {
        errorIcon.classList.remove("hidden");
      } else {
        successTick.classList.remove("hidden");
      }
      
      successMessage.textContent = message;
      
      setTimeout(() => {
        successModal.classList.add("hidden");
      }, 2000);
    }, 1000);
  }

  function showError(message) {
    showSuccessModal(message, true);
  }

function printSelected() {
    if (!docNameId.value) {
      showError("Please select an employee first");
      return;
    }
    
    const selectedEmployee = allEmployees.find(e => e.Empl_ID === docNameId.value);
    if (!selectedEmployee) return;
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    const generatedBy = localStorage.getItem('full_name') || 'System User';
    
    const printWindow = window.open('', '_blank');
    const htmlContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>Documentation - ${selectedEmployee.Surname} ${selectedEmployee.OtherName}</title>
          <style>
            @page { 
              size: A4 portrait; 
              margin: 0.5mm; 
              background-color: #f8fbff;
            }
            
            body { 
              font-family: Helvetica, Arial, sans-serif; 
              font-size: 10pt;
              margin: 40px;
              position: relative;
              color: #333;
            }

            /* Faint logo overlay */
            body::before {
              content: "";
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-image: url('photos/logo.png');
              background-size: auto 100%;
              background-repeat: no-repeat;
              background-position: center center;
              opacity: 0.02;
              z-index: -1;
              pointer-events: none;
            }

            .header-wrapper {
              display: flex;
              align-items: flex-start;
              margin-bottom: 8px;
              border-bottom: 2px solid #1a1a1a;
              padding-bottom: 5px;
            }

            .header {
              flex-grow: 1;
              text-align: center;
            }
            
            .header h1 {
              font-size: 13pt;
              font-weight: bold;
              margin-bottom: 2px;
              letter-spacing: 1.5px;
              color: #15803d;
              font-family: 'Libre Baskerville', Georgia, serif;
            }
            
            .header h2 {
              font-size: 10pt;
              font-weight: normal;
              margin-top: 2px;
              color: #4a4a4a;
              font-family: 'Libre Baskerville', Georgia, serif;
            }

            .header-info {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 10px 0 20px 0;
              font-size: 9pt;
            }

            table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
              font-size: 10pt;
            }

            th {
              color: #15803d;
              padding: 12px 8px;
              text-align: left;
              font-weight: bold;
              font-size: 10pt;
              text-transform: uppercase;
              letter-spacing: 0.3px;
              border-bottom: 1px solid #0056A0;
              width: 30%;
            }

            td {
              padding: 12px 8px;
              border: none;
              vertical-align: middle;
              border-bottom: 0.5px solid #e5e7eb;
            }

            .footer {
              padding-top: 10px;
              border-top: 0.5px solid #1a1a1a;
              text-align: center;
              font-size: 8pt;
              color: #64748b;
              margin-top: 30px;
            }

            @media print {
              body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
              }
              
              body::before {
                position: fixed;
                display: block;
                content: "";
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background-image: url('photos/logo.png');
                background-size: auto 100%;
                background-repeat: no-repeat;
                background-position: center center;
                opacity: 0.02;
                z-index: -1;
              }
            }
          </style>
        </head>
        <body>
          <div class="header-wrapper">
            <div class="header">
              <h1>DEFENCE INTELLIGENCE AGENCY</h1>
              <h2>ASOKORO - ABUJA - DEFENCE INTELIGENCE AGENCY</h2>
            </div>
          </div>

          <div class="header-info">
            <div class="left">
              <strong>DOCUMENTATION RECORD</strong>
            </div>
            <div class="center">
              <span>PRODUCED ON</span> 
              <strong>${dateStr}</strong> 
              <span>AT</span> 
              <strong>${timeStr}</strong>
            </div>
            <div class="right">
              <strong>SINGLE RECORD</strong>
            </div>
          </div>

          <table>
            <tr><th>Service No</th><td><strong>${docNameId.value}</strong></td></tr>
            <tr><th>Name</th><td><strong>${selectedEmployee.Surname} ${selectedEmployee.OtherName}</strong></td></tr>
            <tr><th>Year</th><td>${docYear.value}</td></tr>
            <tr><th>Month</th><td>${docMonth.value}</td></tr>
            <tr><th>Reference No</th><td>${docRef.value}</td></tr>
            <tr><th>Comments</th><td>${docComments.value}</td></tr>
          </table>

          <div class="footer">
            <p>Generated by: ${generatedBy}</p>
            <p>All rights reserved &#xA9; Hicad Systems Limited.</p>
          </div>
        </body>
      </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
      printWindow.print();
    };
  }

  function printAll() {
    if (allDocumentation.length === 0) {
      showError("No records to print");
      return;
    }
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    const generatedBy = localStorage.getItem('full_name') || 'System User';
    
    const printWindow = window.open('', '_blank');
    let tableRows = '';
    
    allDocumentation.forEach(doc => {
      const employee = allEmployees.find(e => e.Empl_ID === doc.doc_numb);
      const empName = employee ? `${employee.Surname} ${employee.OtherName}` : 'N/A';
      
      let monthValue = doc.doc_month || '';
      if (monthValue.length === 2 && monthMap[monthValue]) {
        monthValue = monthMap[monthValue];
      }
      
      tableRows += `
        <tr>
          <td><strong>${doc.doc_numb}</strong></td>
          <td style="white-space: nowrap;"><strong>${empName}</strong></td>
          <td>${doc.doc_year || ''}</td>
          <td>${monthValue}</td>
          <td>${doc.doc_ref || ''}</td>
          <td>${doc.doc_remark || ''}</td>
        </tr>
      `;
    });
    
    const htmlContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>All Documentation Records</title>
          <style>
            @page { 
              size: A4 ; 
              margin: 5mm; 
              background-color: #f8fbff;
            }
            
            body { 
              font-family: Helvetica, Arial, sans-serif; 
              font-size: 9pt;
              margin: 0;
              padding: 0;
              position: relative;
              color: #333;
            }

            /* Faint logo overlay */
            body::before {
              content: "";
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-image: url('photos/logo.png');
              background-size: auto 100%;
              background-repeat: no-repeat;
              background-position: center center;
              opacity: 0.02;
              z-index: -1;
              pointer-events: none;
            }

            .header-wrapper {
              display: flex;
              align-items: flex-start;
              margin-bottom: 8px;
              border-bottom: 2px solid #1a1a1a;
              padding-bottom: 5px;
            }

            .header {
              flex-grow: 1;
              text-align: center;
            }
            
            .header h1 {
              font-size: 13pt;
              font-weight: bold;
              margin-bottom: 2px;
              letter-spacing: 1.5px;
              color: #15803d;
              font-family: 'Libre Baskerville', Georgia, serif;
            }
            
            .header h2 {
              font-size: 10pt;
              font-weight: normal;
              margin-top: 2px;
              color: #4a4a4a;
              font-family: 'Libre Baskerville', Georgia, serif;
            }

            .header-info {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 10px 0;
              font-size: 9pt;
            }

            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
              font-size: 11px;
            }

            th {
              color: #15803d;
              padding: 8px 4px;
              text-align: left;
              font-weight: bold;
              font-size: 12px;
              text-transform: uppercase;
              letter-spacing: 0.3px;
              border-bottom: 1px solid #0056A0;
            }

            td {
              padding: 6px 4px;
              border: none;
              vertical-align: middle;
            }

            .text-center {
              text-align: center;
            }

            .footer {
              padding-top: 10px;
              border-top: 0.5px solid #1a1a1a;
              text-align: center;
              font-size: 8pt;
              color: #64748b;
              margin-top: 20px;
            }

            @media print {
              body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
              }
              
              body::before {
                position: fixed;
                display: block;
                content: "";
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background-image: url('photos/logo.png');
                background-size: auto 100%;
                background-repeat: no-repeat;
                background-position: center center;
                opacity: 0.02;
                z-index: -1;
              }
            }
          </style>
        </head>
        <body>
          <div class="header-wrapper">
            <div class="header">
              <h1>DEFENCE INTELLIGENCE AGENCY</h1>
              <h2>ASOKORO - ABUJA - DEFENCE INTELIGENCE AGENCY</h2>
            </div>
          </div>

          <div class="header-info">
            <div class="left">
              <strong>DOCUMENTATION RECORDS</strong>
            </div>
            <div class="center">
              <span>PRODUCED ON</span> 
              <strong>${dateStr}</strong> 
              <span>AT</span> 
              <strong>${timeStr}</strong>
            </div>
            <div class="right">
              <strong>${allDocumentation.length}</strong>
              <span>RECORDS</span>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 12%;">Service No</th>
                <th style="width: 25%;">Name</th>
                <th style="width: 8%;">Year</th>
                <th style="width: 10%;">Month</th>
                <th style="width: 15%;">Ref. No</th>
                <th style="width: 30%;">Comments</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>

          <div class="footer">
            <p>All rights reserved &#xA9; Hicad Systems Limited.</p>
          </div>
        </body>
      </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
      printWindow.print();
    };
  }

  // Event Listeners
  addNewBtn.addEventListener("click", function () {
    formFields.classList.add("hidden");
    //clearFormBtnContainer.classList.add("hidden");
    addNewForm.classList.remove("hidden");
    mainSelectContainer.classList.add("hidden");
    docNameInput.value = "";
    docNameId.value = "";
    clearNewFields();
  });

  document.getElementById("clearBtn").addEventListener("click", clearMainForm);
  document.getElementById("editBtn").addEventListener("click", setEditMode);
  document.getElementById("saveBtn").addEventListener("click", saveChanges);
  document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);
  document.getElementById("saveNewBtn").addEventListener("click", saveNewRecord);
  document.getElementById("cancelNewBtn").addEventListener("click", cancelNew);
  document.getElementById("printBtn").addEventListener("click", printSelected);
  document.getElementById("printAllBtn").addEventListener("click", printAll);

  // Dropdown listeners for main form
  docNameInput.addEventListener('focus', () => {
    docNameDropdown.classList.remove('hidden');
  });

  docNameInput.addEventListener('input', function() {
    filterDropdown(this.value, docNameDropdownItems);
    docNameDropdown.classList.remove('hidden');
  });

  // Dropdown listeners for new form
  newNameInput.addEventListener('focus', () => {
    newNameDropdown.classList.remove('hidden');
  });

  newNameInput.addEventListener('input', function() {
    filterDropdown(this.value, newNameDropdownItems);
    newNameDropdown.classList.remove('hidden');
  });

  // Close dropdowns on outside click
  document.addEventListener('click', function(e) {
    if (!docNameInput.contains(e.target) && !docNameDropdown.contains(e.target)) {
      docNameDropdown.classList.add('hidden');
    }
    if (!newNameInput.contains(e.target) && !newNameDropdown.contains(e.target)) {
      newNameDropdown.classList.add('hidden');
    }
  });

  // Initialize
  fetchDocumentation();
  fetchEmployees();

})();
</script>



