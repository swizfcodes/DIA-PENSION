<!-- One-Off Payment Calculation Section -->
<div class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-3">
    <h3 class="text-xl font-bold text-blue-700 flex items-center gap-2">
      Calculate One-Off Payments
    </h3>
    <button onclick="window.navigation.navigateToSection('debug', 'Payroll Debug')"  class="hidden bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded text-white transition-colors">
      Debug
    </button>    
  </div>

  <form id="oneoffCalculationForm" class="space-y-4">
    
    <!-- Payroll Class -->
    <div>
      <label for="payrollClass" class="block text-sm font-medium text-gray-700 mb-1">
        Payroll Class <span class="text-red-500">*</span>
      </label>
      <select 
        id="payrollClass" 
        name="payrollClass"
        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        required>
        <option value="">Select Payroll Class...</option>
      </select>
    </div>

    <!-- Employee Selection Options -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Calculate For
      </label>
      <div class="space-y-2">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input 
            type="radio" 
            name="calculationType" 
            value="all" 
            class="text-blue-600"
            checked>
          <span class="text-gray-700">All Active Members</span>
        </label>
        
        <label class="flex items-center space-x-2 cursor-pointer">
          <input 
            type="radio" 
            name="calculationType" 
            value="specific" 
            class="text-blue-600">
          <span class="text-gray-700">Specific Employees</span>
        </label>
      </div>
    </div>

    <!-- Specific Employees Input (Hidden by default) -->
    <div id="specificEmployeesSection" class="hidden">
      <label for="specificEmployees" class="block text-sm font-medium text-gray-700 mb-1">
        Employee IDs (comma-separated)
      </label>
      <textarea
        id="specificEmployees"
        name="specificEmployees"
        rows="3"
        placeholder="e.g., NN/4466, NN/4467, NN/4468"
        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
      <p class="text-xs text-gray-500 mt-1">
        Enter employee IDs separated by commas or line breaks
      </p>
    </div>

    <!-- Calculation Summary (Shown after calculation) -->
    <div id="calculationSummary" class="hidden bg-blue-50 border border-blue-200 rounded p-4">
      <h4 class="font-semibold text-blue-800 mb-2">Last Calculation Summary</h4>
      <div class="space-y-1 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Employees Processed:</span>
          <span id="summaryEmployees" class="font-semibold text-gray-800">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Total Calculations:</span>
          <span id="summaryCalculations" class="font-semibold text-gray-800">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Errors:</span>
          <span id="summaryErrors" class="font-semibold text-red-600">0</span>
        </div>
      </div>
      <button 
        type="button"
        id="viewResultsBtn"
        class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow text-sm">
        View Calculation Results
      </button>
    </div>

    <!-- Buttons -->
    <div class="flex justify-end gap-2 pt-4 border-t border-gray-200">
      <button 
        type="button"
        id="clearCalculationBtn"
        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded border border-gray-300 text-gray-700">
        Clear Calculation
      </button>
      <button 
        type="submit"
        id="calculateBtn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow">
        Calculate
      </button>
    </div>
  </form>
</div>

<!-- Calculation Results Modal -->
<div id="calculationResultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
    
    <!-- Modal Header -->
    <div class="flex justify-between items-center p-4 border-b border-gray-200">
      <h3 class="text-lg font-bold text-gray-800">Calculation Results</h3>
      <button id="closeResultsModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Search and Filter -->
    <div class="p-4 border-b border-gray-200 bg-gray-50">
      <div class="grid grid-cols-3 gap-3">
        <input 
          type="text" 
          id="searchEmployee"
          placeholder="Search Employee ID..."
          class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
        <select 
          id="filterPaymentType"
          class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
          <option value="">All Payment Types</option>
        </select>
        <button 
          id="refreshResultsBtn"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
          Refresh
        </button>
      </div>
    </div>

    <!-- Results Table -->
    <div class="flex-1 overflow-auto p-4">
      <table class="w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="text-left p-2 border-b font-semibold text-gray-700">Employee ID</th>
            <th class="text-left p-2 border-b font-semibold text-gray-700">Name</th>
            <th class="text-left p-2 border-b font-semibold text-gray-700">Grade</th>
            <th class="text-left p-2 border-b font-semibold text-gray-700">Payment Type</th>
            <th class="text-left p-2 border-b font-semibold text-gray-700">Description</th>
            <th class="text-right p-2 border-b font-semibold text-gray-700">Amount</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody">
          <tr>
            <td colspan="6" class="text-center p-8 text-gray-500">
              No results to display
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="p-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
      <div class="text-sm text-gray-600">
        Showing <span id="currentRecords">0</span> of <span id="totalRecords">0</span> records
      </div>
      <div class="flex gap-2">
        <button 
          id="prevPageBtn"
          class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Previous
        </button>
        <span class="px-3 py-1 text-sm text-gray-600">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button 
          id="nextPageBtn"
          class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Indicator -->
<div id="calculationLoadingIndicator" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-80 p-6 text-center">
    <div class="animate-spin h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
    <span class="text-gray-700">Calculating one-off payments...</span>
  </div>
</div>

<!-- Success Modal -->
<div id="calculationSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-green-600 mb-4">Calculation Complete</h3>
    <p class="mb-6 text-gray-700" id="calculationSuccessMessage">Payments calculated successfully!</p>
    <button id="calculationSuccessOkBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
      OK
    </button>
  </div>
</div>

<!-- Error Modal -->
<div id="calculationErrorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Calculation Error</h3>
    <p class="mb-6 text-gray-700" id="calculationErrorMessage">An error occurred.</p>
    <button id="calculationErrorOkBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
      OK
    </button>
  </div>
</div>

<script>
(function() {
  const API_BASE = '/oneoff';
  const token = localStorage.getItem('token');

  // DOM Elements
  const form = document.getElementById('oneoffCalculationForm');
  const payrollClassSelect = document.getElementById('payrollClass');
  const calculationTypeRadios = document.querySelectorAll('input[name="calculationType"]');
  const specificEmployeesSection = document.getElementById('specificEmployeesSection');
  const specificEmployeesInput = document.getElementById('specificEmployees');
  const calculateBtn = document.getElementById('calculateBtn');
  const clearCalculationBtn = document.getElementById('clearCalculationBtn');
  const viewResultsBtn = document.getElementById('viewResultsBtn');
  
  // Summary
  const calculationSummary = document.getElementById('calculationSummary');
  const summaryEmployees = document.getElementById('summaryEmployees');
  const summaryCalculations = document.getElementById('summaryCalculations');
  const summaryErrors = document.getElementById('summaryErrors');

  // Modals
  const loadingIndicator = document.getElementById('calculationLoadingIndicator');
  const successModal = document.getElementById('calculationSuccessModal');
  const successMessage = document.getElementById('calculationSuccessMessage');
  const successOkBtn = document.getElementById('calculationSuccessOkBtn');
  const errorModal = document.getElementById('calculationErrorModal');
  const errorMessage = document.getElementById('calculationErrorMessage');
  const errorOkBtn = document.getElementById('calculationErrorOkBtn');

  // Results Modal
  const resultsModal = document.getElementById('calculationResultsModal');
  const closeResultsModal = document.getElementById('closeResultsModal');
  const searchEmployee = document.getElementById('searchEmployee');
  const filterPaymentType = document.getElementById('filterPaymentType');
  const refreshResultsBtn = document.getElementById('refreshResultsBtn');
  const resultsTableBody = document.getElementById('resultsTableBody');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const currentPage = document.getElementById('currentPage');
  const totalPages = document.getElementById('totalPages');
  const currentRecords = document.getElementById('currentRecords');
  const totalRecords = document.getElementById('totalRecords');

  let currentResultsPage = 1;
  const resultsPerPage = 50;

  // Toggle specific employees section
  calculationTypeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'specific') {
        specificEmployeesSection.classList.remove('hidden');
      } else {
        specificEmployeesSection.classList.add('hidden');
        specificEmployeesInput.value = '';
      }
    });
  });

  // Load payroll classes
  async function loadPayrollClasses() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/payslips/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.locations) {
          payrollClassSelect.innerHTML = '<option value="">All Locations</option>';
          result.data.locations.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.classcode;
            option.textContent = cls.classname || cls.classcode;
            payrollClassSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading locations:', error);
    }
  }

  async function fetchDatabaseName() {
    try {
    const token = localStorage.getItem("token");

    const res = await fetch("/payslips/database",{
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }                 
    });

    const data = await res.json();


    payrollClassSelect.innerHTML = ""; // clear old options

    const option = document.createElement("option");
    option.value = data.database;
    option.textContent = data.class_name;
    option.selected = true;

    payrollClassSelect.appendChild(option);
    } catch (err) {
    console.error("Failed to load payroll class:", err);
    }
  }

  // Load payment types for filter
  async function loadPaymentTypes() {
    try {
      const response = await fetch(`/off/oneofftypes`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();

      filterPaymentType.innerHTML = '<option value="">All Payment Types</option>';
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.one_type;
        option.textContent = `${item.one_type} - ${item.one_bpay || 'N/A'}`;
        filterPaymentType.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading payment types:', error);
    }
  }

  // Calculate
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payrollClass = payrollClassSelect.value;
    const calculationType = document.querySelector('input[name="calculationType"]:checked').value;

    if (!payrollClass) {
      errorMessage.textContent = 'Please select a payroll class';
      errorModal.classList.remove('hidden');
      return;
    }

    const requestBody = {
      payrollClass: payrollClass,
      allMembers: calculationType === 'all'
    };

    if (calculationType === 'specific') {
      const employeeText = specificEmployeesInput.value.trim();
      if (!employeeText) {
        errorMessage.textContent = 'Please enter employee IDs';
        errorModal.classList.remove('hidden');
        return;
      }

      // Parse employee IDs
      const employees = employeeText
        .split(/[,\n]+/)
        .map(id => id.trim())
        .filter(id => id.length > 0);

      if (employees.length === 0) {
        errorMessage.textContent = 'Please enter valid employee IDs';
        errorModal.classList.remove('hidden');
        return;
      }

      requestBody.specificEmployees = employees;
    }

    loadingIndicator.classList.remove('hidden');

    try {
      const response = await fetch(`${API_BASE}/calculate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestBody)
      });

      const result = await response.json();
      loadingIndicator.classList.add('hidden');

      if (!result.success) {
        errorMessage.textContent = result.message || 'Calculation failed';
        errorModal.classList.remove('hidden');
        return;
      }

      // Update summary
      summaryEmployees.textContent = result.data.employeesProcessed;
      summaryCalculations.textContent = result.data.totalCalculations;
      summaryErrors.textContent = result.data.errorCount;
      calculationSummary.classList.remove('hidden');

      // Show success
      successMessage.textContent = `Successfully calculated payments for ${result.data.employeesProcessed} employees!`;
      successModal.classList.remove('hidden');

    } catch (error) {
      console.error('Calculation error:', error);
      loadingIndicator.classList.add('hidden');
      errorMessage.textContent = 'An error occurred during calculation';
      errorModal.classList.remove('hidden');
    }
  });

  // View Results
  viewResultsBtn.addEventListener('click', () => {
    currentResultsPage = 1;
    loadResults();
    resultsModal.classList.remove('hidden');
  });

  // Load Results
  async function loadResults() {
    try {
      const empno = searchEmployee.value.trim();
      const one_type = filterPaymentType.value;

      let url = `${API_BASE}/calculation-results?page=${currentResultsPage}&limit=${resultsPerPage}`;
      if (empno) url += `&empno=${encodeURIComponent(empno)}`;
      if (one_type) url += `&one_type=${encodeURIComponent(one_type)}`;

      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const result = await response.json();

      if (result.success) {
        displayResults(result.data);
        updatePagination(result.pagination);
      }
    } catch (error) {
      console.error('Error loading results:', error);
    }
  }

  // Display Results
  function displayResults(data) {
    if (data.length === 0) {
      resultsTableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center p-8 text-gray-500">No results found</td>
        </tr>
      `;
      return;
    }

    resultsTableBody.innerHTML = data.map(row => `
      <tr class="border-b hover:bg-gray-50">
        <td class="p-2">${row.his_empno}</td>
        <td class="p-2">${row.surname || ''} ${row.othername || ''}</td>
        <td class="p-2">${row.gradelevel || ''}</td>
        <td class="p-2">${row.his_type}</td>
        <td class="p-2">${row.one_desc || ''}</td>
        <td class="p-2 text-right font-semibold ${row.amtthismth < 0 ? 'text-red-600' : 'text-green-600'}">
          â‚¦${parseFloat(row.amtthismth).toLocaleString('en-NG', {minimumFractionDigits: 2})}
        </td>
      </tr>
    `).join('');
  }

  // Update Pagination
  function updatePagination(pagination) {
    currentPage.textContent = pagination.currentPage;
    totalPages.textContent = pagination.totalPages;
    currentRecords.textContent = pagination.currentPage * pagination.limit;
    totalRecords.textContent = pagination.totalRecords;

    prevPageBtn.disabled = pagination.currentPage === 1;
    nextPageBtn.disabled = pagination.currentPage === pagination.totalPages;
  }

  // Pagination buttons
  prevPageBtn.addEventListener('click', () => {
    if (currentResultsPage > 1) {
      currentResultsPage--;
      loadResults();
    }
  });

  nextPageBtn.addEventListener('click', () => {
    currentResultsPage++;
    loadResults();
  });

  // Search and filter
  refreshResultsBtn.addEventListener('click', () => {
    currentResultsPage = 1;
    loadResults();
  });

  searchEmployee.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      currentResultsPage = 1;
      loadResults();
    }
  });

  filterPaymentType.addEventListener('change', () => {
    currentResultsPage = 1;
    loadResults();
  });

  // Clear calculation
  clearCalculationBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to clear all calculation results?')) {
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/clear-calculation`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const result = await response.json();

      if (result.success) {
        calculationSummary.classList.add('hidden');
        successMessage.textContent = 'Calculation results cleared successfully';
        successModal.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error clearing calculation:', error);
      errorMessage.textContent = 'Failed to clear calculation results';
      errorModal.classList.remove('hidden');
    }
  });

  // Close modals
  successOkBtn.addEventListener('click', () => {
    successModal.classList.add('hidden');
  });

  errorOkBtn.addEventListener('click', () => {
    errorModal.classList.add('hidden');
  });

  closeResultsModal.addEventListener('click', () => {
    resultsModal.classList.add('hidden');
  });

  // Initialize
  loadPayrollClasses();
  fetchDatabaseName();
  loadPaymentTypes();
})();
</script>