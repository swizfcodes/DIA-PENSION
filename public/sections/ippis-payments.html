<!-- IPPIS PAYROLL IMPORT SECTION -->
<div id="section-ippis-import" class="p-6">
  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-2 justify-end mb-4">
    <!-- Search Bar -->
    <div class="relative">
      <input 
        type="text" 
        id="ippisSearchInput"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 pl-10"
        placeholder="Search by Period, Scv No..."
        autocomplete="off">
      <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </span>
      <button id="clearIppisSearchBtn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 hidden">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <button id="viewPeriodsBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      <i class="fas fa-calendar-alt mr-2"></i>View Periods
    </button>
    <button id="newIppisImportBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ New Import</button>
  </div>

  <!-- Import Form Section -->
  <div id="ippisImportDiv" class="hidden w-full max-w-2xl mx-auto rounded-2xl mb-6">
    <!-- Notes -->
    <div class="mb-6 bg-blue-50 p-4 rounded-lg">
      <h4 class="font-semibold text-blue-700 mb-2">Import Instructions:</h4>
      <ul class="list-disc list-inside text-gray-700 text-sm space-y-1">
        <li>CSV file must have Service Number as first column</li>
        <li>Subsequent columns should be payment type codes (BP001, PR001, etc.)</li>
        <li>Only employees in the selected payroll class will be imported</li>
        <li>Existing data for the period will be replaced</li>
        <li>File size limit: 10MB</li>
      </ul>
    </div>

    <!-- Import Form -->
    <form id="ippisImportForm" class="space-y-6 p-6 rounded-lg shadow">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="importYear" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
          <input type="number" id="importYear" min="2024" max="2050" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" 
            placeholder="2024" required />
        </div>
        
        <div>
          <label for="importMonth" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
          <select id="importMonth" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" 
            required>
            <option value="">Select Month...</option>
          </select>
        </div>

        <!--<div>
          <label for="payrollClass" class="block text-sm font-medium text-gray-700 mb-2">Payroll Class</label>
          <input type="text" id="payrollClass" 
            class="w-full border border-gray-300 bg-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" 
            placeholder="e.g., FEDERAL" required />
        </div>-->
      </div>

      <div>
        <label for="ippisFile" class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
        <input type="file" id="ippisFile" accept=".csv"
          class="block w-full border border-blue-300 bg-white rounded-lg px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <p class="text-xs text-gray-500 mt-2">
          Only <span class="font-semibold">.csv</span> files are allowed.
        </p>
      </div>

      <div class="flex justify-end gap-3">
        <button type="button" id="cancelIppisBtn"
          class="px-5 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg text-gray-800 font-medium">Cancel</button>
        <button type="button" id="validateIppisBtn"
          class="px-5 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-white font-medium">Validate</button>
        <button type="button" id="importIppisBtn" disabled
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">Import</button>
      </div>
    </form>
  </div>

  <!-- Validation Results Section -->
  <div id="validationResults" class="hidden w-full max-w-2xl mx-auto mb-6">
    <div class="p-6 rounded-lg shadow">
      <h3 class="text-lg font-bold text-green-600 mb-4">✅ Validation Successful</h3>
      
      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-blue-50 p-3 rounded text-center">
          <div class="text-2xl font-bold text-blue-600" id="val-totalRecords">0</div>
          <div class="text-xs text-gray-600">Total Records</div>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <div class="text-2xl font-bold text-green-600" id="val-validHeaders">0</div>
          <div class="text-xs text-gray-600">Valid Headers</div>
        </div>
        <div class="bg-yellow-50 p-3 rounded text-center">
          <div class="text-2xl font-bold text-yellow-600" id="val-invalidHeaders">0</div>
          <div class="text-xs text-gray-600">Invalid Headers</div>
        </div>
        <div class="bg-purple-50 p-3 rounded text-center">
          <div class="text-2xl font-bold text-purple-600" id="val-period">-</div>
          <div class="text-xs text-gray-600">Period</div>
        </div>
      </div>

      <!-- Warnings -->
      <div id="validationWarnings" class="hidden mb-4"></div>

      <!-- Sample Validation -->
      <div id="sampleValidation" class="mb-4">
        <h4 class="font-semibold text-gray-700 mb-2">Sample Employee Validation:</h4>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">Row</th>
                <th class="px-4 py-2 text-left">Svc No</th>
                <th class="px-4 py-2 text-left">Status</th>
              </tr>
            </thead>
            <tbody id="sampleValidationBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="text-sm text-gray-600">
        <p>✓ File is ready for import. Click "Import" button to proceed.</p>
      </div>
    </div>
  </div>

  <!-- Periods List Modal -->
  <div id="periodsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4 border-b pb-3">
        <h2 class="text-xl font-bold text-blue-600">Imported Periods</h2>
        <button id="closePeriodsBtn" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="periodsContent" class="space-y-4">
        <!-- Periods will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="ippisSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full text-center">
      <div id="ippisSuccessIcon" class="mb-3 flex items-center justify-center">
        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round"
          d="M5 13l4 4L19 7" /></svg>
      </div>
      <h2 id="ippisSuccessTitle" class="text-xl font-bold text-green-600 mb-2">Success</h2>
      <p id="ippisSuccessMessage" class="text-gray-600 mb-4">Action completed successfully.</p>
      <div id="ippisImportSummary" class="hidden text-left bg-gray-50 rounded-lg p-4 mb-4 text-sm">
        <p class="font-semibold mb-2">Import Summary:</p>
        <p>Period: <span id="sum-period" class="font-medium">-</span></p>
        <p>Total Records: <span id="sum-totalRecords" class="font-medium">0</span></p>
        <p>Processed Employees: <span id="sum-processedEmployees" class="font-medium">0</span></p>
        <p>Inserted Records: <span id="sum-insertedRecords" class="font-medium text-green-600">0</span></p>
        <p>Updated Records: <span id="sum-updatedRecords" class="font-medium text-blue-600">0</span></p>
        <p>Skipped Employees: <span id="sum-skippedEmployees" class="font-medium text-yellow-600">0</span></p>
        <p>Errors: <span id="sum-totalErrors" class="font-medium text-red-600">0</span></p>
      </div>
      <button id="closeIppisModalBtn"
        class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">OK</button>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="ippisErrorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl w-full">
      <h2 class="text-xl font-bold text-red-600 mb-4">Import Errors</h2>
      <div id="ippisErrorContent" class="text-gray-700 text-sm max-h-96 overflow-y-auto"></div>
      <div class="flex justify-end mt-4">
        <button id="closeIppisErrorBtn"
          class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div id="ippisViewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b">
              <h2 class="text-xl font-bold text-blue-600">Period Details</h2>
              <button id="closeIppisViewBtn" class="text-gray-400 hover:text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
              </button>
          </div>

          <div id="ippisViewContent" class="flex-1 overflow-y-auto p-6 text-gray-700 text-sm">
              <div class="h-[1000px] bg-gray-50 p-4"> 
                  Scrolling content starts here... 
              </div>
          </div>

          <div class="flex justify-end gap-3 p-6 border-t bg-white">
              <button id="exportPeriodBtn" data-period=""
                  class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                  <i class="fas fa-download mr-2"></i>Export CSV
              </button>
              <button id="deletePeriodBtn" data-period=""
                  class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">
                  <i class="fas fa-trash mr-2"></i>Delete Period
              </button>
              <button id="closeIppisViewBtnBottom"
                  class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Close</button>
          </div>
      </div>
  </div>

  <!-- Main Data Table Section -->
  <div class="overflow-x-auto border rounded-lg shadow-sm">
    <table class="min-w-full border-collapse">
      <thead class="bg-blue-100 text-gray-700 text-sm">
        <tr>
          <th class="border px-4 py-2 text-center">Period</th>
          <th class="border px-4 py-2 text-center">Records</th>
          <th class="border px-4 py-2 text-center">Record Count</th>
          <th class="border px-4 py-2 text-center">Total Amount</th>
          <th class="border px-4 py-2 text-center">Import Date</th>
          <th class="border px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="ippisTableBody" class="text-sm text-center">
        <!-- Dynamic rows will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="m-6 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      Showing <span id="ippisStartRecord">0</span> to <span id="ippisEndRecord">0</span> of <span id="ippis TotalRecords">0</span> records
    </div>
    <div class="flex items-center space-x-2">
      <select id="ippisRecordsPerPage" class="border border-gray-300 rounded px-2 py-1 text-sm">
        <option value="10">10 per page</option>
        <option value="25">25 per page</option>
        <option value="50">50 per page</option>
        <option value="100">100 per page</option>
      </select>
      <button id="ippis PrevPage" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 disabled:opacity-50">
        Previous
      </button>
      <span class="text-sm">
        Page <span id="ippisCurrentPage">1</span> of <span id="ippis TotalPages">1</span>
      </span>
      <button id="ippisNextPage" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 disabled:opacity-50">
        Next
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  // Configuration
  const API_BASE_URL = '/ippis'; // Adjust to match your route
  const authToken = localStorage.getItem('token');

  // State
  let validationData = null;
  let currentPeriodData = null;
  let allPeriodsData = [];
  let filteredPeriodsData = [];

  // DOM Elements
  const newImportBtn = document.getElementById('newIppisImportBtn');
  const viewPeriodsBtn = document.getElementById('viewPeriodsBtn');
  const importDiv = document.getElementById('ippisImportDiv');
  const importForm = document.getElementById('ippisImportForm');
  const cancelBtn = document.getElementById('cancelIppisBtn');
  const validateBtn = document.getElementById('validateIppisBtn');
  const importBtn = document.getElementById('importIppisBtn');
  const fileInput = document.getElementById('ippisFile');
  const yearInput = document.getElementById('importYear');
  const monthSelect = document.getElementById('importMonth');
  const payrollClassInput = document.getElementById('payrollClass');
  
  // Validation Results
  const validationResults = document.getElementById('validationResults');
  
  // Modals
  const successModal = document.getElementById('ippisSuccessModal');
  const errorModal = document.getElementById('ippisErrorModal');
  const viewModal = document.getElementById('ippisViewModal');
  const periodsModal = document.getElementById('periodsModal');
  
  // Table
  const tableBody = document.getElementById('ippisTableBody');
  
  // Pagination
  let currentPage = 1;
  let recordsPerPage = 10;
  let totalRecords = 0;
  let totalPages = 1;

  // Set current year by default
  yearInput.value = new Date().getFullYear();

  // ============================================
  // LOAD MONTHS
  // ============================================
  async function loadMonths() {
    try {
      const response = await fetch(`${API_BASE_URL}/months`, {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        monthSelect.innerHTML = '<option value="">Select Month...</option>';
        result.data.forEach(month => {
          const option = document.createElement('option');
          option.value = month.mthdesc;
          option.textContent = month.mthdesc;
          monthSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading months:', error);
    }
  }

  // ============================================
  // LOAD PERIODS
  // ============================================
  async function loadPeriods() {
    try {
      const response = await fetch(`${API_BASE_URL}/periods`, {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        allPeriodsData = result.data || [];
        currentPage = 1;
        applyPaginationAndSearch();
      }
    } catch (error) {
      console.error('Error loading periods:', error);
      showError('Failed to load periods');
    }
  }

  // ============================================
  // RENDER PERIODS TABLE
  // ============================================
  function renderPeriodsTable(data) {
    tableBody.innerHTML = '';
    
    if (!data || data.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="py-4 text-gray-500">No periods found</td>
        </tr>
      `;
      return;
    }

    data.forEach(period => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-yellow-50';
      row.innerHTML = `
        <td class="py-2 px-4 border font-semibold">${formatPeriod(period.period)}</td>
        <td class="py-2 px-4 border">${period.employee_count || 0}</td>
        <td class="py-2 px-4 border">${period.record_count || 0}</td>
        <td class="py-2 px-4 border">₦${Number(period.total_amount || 0).toLocaleString()}</td>
        <td class="py-2 px-4 border">${formatDate(period.import_date)}</td>
        <td class="py-2 px-4 border">
          <button class="view-period-btn text-blue-600 hover:underline mr-2" data-period="${period.period}">
            View
          </button>
          <button class="summary-btn text-green-600 hover:underline" data-period="${period.period}">
            Summary
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Add event listeners
    document.querySelectorAll('.view-period-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const period = e.target.getAttribute('data-period');
        viewPeriodDetails(period);
      });
    });

    document.querySelectorAll('.summary-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const period = e.target.getAttribute('data-period');
        viewPeriodSummary(period);
      });
    });
  }

  function applyPaginationAndSearch() {
    const searchTerm = document.getElementById('ippisSearchInput').value.toLowerCase();
    const clearBtn = document.getElementById('clearIppisSearchBtn');
    
    // Show/hide clear button
    if (searchTerm) {
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
    }
    
    // Filter data
    filteredPeriodsData = allPeriodsData.filter(period => {
      const periodText = formatPeriod(period.period).toLowerCase();
      const amount = period.total_amount?.toString() || '';
      return periodText.includes(searchTerm) || amount.includes(searchTerm);
    });
    
    // Calculate pagination
    totalRecords = filteredPeriodsData.length;
    totalPages = Math.ceil(totalRecords / recordsPerPage) || 1;
    currentPage = Math.min(currentPage, totalPages);
    
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
    const paginatedData = filteredPeriodsData.slice(startIndex, endIndex);
    
    // Update UI
    renderPeriodsTable(paginatedData);
    updatePaginationUI();
  }

  function updatePaginationUI() {
    const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * recordsPerPage + 1;
    const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
    
    document.getElementById('ippisStartRecord').textContent = startRecord;
    document.getElementById('ippisEndRecord').textContent = endRecord;
    document.getElementById('ippis TotalRecords').textContent = totalRecords;
    document.getElementById('ippisCurrentPage').textContent = currentPage;
    document.getElementById('ippis TotalPages').textContent = totalPages;
    
    // Enable/disable pagination buttons
    document.getElementById('ippis PrevPage').disabled = currentPage === 1;
    document.getElementById('ippisNextPage').disabled = currentPage === totalPages;
  }
  // ============================================
  // VALIDATE FILE
  // ============================================
  async function validateFile() {
    const file = fileInput.files[0];
    const year = yearInput.value;
    const month = monthSelect.value;

    if (!file || !year || !month) {
      showError('Please fill all fields and select a file');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('year', year);
    formData.append('month', month);

    showLoading('Validating file...');

    try {
      const response = await fetch(`${API_BASE_URL}/validate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authToken}`
        },
        body: formData
      });

      const result = await response.json();
      hideLoading();

      if (result.success) {
        validationData = result.data;
        showValidationResults(result.data);
        importBtn.disabled = false;
      } else {
        // FIX: Show detailed error information
        const errorMessage = result.error || result.message || 'Validation failed';
        
        // If there are detailed errors, show them
        if (result.details) {
          showError([
            errorMessage,
            result.details.message || '',
            result.details.invalidHeaders ? `Invalid headers: ${result.details.invalidHeaders.join(', ')}` : ''
          ].filter(Boolean));
        } else {
          showError(errorMessage);
        }
      }
    } catch (error) {
      hideLoading();
      console.error('Validation error:', error);
      showError('Validation failed: ' + error.message);
    }
  }
  // ============================================
  // SHOW VALIDATION RESULTS
  // ============================================
  function showValidationResults(data) {
    if (data.headers.valid.length === 0) {
      showError('No valid payment type headers found in the CSV file. Please check your file format.');
      importBtn.disabled = true;
      validationResults.classList.add('hidden');
      return;
    }

    document.getElementById('val-totalRecords').textContent = data.totalRecords;
    document.getElementById('val-validHeaders').textContent = data.headers.valid.length;
    document.getElementById('val-invalidHeaders').textContent = data.headers.invalid.length;
    document.getElementById('val-period').textContent = formatPeriod(data.period);

    // Show warnings
    const warningsDiv = document.getElementById('validationWarnings');
    if (data.warnings && data.warnings.length > 0) {
      warningsDiv.classList.remove('hidden');
      warningsDiv.innerHTML = `
        <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
          <p class="font-semibold text-yellow-700 mb-2">Warnings:</p>
          ${data.warnings.map(w => `<p class="text-sm text-yellow-600">⚠️ ${w}</p>`).join('')}
        </div>
      `;
    } else {
      warningsDiv.classList.add('hidden');
    }

    // Show sample validation
    const sampleBody = document.getElementById('sampleValidationBody');
    sampleBody.innerHTML = '';
    
    data.sampleValidation.forEach(sample => {
      const row = document.createElement('tr');
      row.className = sample.exists ? 'bg-green-50' : 'bg-red-50';
      row.innerHTML = `
        <td class="px-4 py-2">${sample.rowNumber}</td>
        <td class="px-4 py-2">${sample.employeeId}</td>
        <td class="px-4 py-2">${sample.exists ? '✅ Found' : '❌ Not Found'}</td>
      `;
      sampleBody.appendChild(row);
    });

    validationResults.classList.remove('hidden');
    importDiv.scrollIntoView({ behavior: 'smooth' });
  }

  // ============================================
  // IMPORT FILE
  // ============================================
  async function importFile() {
    if (!validationData) {
      showError('Please validate file first');
      return;
    }

    const file = fileInput.files[0];
    const year = yearInput.value;
    const month = monthSelect.value;
    const payrollClass = payrollClassInput.value;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('year', year);
    formData.append('month', month);
    formData.append('payrollClass', payrollClass);
    formData.append('deleteExisting', 'true');

    showLoading('Importing data...');

    try {
      const response = await fetch(`${API_BASE_URL}/import`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authToken}`
        },
        body: formData
      });

      const result = await response.json();
      hideLoading();

      if (result.success) {
        showImportSuccess(result.data, result.message);
        resetForm();
        await loadPeriods();
      } else {
        showError(result.message || 'Import failed');
      }
    } catch (error) {
      hideLoading();
      console.error('Import error:', error);
      showError('Import failed: ' + error.message);
    }
  }

  // ============================================
  // VIEW PERIOD DETAILS
  // ============================================
  async function viewPeriodDetails(period) {
    showLoading('Loading period details...');

    try {
      const response = await fetch(`${API_BASE_URL}/history/${period}?limit=100`, {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });

      const result = await response.json();
      hideLoading();

      if (result.success) {
        showPeriodDetailsModal(period, result.data);
      } else {
        showError('Failed to load period details');
      }
    } catch (error) {
      hideLoading();
      console.error('Error loading period details:', error);
      showError('Error loading period details');
    }
  }

  // ============================================
  // VIEW PERIOD SUMMARY
  // ============================================
  async function viewPeriodSummary(period) {
    showLoading('Loading period summary...');

    try {
      const response = await fetch(`${API_BASE_URL}/summary/${period}`, {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });

      const result = await response.json();
      hideLoading();

      if (result.success) {
        showPeriodSummaryModal(result.data);
      } else {
        showError('Failed to load period summary');
      }
    } catch (error) {
      hideLoading();
      console.error('Error loading period summary:', error);
      showError('Error loading period summary');
    }
  }

  // ============================================
  // SHOW PERIOD DETAILS MODAL
  // ============================================
  function showPeriodDetailsModal(period, data) {
    const viewContent = document.getElementById('ippisViewContent');
    
    let html = `
      <div class="mb-4 flex gap-4 items-center justify-between">
        <h3 class="text-lg font-semibold">Period: ${formatPeriod(period)}</h3>
        <p class="text-sm text-gray-600">Showing first 100 records</p>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-blue-100">
            <tr>
              <th class="px-3 py-2 text-left">Svc No.</th>
              <th class="px-3 py-2 text-left">Name</th>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Description</th>
              <th class="px-3 py-2 text-right">Amount</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Category</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.records.forEach(record => {
      html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-3 py-2">${record.numb}</td>
          <td class="px-3 py-2 text-[9px] font-bold">${record.Surname || ''} ${record.OtherName || ''}</td>
          <td class="px-3 py-2">${record.Type}</td>
          <td class="px-3 py-2">${record.bp || '-'}</td>
          <td class="px-3 py-2 text-right">₦${Number(record.bpm || 0).toLocaleString()}</td>
          <td class="px-3 py-2">
            <span class="px-1 py-1 rounded font-semibold text-[9px] ${getCategoryClass(record.bpa)}">
              ${record.bpa || '-'}
            </span>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;

    viewContent.innerHTML = html;
    document.getElementById('exportPeriodBtn').setAttribute('data-period', period);
    document.getElementById('deletePeriodBtn').setAttribute('data-period', period);
    viewModal.classList.remove('hidden');
  }

  // ============================================
  // SHOW PERIOD SUMMARY MODAL
  // ============================================
  function showPeriodSummaryModal(data) {
    const viewContent = document.getElementById('ippisViewContent');
    
    let html = `
      <div class="mb-6">
        <div class="mb-4 flex gap-4 items-center">
          <h3 class="text-lg font-semibold">Period: ${formatPeriod(data.period)}</h3>
          <p class="text-lg text-gray-600">Total Employees: 
            <span class="font-semibold text-lg text-blue-600">${data.totalEmployees}</span>
          </p>
        </div>

        <h4 class="font-semibold mb-3">Category Totals:</h4>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    `;

    data.categoryTotals.forEach(cat => {
      html += `
        <div class="bg-gray-50 p-4 rounded border">
          <div class="text-sm font-semibold text-gray-700">${cat.category  || 'LOANS'}</div>
          <div class="text-lg font-bold text-blue-600">₦${Number(cat.total_amount || 0).toLocaleString()}</div>
          <div class="text-xs text-gray-500">${cat.record_count} records</div>
        </div>
      `;
    });

    html += `
        </div>

        <h4 class="font-semibold mb-3">Top 10 Payment Types:</h4>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-blue-100">
              <tr>
                <th class="px-3 py-2 text-left">Type</th>
                <th class="px-3 py-2 text-left">Description</th>
                <th class="px-3 py-2 text-right">Records</th>
                <th class="px-3 py-2 text-right">Total Amount</th>
                <th class="px-3 py-2 text-right">Average</th>
              </tr>
            </thead>
            <tbody>
    `;

    data.topPayments.forEach(payment => {
      html += `
        <tr class="border-b">
          <td class="px-3 py-2">${payment.type}</td>
          <td class="px-3 py-2">${payment.description}</td>
          <td class="px-3 py-2 text-right">${payment.employee_count}</td>
          <td class="px-3 py-2 text-right">₦${Number(payment.total_amount || 0).toLocaleString()}</td>
          <td class="px-3 py-2 text-right">₦${Number(payment.average_amount || 0).toLocaleString()}</td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    viewContent.innerHTML = html;
    document.getElementById('exportPeriodBtn').style.display = 'none';
    document.getElementById('deletePeriodBtn').style.display = 'none';
    viewModal.classList.remove('hidden');
  }

  // ============================================
  // EXPORT PERIOD
  // ============================================
  async function exportPeriod(period) {
    try {
      const response = await fetch(`${API_BASE_URL}/export/${period}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ format: 'csv' })
      });

      if (!response.ok) throw new Error('Export failed');

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `payroll_${period}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Export error:', error);
      showError('Failed to export period');
    }
  }

  // ============================================
  // DELETE PERIOD
  // ============================================
  async function deletePeriod(period) {
    if (!confirm(`Are you sure you want to delete all data for period ${formatPeriod(period)}? This action cannot be undone.`)) {
      return;
    }

    showLoading('Deleting period...');

    try {
      const response = await fetch(`${API_BASE_URL}/period/${period}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });

      const result = await response.json();
      hideLoading();

      if (result.success) {
        viewModal.classList.add('hidden');
        showSuccess('Period Deleted', result.message);
        await loadPeriods();
      } else {
        showError(result.message || 'Delete failed');
      }
    } catch (error) {
      hideLoading();
      console.error('Delete error:', error);
      showError('Failed to delete period');
    }
  }

  // ============================================
  // HELPER FUNCTIONS
  // ============================================
  function formatPeriod(period) {
    if (!period || period.length !== 6) return period;
    const year = period.substring(0, 4);
    const month = period.substring(4, 6);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[parseInt(month) - 1]} ${year}`;
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-NG', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  function getCategoryClass(category) {
    switch(category) {
      case 'TAXABLE PAYMENT':
        return 'bg-blue-100 text-blue-800';
      case 'NON-TAXABLE PAY':
        return 'bg-green-100 text-green-800';
      case 'DEDUCTIONS':
        return 'bg-red-100 text-red-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  }

  function showLoading(message = 'Processing...') {
    const icon = document.getElementById('ippisSuccessIcon');
    const title = document.getElementById('ippisSuccessTitle');
    const msg = document.getElementById('ippisSuccessMessage');
    const summary = document.getElementById('ippisImportSummary');
    
    icon.innerHTML = '<div class="h-8 w-8 border-4 border-blue-300 border-t-blue-600 rounded-full animate-spin"></div>';
    title.textContent = 'Please Wait';
    msg.textContent = message;
    summary.classList.add('hidden');
    successModal.classList.remove('hidden');
  }

  function hideLoading() {
    successModal.classList.add('hidden');
  }

  function showSuccess(title, message) {
    const icon = document.getElementById('ippisSuccessIcon');
    const titleEl = document.getElementById('ippisSuccessTitle');
    const msgEl = document.getElementById('ippisSuccessMessage');
    const summary = document.getElementById('ippisImportSummary');
    
    icon.innerHTML = '<svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
    titleEl.textContent = title;
    msgEl.textContent = message;
    summary.classList.add('hidden');
    successModal.classList.remove('hidden');
  }

  function showImportSuccess(data, message) {
    const icon = document.getElementById('ippisSuccessIcon');
    const title = document.getElementById('ippisSuccessTitle');
    const msg = document.getElementById('ippisSuccessMessage');
    const summary = document.getElementById('ippisImportSummary');
    
    icon.innerHTML = '<svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
    title.textContent = 'Import Complete';
    msg.textContent = message;
    
    document.getElementById('sum-period').textContent = formatPeriod(data.period);
    document.getElementById('sum-totalRecords').textContent = data.totalRecords;
    document.getElementById('sum-processedEmployees').textContent = data.processedEmployees;
    document.getElementById('sum-insertedRecords').textContent = data.insertedRecords;
    document.getElementById('sum-updatedRecords').textContent = data.updatedRecords;
    document.getElementById('sum-skippedEmployees').textContent = data.skippedEmployees;
    document.getElementById('sum-totalErrors').textContent = data.totalErrors;
    
    summary.classList.remove('hidden');
    successModal.classList.remove('hidden');
  }

  function showError(message) {
    const errorContent = document.getElementById('ippisErrorContent');
    
    let html = '<div class="space-y-2">';
    
    if (typeof message === 'string') {
      html += `
        <div class="bg-red-50 border border-red-200 rounded p-3">
          <p class="text-sm text-red-600">${message}</p>
        </div>
      `;
    } else if (Array.isArray(message)) {
      message.forEach((err, index) => {
        html += `
          <div class="bg-red-50 border border-red-200 rounded p-3">
            <p class="font-semibold text-red-700">Error ${index + 1}:</p>
            ${err.row ? `<p class="text-sm">Row: ${err.row}</p>` : ''}
            ${err.employeeId ? `<p class="text-sm">Svc No.: ${err.employeeId}</p>` : ''}
            <p class="text-sm text-red-600">${err.error || err}</p>
          </div>
        `;
      });
    }
    html += '</div>';
    
    errorContent.innerHTML = html;
    errorModal.classList.remove('hidden');
  }

  function resetForm() {
    importForm.reset();
    fileInput.value = '';
    yearInput.value = new Date().getFullYear();
    validationData = null;
    validationResults.classList.add('hidden');
    importDiv.classList.add('hidden');
    importBtn.disabled = true;
  }

  // ============================================
  // EVENT LISTENERS
  // ============================================
  newImportBtn.addEventListener('click', () => {
    importDiv.classList.remove('hidden');
    importForm.scrollIntoView({ behavior: 'smooth' });
  });

  cancelBtn.addEventListener('click', resetForm);
  validateBtn.addEventListener('click', validateFile);
  importBtn.addEventListener('click', importFile);

  document.getElementById('closeIppisModalBtn').addEventListener('click', () => {
    successModal.classList.add('hidden');
  });

  document.getElementById('closeIppisErrorBtn').addEventListener('click', () => {
    errorModal.classList.add('hidden');
  });

  document.getElementById('closeIppisViewBtn').addEventListener('click', () => {
    viewModal.classList.add('hidden');
  });

  document.getElementById('closeIppisViewBtnBottom').addEventListener('click', () => {
    viewModal.classList.add('hidden');
  });

  document.getElementById('exportPeriodBtn').addEventListener('click', (e) => {
    const period = e.target.getAttribute('data-period');
    exportPeriod(period);
  });

  document.getElementById('deletePeriodBtn').addEventListener('click', (e) => {
    const period = e.target.getAttribute('data-period');
    deletePeriod(period);
  });

  viewPeriodsBtn.addEventListener('click', async () => {
    showLoading('Loading periods...');
    try {
      const response = await fetch(`${API_BASE_URL}/periods`, {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });
      
      const result = await response.json();
      hideLoading();
      
      if (result.success) {
        showPeriodsModal(result.data);
      }
    } catch (error) {
      hideLoading();
      showError('Failed to load periods');
    }
  });

  function showPeriodsModal(periods) {
    const content = document.getElementById('periodsContent');
    
    if (!periods || periods.length === 0) {
      content.innerHTML = '<p class="text-gray-500 text-center">No periods found</p>';
    } else {
      let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      periods.forEach(period => {
        html += `
          <div class="bg-gray-50 p-4 rounded-lg border hover:border-blue-500 transition">
            <div class="flex justify-between items-start mb-2">
              <div class="text-lg font-bold text-blue-600">${formatPeriod(period.period)}</div>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${period.record_count} records</span>
            </div>
            <div class="text-sm text-gray-600 space-y-1">
              <p>Records: <span class="font-semibold">${period.employee_count}</span></p>
              <p>Total Amount: <span class="font-semibold">₦${Number(period.total_amount || 0).toLocaleString()}</span></p>
              <p>Date Imported: <span class="font-semibold">${formatDate(period.import_date)}</span></p>
            </div>
            <div class="mt-3 flex gap-2">
              <button class="view-period-modal-btn flex-1 text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" 
                      data-period="${period.period}">View</button>
              <button class="summary-modal-btn flex-1 text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" 
                      data-period="${period.period}">Summary</button>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      content.innerHTML = html;

      // Add event listeners
      document.querySelectorAll('.view-period-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const period = e.target.getAttribute('data-period');
          periodsModal.classList.add('hidden');
          viewPeriodDetails(period);
        });
      });

      document.querySelectorAll('.summary-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const period = e.target.getAttribute('data-period');
          periodsModal.classList.add('hidden');
          viewPeriodSummary(period);
        });
      });
    }
    
    periodsModal.classList.remove('hidden');
  }

  document.getElementById('closePeriodsBtn').addEventListener('click', () => {
    periodsModal.classList.add('hidden');
  });

  // Search functionality
  document.getElementById('ippisSearchInput').addEventListener('input', () => {
    currentPage = 1;
    applyPaginationAndSearch();
  });

  document.getElementById('clearIppisSearchBtn').addEventListener('click', () => {
    document.getElementById('ippisSearchInput').value = '';
    currentPage = 1;
    applyPaginationAndSearch();
  });

  // Pagination controls
  document.getElementById('ippisRecordsPerPage').addEventListener('change', (e) => {
    recordsPerPage = parseInt(e.target.value);
    currentPage = 1;
    applyPaginationAndSearch();
  });

  document.getElementById('ippis PrevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      applyPaginationAndSearch();
    }
  });

  document.getElementById('ippisNextPage').addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      applyPaginationAndSearch();
    }
  });

  // ============================================
  // INITIALIZE
  // ============================================
  (async function init() {
    try {
      await loadMonths();
      await loadPeriods();
    } catch (error) {
      console.error('Initialization error:', error);
    }
  })();
})();
</script>