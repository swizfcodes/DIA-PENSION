<!-- Master File Update Section -->
<div class="p-6">
  <!-- Top Action Bar (Hidden after first update, shown only when stage < 888) -->
  <div id="topActionBarUpdate" class="hidden mb-6 w-full flex justify-between items-center border-b-2 pb-4 no-print">
    <h2 class="text-green-600 font-semibold lg:text-lg">
      <i class="fas fa-info-circle mr-2"></i>First ensure you have printed Input Variable Reports
    </h2>
    <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('input-variable-report', 'Input Variable Report')" 
            class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
      <i class="fas fa-file-alt mr-2"></i>Input Variable Report
    </button>
  </div>

  <!-- Main Content Section -->
  <div id="updateMainContent">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-3">
        <div class="bg-yellow-500 text-white p-3 rounded-full shadow">
          <i class="fas fa-folder text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-green-800">Update Master File</h2>
      </div>
    </div>

    <p class="text-gray-600 font-semibold lg:text-lg mb-6">
      Update master file records with the latest payroll data for all employees.
    </p>

    <!-- Action Button (Hidden after successful update) -->
    <div id="updateActionContainer" class="flex justify-center">
      <button id="openUpdateModalBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
        <i class="fas fa-sync-alt mr-2"></i>Update Master File
      </button>
    </div>
  </div>

  <!-- Success Confirmation (Hidden initially, shown after successful update) -->
  <div id="saveConfirm" class="my-6 hidden text-center">
    <div class="flex justify-center mb-3">
      <div class="bg-blue-500 text-white p-3 rounded-full shadow">
        <i class="fas fa-check-circle text-3xl"></i>
      </div>
    </div>
    <h3 class="text-blue-700 font-bold text-xl mb-2">Master File Updated Successfully!</h3>
    <p class="text-blue-600 font-semibold mb-4">All payroll master files have been updated. You can now proceed to Payroll Calculations.</p>
    
    <!-- Summary Stats -->
    <!--<div id="updateSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 max-w-3xl mx-auto">
      <div class="p-4 bg-green-50 rounded-lg border border-green-200">
        <div class="text-green-600 text-sm font-medium">Employees Processed</div>
        <div id="summaryEmployees" class="text-3xl font-bold text-green-900">0</div>
      </div>
      <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="text-blue-600 text-sm font-medium">Total Records</div>
        <div id="summaryRecords" class="text-3xl font-bold text-blue-900">0</div>
      </div>
      <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
        <div class="text-purple-600 text-sm font-medium">Total Amount</div>
        <div id="summaryAmount" class="text-3xl font-bold text-purple-900">₦0.00</div>
      </div>
    </div>-->
        
    <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('payroll-calculations', 'Payroll Calculations')" 
            class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
      <i class="fas fa-calculator mr-2"></i>Proceed to Payroll calculations
    </button>
  </div>

  <!-- Performance Log (Hidden until update is run) -->
  <!--<div id="performanceLog" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
      <i class="fas fa-chart-line mr-2 text-green-600"></i>Performance Details
    </h4>
    <div id="performanceLogContent" class="space-y-2 text-sm text-gray-700"></div>
  </div>-->
</div>

<!-- Confirmation Modal -->
<div id="updateModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
  <div class="bg-white w-11/12 md:w-2/5 rounded-xl shadow-lg overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center bg-green-600 text-white px-4 py-3">
      <h3 class="text-lg font-semibold">
        <i class="fas fa-database mr-2"></i>Confirm Master File Update
      </h3>
      <button id="closeUpdateModalBtn" class="text-white hover:text-gray-200 text-xl">✖</button>
    </div>

    <!-- Body -->
    <div class="p-4">
      <div class="mb-4 p-2 bg-yellow-50 ">
        <p class="text-yellow-800 font-semibold flex items-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>Important: This action will update all master payroll files
        </p>
      </div>
      
      <p class="text-gray-700 font-semibold mb-4">
        Are you sure you want to update the <span class="font-bold text-green-600">Master File</span> with the latest payroll changes?
      </p>
      
      <ul class="text-sm text-gray-600 space-y-2 mb-4 ml-4">
        <li class="flex items-start">
          <i class="fas fa-check-circle text-blue-500 mr-2 mt-1"></i>
          <span>All employee master records will be updated</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-check-circle text-blue-500 mr-2 mt-1"></i>
          <span>Cumulative data will be transferred</span>
        </li>
      </ul>
      
      <div id="updateStatus" class="hidden mt-4 p-3 rounded-lg"></div>
    </div>

    <!-- Footer -->
    <div class="flex justify-end space-x-3 bg-gray-100 px-4 py-3">
      <button id="cancelUpdateBtn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition">
        Cancel
      </button>
      <button id="confirmUpdateBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
        Yes, Update Master File
      </button>
    </div>
  </div>
</div>

<!-- Progress Modal -->
<div id="updateProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
    <div class="text-center">
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center">
          <i class="fas fa-database text-white text-3xl"></i>
        </div>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Updating Master Files...</h3>
      <p id="updateProgressMessage" class="text-gray-600 mb-6">Please wait while we process your request...</p>
      
      <!-- Progress Bar -->
      <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
        <div id="progressBar" class="bg-green-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
      </div>
      <div id="progressPercent" class="text-sm text-gray-500 mb-4">0%</div>
    </div>
  </div>
</div>

<!-- Alert Modal -->
<div id="updateAlertModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
    <div class="text-center">
      <div id="updateAlertIcon" class="flex justify-center mb-4">
        <i class="fas fa-exclamation-circle text-red-500 text-6xl"></i>
      </div>
      <h3 id="updateAlertTitle" class="text-xl font-semibold text-gray-900 mb-2">Error</h3>
      <p id="updateAlertMessage" class="text-gray-600 mb-6">An error occurred</p>
      <button id="updateAlertCloseBtn" class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition">
        <i class="fas fa-times mr-2"></i>Close
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  // API Configuration
  const API_BASE = '/masterfile';
  const STATUS_API = '/status-payroll';

  // BT05 Stages
  const STAGE_DATA_ENTRY_OPEN = 0;
  const STAGE_CLOSED = 666;
  const STAGE_CHANGES_READY = 775;
  const STAGE_INPUT_VAR_READY = 777;
  const STAGE_UPDATE_COMPLETED = 888;
  const STAGE_CALC_COMPLETED = 999;

  // State
  let currentPayrollStage = STAGE_DATA_ENTRY_OPEN;
  let hasUpdatedOnce = false;

  // DOM Elements
  const topActionBarUpdate = document.getElementById('topActionBarUpdate');
  const updateMainContent = document.getElementById('updateMainContent');
  const updateActionContainer = document.getElementById('updateActionContainer');
  const saveConfirm = document.getElementById('saveConfirm');
  //const performanceLog = document.getElementById('performanceLog');
  //const performanceLogContent = document.getElementById('performanceLogContent');
  //const updateSummary = document.getElementById('updateSummary');
  //const summaryEmployees = document.getElementById('summaryEmployees');
  //const summaryRecords = document.getElementById('summaryRecords');
  //const summaryAmount = document.getElementById('summaryAmount');

  // Modal Elements
  const modal = document.getElementById('updateModal');
  const openBtn = document.getElementById('openUpdateModalBtn');
  const closeBtn = document.getElementById('closeUpdateModalBtn');
  const cancelBtn = document.getElementById('cancelUpdateBtn');
  const confirmBtn = document.getElementById('confirmUpdateBtn');
  const statusEl = document.getElementById('updateStatus');

  // Progress Modal Elements
  const progressModal = document.getElementById('updateProgressModal');
  const progressMessage = document.getElementById('updateProgressMessage');
  const progressSteps = document.getElementById('progressSteps');
  const logContainer = document.getElementById('updateLogContainer');

  // Alert Modal Elements
  const alertModal = document.getElementById('updateAlertModal');
  const alertTitle = document.getElementById('updateAlertTitle');
  const alertMessage = document.getElementById('updateAlertMessage');
  const alertIcon = document.getElementById('updateAlertIcon');
  const alertCloseBtn = document.getElementById('updateAlertCloseBtn');

  // Helper Functions
  function addLog(message, type = 'info') {
    const log = document.createElement('div');
    log.className = `py-1 ${type === 'success' ? 'text-blue-600' : type === 'error' ? 'text-red-600' : 'text-gray-600'}`;
    log.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'circle'} mr-2"></i>${message}`;
    logContainer.appendChild(log);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  function updateProgressStep(stepNumber, status = 'processing') {
    const step = document.getElementById(`step${stepNumber}`);
    if (!step) return;

    const icon = step.querySelector('i');
    const text = step.querySelector('span');

    if (status === 'processing') {
      step.className = 'flex items-center text-green-600 font-semibold';
      icon.className = 'fas fa-circle-notch fa-spin mr-2';
    } else if (status === 'completed') {
      step.className = 'flex items-center text-blue-600';
      icon.className = 'fas fa-check-circle mr-2';
    } else if (status === 'error') {
      step.className = 'flex items-center text-red-600';
      icon.className = 'fas fa-times-circle mr-2';
    }
  }

  function showAlert(title, message, type = 'error') {
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    const iconClass = type === 'success' 
      ? 'fa-check-circle text-blue-500' 
      : type === 'warning' 
      ? 'fa-exclamation-triangle text-yellow-500' 
      : 'fa-exclamation-circle text-red-500';
    alertIcon.innerHTML = `<i class="fas ${iconClass} text-6xl"></i>`;
    alertModal.classList.remove('hidden');
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-NG', {
      style: 'currency',
      currency: 'NGN',
      minimumFractionDigits: 2
    }).format(amount);
  }


  function updateUIVisibility() {
    // Determine what to show based on stage and update status
    if (hasUpdatedOnce || currentPayrollStage >= STAGE_UPDATE_COMPLETED) {
      // Update completed: hide top bar and button, show success
      topActionBarUpdate.classList.add('hidden');
      updateActionContainer.classList.add('hidden');
      saveConfirm.classList.remove('hidden');
      //performanceLog.classList.remove('hidden');
    } else if (currentPayrollStage >= STAGE_INPUT_VAR_READY) {
      // Ready to update: hide top bar, show button enabled
      topActionBarUpdate.classList.add('hidden');
      updateMainContent.classList.remove('hidden');
      updateActionContainer.classList.remove('hidden');
      saveConfirm.classList.add('hidden');
      //performanceLog.classList.add('hidden');
      openBtn.disabled = false;
      openBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      openBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Update Master File';
    } else {
      // Not ready yet: show top bar, disable button
      topActionBarUpdate.classList.remove('hidden');
      updateMainContent.classList.remove('hidden');
      updateActionContainer.classList.remove('hidden');
      saveConfirm.classList.add('hidden');
      //performanceLog.classList.add('hidden');
      openBtn.disabled = true;
      openBtn.classList.add('opacity-50', 'cursor-not-allowed');
      openBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Waiting for Input Variable Report';
    }
  }

  // Modal Handlers
  openBtn.addEventListener('click', () => {
    if (currentPayrollStage < STAGE_INPUT_VAR_READY) {
      showAlert('Not Ready', 'Please complete Input Variable Report first', 'warning');
      return;
    }
    modal.classList.remove('hidden');
    statusEl.classList.add('hidden');
    statusEl.textContent = '';
  });

  function closeModal() {
    modal.classList.add('hidden');
  }

  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

  // Main Update Function
  confirmBtn.addEventListener('click', async () => {
    saveConfirm.classList.add('hidden');
    statusEl.classList.add('hidden');
    confirmBtn.disabled = true;
    closeModal();

    // Show progress modal
    progressModal.classList.remove('hidden');
    progressMessage.textContent = 'Please wait while we process your request...';
    
    // Safely hide the steps container and log container if they exist
    if (progressSteps) progressSteps.style.display = 'none';
    if (logContainer) logContainer.style.display = 'none';
    
    // Get progress bar elements
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    // Reset progress bar
    if (progressBar) progressBar.style.width = '0%';
    if (progressPercent) progressPercent.textContent = '0%';

    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
      if (progress < 90) {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressPercent) progressPercent.textContent = Math.round(progress) + '%';
      }
    }, 500);

    try {
      const token = localStorage.getItem('token');

      const response = await fetch(`${API_BASE}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      clearInterval(progressInterval);

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Server error: HTTP ${response.status}`);
      }

      const data = await response.json();
      
      // Check for failures in the response
      if (data.status === 'FAILED' || data.error) {
        throw new Error(data.error || data.message || 'Master file update failed');
      }

      // Complete progress bar
      if (progressBar) progressBar.style.width = '100%';
      if (progressPercent) progressPercent.textContent = '100%';
      progressMessage.textContent = 'Master file update completed successfully!';

      hasUpdatedOnce = true;
      currentPayrollStage = STAGE_UPDATE_COMPLETED;

      setTimeout(() => {
        progressModal.classList.add('hidden');
        if (progressSteps) progressSteps.style.display = 'block';
        if (logContainer) logContainer.style.display = 'block';
        updateUIVisibility();
        showAlert('Success!', data.message || 'Master file updated successfully. You can now proceed to Payroll Calculations.', 'success');
        
        // Dispatch event to notify other sections
        window.dispatchEvent(new CustomEvent('payrollStatusChanged', {
          detail: { stage: STAGE_UPDATE_COMPLETED }
        }));
      }, 1500);

    } catch (error) {
      console.error('Update error:', error);
      clearInterval(progressInterval);
      
      // Extract error message
      let errorMessage = error.message || 'An error occurred during the master file update.';
      
      // Stop progress and show error state
      progressMessage.textContent = errorMessage;
      progressMessage.className = 'text-red-600 mb-4 font-semibold';
      
      // Change progress bar to red
      if (progressBar) {
        progressBar.classList.remove('bg-green-600');
        progressBar.classList.add('bg-red-600');
      }
      
      // Hide icon, show error icon
      const iconDiv = progressModal.querySelector('.bg-green-600.rounded-full');
      if (iconDiv) {
        iconDiv.className = 'w-16 h-16 bg-red-600 rounded-full flex items-center justify-center';
        iconDiv.innerHTML = '<i class="fas fa-exclamation-circle text-white text-3xl"></i>';
      }
      
      // Add cancel button
      let cancelBtnError = document.getElementById('progressCancelBtn');
      if (!cancelBtnError) {
        cancelBtnError = document.createElement('button');
        cancelBtnError.id = 'progressCancelBtn';
        cancelBtnError.className = 'mt-4 px-6 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition';
        cancelBtnError.innerHTML = '<i class="fas fa-times mr-2"></i>Close';
        cancelBtnError.onclick = () => {
          progressModal.classList.add('hidden');
          if (progressSteps) progressSteps.style.display = 'block';
          if (logContainer) logContainer.style.display = 'block';
          // Reset UI
          progressMessage.textContent = 'Please wait while we process your request...';
          progressMessage.className = 'text-gray-600 mb-6';
          if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-red-600');
            progressBar.classList.add('bg-green-600');
          }
          if (progressPercent) progressPercent.textContent = '0%';
          if (iconDiv) {
            iconDiv.className = 'w-16 h-16 bg-green-600 rounded-full flex items-center justify-center';
            iconDiv.innerHTML = '<i class="fas fa-database text-white text-3xl"></i>';
          }
          cancelBtnError.remove();
          confirmBtn.disabled = false;
        };
        progressModal.querySelector('.text-center').appendChild(cancelBtnError);
      }
    }
  });

  // Check Payroll Status
  async function checkPayrollStatus() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(STATUS_API, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) return;
      
      const data = await response.json();
      currentPayrollStage = Number(data?.sun || STAGE_DATA_ENTRY_OPEN);
      
      // Check if already updated
      if (currentPayrollStage >= STAGE_UPDATE_COMPLETED) {
        hasUpdatedOnce = true;
      }
      
      updateUIVisibility();
    } catch (error) {
      console.error('Error checking payroll status:', error);
    }
  }

  // Listen for payroll status changes
  window.addEventListener('payrollStatusChanged', function (event) {
    if (event.detail && typeof event.detail.stage === 'number') {
      currentPayrollStage = event.detail.stage;
      
      // Reset if new payroll period
      if (currentPayrollStage === STAGE_DATA_ENTRY_OPEN) {
        hasUpdatedOnce = false;
        //summaryEmployees.textContent = '0';
        //summaryRecords.textContent = '0';
        //summaryAmount.textContent = '₦0.00';
        //performanceLogContent.innerHTML = '';
      }
      
      updateUIVisibility();
    } else {
      checkPayrollStatus();
    }
  });

  // Refresh function for external calls
  window.refreshMasterFileUpdateUI = function () {
    checkPayrollStatus();
  };

  // Initialize
  function initialize() {
    checkPayrollStatus();
  }

  document.addEventListener('DOMContentLoaded', initialize);
  if (document.readyState !== 'loading') initialize();
})();
</script>



