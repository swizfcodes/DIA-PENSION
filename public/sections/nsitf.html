<!-- NSITF REPORT -->
<section class="items border rounded-lg m-6 max-w-lg mr-auto p-6 mx-auto">
  <h2 class="text-xl text-center border-b font-bold text-green-600 mb-4">Print NSITF Reports</h2>

  <form id="nsitfPfaForm" class="space-y-4">
    <!-- Pfa Selection -->
    <div>
      <label class="block font-medium mb-2">Select PFA</label>
      <div class="flex space-x-4">
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" id="allPfas" name="pfaChoice" value="all" checked>
          <span>All PFAS</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" id="specificPfa" name="pfaChoice" value="specific">
          <span>Specific PFA</span>
        </label>
      </div>
      <select id="pfaDropdown"
        class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" disabled>
        <option value="">Select Pfa</option>
        <!-- Options will be loaded from API -->
      </select>
    </div>

    <!-- Processing Month -->
    <div class="grid grid-cols-2 gap-3">
      <div class="col-span-1">
        <label for="pfaMonth" class="block text-sm font-medium mb-1">Processing Month</label>
        <select id="pfaMonth"
          class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
          <option value="">Select Month</option>
          <option>January</option>
          <option>February</option>
          <option>March</option>
          <option>April</option>
          <option>May</option>
          <option>June</option>
          <option>July</option>
          <option>August</option>
          <option>September</option>
          <option>October</option>
          <option>November</option>
          <option>December</option>
        </select>        
      </div>

      <div class="col-span-1">
        <label for="pfaYear" class="block text-sm font-medium mb-1">Processing Year</label>
        <input type="number" id="year" name="year" placeholder="Year"
          class="w-full bg-transparent border border-green-500 rounded px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" 
          min="2000" max="2100" value="" />
      </div>
    </div>

    <!-- Output Format -->
    <div>
      <label class="block font-medium mb-2">Output Format</label>
      <div class="flex space-x-4">
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="pfaFormat" value="pdf" checked>
          <span>PDF</span>
        </label>
        <label class="flex text-sm items-center space-x-2">
          <input type="radio" name="pfaFormat" value="excel">
          <span>Excel</span>
        </label>
      </div>
    </div>

    <div class="flex justify-between items-center gap-2 mb-4">
        <!-- Summary Report -->
        <div class="flex items-center space-x-2">
        <input type="checkbox" id="pfaSummary" class="h-4 w-4">
        <label for="pfaSummary" class="text-sm">Summary Report</label>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-2 pt-2">
        <button type="reset" id="pfaClearBtn"
            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
            Clear
        </button>
        <button type="button" id="pfaPrintBtn"
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            Generate
        </button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="pfaLoadingIndicator" class="hidden text-center text-green-600 text-sm">
      <span>Generating report...</span>
    </div>
  </form>
</section>

<!-- Confirm -->
<div id="pfaConfirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h3 class="text-lg font-semibold mb-4">Confirm Generation</h3>
    <p class="mb-6 text-gray-700">Do you want to continue with report generation?</p>
    <div class="flex justify-end gap-2">
      <button id="pfaCancelBtn" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
      <button id="pfaContinueBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Continue</button>
    </div>
  </div>
</div>

<!-- Processing -->
<div id="pfaProcessingModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-80 p-6 text-center">
    <div class="animate-spin h-10 w-10 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-4"></div>
    <p class="text-gray-700">Generating report...</p>
  </div>
</div>

<!-- Success -->
<div id="pfaSuccessModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-blue-600 mb-4">Success</h3>
    <p class="mb-6 text-gray-700" id="pfaSuccessMessage">Report generated successfully!</p>
    <div class="flex justify-center gap-2">
      <button id="pfaPrintNowBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">OK</button>
    </div>
  </div>
</div>

<!-- Error -->
<div id="pfaErrorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 text-center">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Error</h3>
    <p id="pfaErrorText" class="mb-6 text-gray-700">Please complete required fields.</p>
    <button id="pfaErrorOkBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">OK</button>
  </div>
</div>

<script>
  // API Configuration
  const API_BASE = '/nstif';

  // Elements
  const allPfas = document.getElementById('allPfas');
  const specificPfa = document.getElementById('specificPfa');
  const pfaDropdown = document.getElementById('pfaDropdown');
  const pfaMonth = document.getElementById('pfaMonth');
  const pfaYear = document.getElementById('year');
  const pfaPrintBtn = document.getElementById('pfaPrintBtn');
  const pfaClearBtn = document.getElementById('pfaClearBtn');
  const pfaLoadingIndicator = document.getElementById('pfaLoadingIndicator');

  const pfaConfirmModal = document.getElementById('pfaConfirmModal');
  const pfaCancelBtn = document.getElementById('pfaCancelBtn');
  const pfaContinueBtn = document.getElementById('pfaContinueBtn');

  const pfaProcessingModal = document.getElementById('pfaProcessingModal');
  const pfaSuccessModal = document.getElementById('pfaSuccessModal');
  const pfaPrintNowBtn = document.getElementById('pfaPrintNowBtn');
  const pfaSuccessMessage = document.getElementById('pfaSuccessMessage');

  const pfaErrorModal = document.getElementById('pfaErrorModal');
  const pfaErrorOkBtn = document.getElementById('pfaErrorOkBtn');
  const pfaErrorText = document.getElementById('pfaErrorText');

  // Helper function to convert month name to number
  function getMonthNumber(monthName) {
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    return months.indexOf(monthName) + 1;
  }

  // Helper function to convert month number to name
  function getMonthName(monthNum) {
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    return months[monthNum - 1] || '';
  }

  // Load available PFAS from API
  async function loadPfas() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.pfas) {
          pfaDropdown.innerHTML = '<option value="">Select Pfa</option>';
          result.data.pfas.forEach(pfa => {
            const option = document.createElement('option');
            option.value = pfa.pfa_code;
            option.textContent = pfa.pfa_name;
            pfaDropdown.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading PFAS:', error);
    }
  }

  // Load current period and set default month
  async function loadCurrentPeriod() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/filter-options`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data.currentPeriod) {
          const period = result.data.currentPeriod;
          pfaMonth.value = getMonthName(period.month);
          pfaYear.value = period.year;
        }
      }
    } catch (error) {
      console.error('Error loading current period:', error);
    }
  }

  // Toggle pfa select disabled/enabled
  function togglePfaSelect() {
    pfaDropdown.disabled = allPfas.checked;
    if (allPfas.checked) pfaDropdown.value = '';
  }

  allPfas.addEventListener('change', togglePfaSelect);
  specificPfa.addEventListener('change', togglePfaSelect);

  // Open confirm modal
  pfaPrintBtn.addEventListener('click', () => {
    // Validation before showing confirm modal
    if (!pfaMonth.value) {
      pfaErrorText.textContent = 'Please select a processing month.';
      pfaErrorModal.classList.remove('hidden');
      return;
    }

    if (specificPfa.checked && !pfaDropdown.value) {
      pfaErrorText.textContent = 'Please choose a PFA when "Specific Pfa" is selected.';
      pfaErrorModal.classList.remove('hidden');
      return;
    }

    pfaConfirmModal.classList.remove('hidden');
  });

  // Cancel confirm
  pfaCancelBtn.addEventListener('click', () => {
    pfaConfirmModal.classList.add('hidden');
  });

  // Continue -> validate -> process
  pfaContinueBtn.addEventListener('click', async () => {
    pfaConfirmModal.classList.add('hidden');

    // Validate again
    if ((specificPfa.checked && !pfaDropdown.value) || !pfaMonth.value) {
      pfaErrorText.textContent = !pfaMonth.value
        ? 'Please select a processing month.'
        : 'Please choose a pfa when "Specific Pfa" is selected.';
      pfaErrorModal.classList.remove('hidden');
      return;
    }

    // Show processing modal
    pfaProcessingModal.classList.remove('hidden');
    pfaPrintBtn.disabled = true;

    const format = document.querySelector('input[name="pfaFormat"]:checked').value;
    const summary = document.getElementById('pfaSummary').checked;
    const monthNum = getMonthNumber(pfaMonth.value);
    const year = pfaYear.value || new Date().getFullYear();

    try {
      const token = localStorage.getItem('token');
      
      // Build query parameters
      const params = new URLSearchParams({
        format: format,
        month: monthNum,
        year: year,
        summaryOnly: summary ? 'true' : 'false'
      });

      if (specificPfa.checked && pfaDropdown.value) {
        params.append('pfa_code', pfaDropdown.value);
      }

      const response = await fetch(`${API_BASE}/generate?${params.toString()}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to generate report');
      }

      // Download file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      
      // Open PDF in new tab
      if (format === 'pdf') {
        window.open(url, '_blank');
      }
      
      // Also trigger download
      const a = document.createElement('a');
      a.href = url;
      a.download = `pfa_report_${pfaMonth.value}_${new Date().getFullYear()}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      
      setTimeout(() => window.URL.revokeObjectURL(url), 100);

      pfaProcessingModal.classList.add('hidden');
      pfaPrintBtn.disabled = false;
      pfaSuccessMessage.textContent = `Report generated successfully! Your ${format.toUpperCase()} is ${format === 'pdf' ? 'opening in a new tab and' : ''} downloading.`;
      pfaSuccessModal.classList.remove('hidden');

    } catch (error) {
      pfaProcessingModal.classList.add('hidden');
      pfaPrintBtn.disabled = false;
      pfaErrorText.textContent = error.message || 'Failed to generate report. Please try again.';
      pfaErrorModal.classList.remove('hidden');
      console.error('Error:', error);
    }
  });

  // Error OK
  pfaErrorOkBtn.addEventListener('click', () => {
    pfaErrorModal.classList.add('hidden');
  });

  // Success OK - close modal
  pfaPrintNowBtn.addEventListener('click', () => {
    pfaSuccessModal.classList.add('hidden');
    // Optionally reset form here
    document.getElementById('nsitfPfaForm').reset();
    allPfas.checked = true;
    togglePfaSelect();
    loadCurrentPeriod(); // Reload default month
  });

  // Reset/clear
  pfaClearBtn.addEventListener('click', () => {
    // Let the native reset run, then normalize radios & disabled pfa
    setTimeout(() => {
      allPfas.checked = true;    // ensure default
      togglePfaSelect();         // disable the dropdown
      pfaMonth.value = '';         // reset month
      loadCurrentPeriod();         // reload default month
    }, 0);
  });

  // Initialize on load
  togglePfaSelect();
  loadPfas();
  loadCurrentPeriod();
</script>



