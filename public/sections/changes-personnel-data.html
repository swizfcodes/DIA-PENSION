<div class="p-6">
  <!-- Top Action Bar (Hidden after stage >= 775) -->
  <div id="topActionBar" class="hidden mb-6 w-full flex justify-between items-center border-b-2 pb-4 no-print">
    <h2 class="text-green-600 font-semibold lg:text-lg">
      <i class="fas fa-info-circle mr-2"></i>First ensure you have saved payroll files
    </h2>
    <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('save-payroll-files', 'Save Payroll Files')" 
            class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
      <i class="fas fa-save mr-2"></i>Save Payroll Files
    </button>
  </div>

  <!-- Not Ready Message (Stage < 666) -->
  <div id="notReadyMessage" class="hidden mb-6">
    <div class="border-2 border-green-300 rounded-lg p-8 text-center">
      <i class="fas fa-lock text-green-600 text-6xl mb-4"></i>
      <h2 class="text-2xl font-bold text-green-900 mb-3">
        Personnel Details Report Not Available Yet
      </h2>
      <p class="text-green-800 text-lg mb-4">
        This section will become available once the payroll files are saved.
      </p>
      <p class="text-green-700">
        Please complete all prior steps before accessing this report.
      </p>
    </div>
  </div>


  <!-- Main Form -->
  <section id="mainForm" class="hidden items m-6 max-w-lg mr-auto mx-auto">
    <!-- Show Filter Button (for reprints) -->
    <div class="flex justify-end mb-4">
      <button id="showFilterBtn" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
        <i class="fas fa-filter mr-2"></i>Show Filter
      </button>
    </div>

    <!-- Form Content (collapsible) -->
    <div id="formContent">
      <!-- Radio Selection -->
      <div class="mb-2 pb-2 border-b">
        <span class="text-green-600 font-semibold text-lg block mb-3">Select Report Scope:</span>
        <div class="flex gap-6">
          <label class="flex items-center cursor-pointer">
            <input type="radio" name="changeScope" value="all" class="text-green-600 w-4 h-4" checked>
            <span class="ml-2 font-medium">All Personnel</span>
          </label>

          <label class="flex items-center cursor-pointer">
            <input type="radio" name="changeScope" value="personnel" class="text-green-600 w-4 h-4">
            <span class="ml-2 font-medium">Specific Personnel</span>
          </label>
        </div>
      </div>

    <!-- Dynamic Form Fields -->
    <div id="changeForm" class="space-y-5">
      
      <!-- Period Range Section -->
      <div class="">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“… Period Range (Required)</h3>
        
        <!-- From Period -->
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-900 mb-1">From Period</label>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Year</label>
              <select id="fromYear" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">-- Year --</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Month</label>
              <select id="fromMonth" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">-- Month --</option>
              </select>
            </div>
          </div>
        </div>

        <!-- To Period -->
        <div>
          <label class="block text-sm font-medium text-gray-900 mb-1">To Period</label>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Year</label>
              <select id="toYear" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">-- Year --</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Month</label>
              <select id="toMonth" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">-- Month --</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Personnel Select (Hidden by default) -->
      <div id="personnelSelectWrapper" class="hidden bg-blue-50 p-2 rounded-lg">
        <label class="block text-sm font-medium text-gray-900 mb-2">
          <i class="fas fa-user text-blue-600 mr-2"></i>Select Personnel
        </label>
        <select id="personnelSelect" class="w-full border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Choose Personnel --</option>
        </select>
        <div id="personnelLoading" class="hidden mt-2 text-sm text-gray-600">
          <i class="fas fa-spinner fa-spin mr-2"></i>Loading personnel...
        </div>
      </div>

      <!-- Export Format Selection -->
      <div class="mt-2">
        <label class="block text-sm font-medium text-gray-900 mb-2">
          <i class="fas fa-file-export text-gray-600 mr-2"></i>Export Format
        </label>
        <div class="flex gap-4">
          <label class="flex items-center cursor-pointer">
            <input type="radio" name="exportFormat" value="pdf" class="text-green-600 w-4 h-4" checked>
            <span class="ml-2">PDF</span>
          </label>
          <label class="flex items-center cursor-pointer">
            <input type="radio" name="exportFormat" value="excel" class="text-green-600 w-4 h-4">
            <span class="ml-2">Excel (.xlsx)</span>
          </label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button id="cancelChange" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg transition-colors">
          <i class="fas fa-times mr-2"></i>Clear
        </button>

        <button id="generateChange" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition-colors shadow-lg hover:shadow-xl">
          <i class="fas fa-file-alt mr-2"></i>Generate Report
        </button>
      </div>
    </div>
    </div>
  </section>

  <!-- Success Banner -->
  <div id="nextStepBanner" class="hidden mt-6 no-print">
    <div class="border-2 border-blue-200 rounded-lg p-6 bg-blue-50">
      <div class="flex items-start">
        <i class="fas fa-check-circle text-blue-500 text-3xl mr-4"></i>
        <div class="flex-1">
          <h4 class="text-blue-800 font-bold text-lg mb-2">Employee Change History Generated Successfully!</h4>
          <p class="text-blue-700 mb-4">Your report has been downloaded. Ready to proceed to the next step?</p>
          <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('input-variable-report', 'Input Variable Report')" 
                  class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
            <i class="fas fa-file-alt mr-2"></i>Input Variable Report
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-8 text-center">
    <div class="mb-4">
      <i class="fas fa-spinner fa-spin text-4xl text-green-600"></i>
    </div>
    <h3 class="text-lg font-semibold mb-2">Generating Report...</h3>
    <p class="text-gray-600">Please wait while we analyze employee changes.</p>
  </div>
</div>

<!-- Alert Modal -->
<div id="changeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex items-start mb-4">
      <div id="changeModalIcon" class="mr-3 text-2xl"></div>
      <div class="flex-1">
        <h3 id="changeModalTitle" class="text-lg font-semibold mb-2"></h3>
        <p id="changeModalMessage" class="text-gray-700"></p>
      </div>
    </div>
    <div class="flex justify-end">
      <button id="changeModalCloseBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
  </div>
</div>


<script>
(function() {
  const API_BASE = '/personneldata';
  
  // BT05 Stages
  const STAGE_READY = 666;
  const STAGE_PRINTED = 775;
  
  // State
  let currentStage = 0;
  let hasGenerated = false;
  
  // DOM Elements
  const topActionBar = document.getElementById('topActionBar');
  const notReadyMessage = document.getElementById('notReadyMessage');
  const mainForm = document.getElementById('mainForm');
  const formContent = document.getElementById('formContent');
  const showFilterBtn = document.getElementById('showFilterBtn');
  const nextStepBanner = document.getElementById('nextStepBanner');
  
  const changeRadios = document.querySelectorAll('input[name="changeScope"]');
  const personnelSelectWrapper = document.getElementById("personnelSelectWrapper");
  const personnelSelect = document.getElementById("personnelSelect");
  const personnelLoading = document.getElementById("personnelLoading");
  
  const generateChangeBtn = document.getElementById("generateChange");
  const cancelChangeBtn = document.getElementById("cancelChange");

  const changeModal = document.getElementById("changeModal");
  const changeModalTitle = document.getElementById("changeModalTitle");
  const changeModalMessage = document.getElementById("changeModalMessage");
  const changeModalIcon = document.getElementById("changeModalIcon");
  const changeModalCloseBtn = document.getElementById("changeModalCloseBtn");
  const loadingModal = document.getElementById("loadingModal");

  let filterOptions = null;

  // Show modal
  function showChangeModal(title, message, isError = false) {
    changeModalTitle.textContent = title;
    changeModalMessage.textContent = message;
    changeModalIcon.innerHTML = isError 
      ? '<i class="fas fa-exclamation-circle text-red-500"></i>'
      : '<i class="fas fa-check-circle text-blue-500"></i>';
    changeModal.classList.remove("hidden");
  }

  changeModalCloseBtn.onclick = () => changeModal.classList.add("hidden");

  // Show Filter button - reveals form for reprints
  showFilterBtn.onclick = () => {
    formContent.classList.remove('hidden');
    showFilterBtn.classList.add('hidden');
  };

  // Update UI visibility based on stage
  function updateUIVisibility() {
    // Stage >= 666: Ready to use
    if (currentStage >= STAGE_READY) {
      topActionBar.classList.add('hidden');
      notReadyMessage.classList.add('hidden');
      
      if (hasGenerated) {
        // After first print (stage >= 775): hide form content, show banner, show "Show Filter" button
        mainForm.classList.remove('hidden');
        formContent.classList.add('hidden');
        showFilterBtn.classList.remove('hidden');
        nextStepBanner.classList.remove('hidden');
      } else {
        // Before first print (stage 666-774): show form content, hide banner, hide "Show Filter" button
        mainForm.classList.remove('hidden');
        formContent.classList.remove('hidden');
        showFilterBtn.classList.add('hidden');
        nextStepBanner.classList.add('hidden');
      }
      return;
    }

    // Not ready yet (stage < 666)
    topActionBar.classList.remove('hidden');
    notReadyMessage.classList.remove('hidden');
    mainForm.classList.add('hidden');
    nextStepBanner.classList.add('hidden');
  }

  // Load filter options on page load
  async function loadFilterOptions() {
    try {
      const token = localStorage.getItem('token') || '';
      const response = await fetch(`${API_BASE}/filter-options`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await response.json();
      
      if (result.success) {
        filterOptions = result.data;
        
        // Populate years
        const fromYearSelect = document.getElementById('fromYear');
        const toYearSelect = document.getElementById('toYear');
        
        filterOptions.years.forEach(year => {
          const option1 = document.createElement('option');
          option1.value = year.code;
          option1.textContent = year.description;
          fromYearSelect.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = year.code;
          option2.textContent = year.description;
          toYearSelect.appendChild(option2);
        });
        
        // Populate months
        const fromMonthSelect = document.getElementById('fromMonth');
        const toMonthSelect = document.getElementById('toMonth');
        
        filterOptions.months.forEach(month => {
          const option1 = document.createElement('option');
          option1.value = month.code;
          option1.textContent = month.description;
          fromMonthSelect.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = month.code;
          option2.textContent = month.description;
          toMonthSelect.appendChild(option2);
        });
        
        // Set default "to" period to current
        toYearSelect.value = filterOptions.currentYear.toString();
        toMonthSelect.value = filterOptions.currentMonth.toString();
        
        // Populate employees
        if (filterOptions.employees && filterOptions.employees.length > 0) {
          filterOptions.employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.employee_id;
            option.textContent = `${emp.employee_id} - ${emp.full_name}`;
            personnelSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading filter options:', error);
      showChangeModal('Error', 'Failed to load filter options. Please refresh the page.', true);
    }
  }

  // Radio change event
  changeRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      personnelSelectWrapper.classList.add("hidden");

      if (radio.value === "personnel") {
        personnelSelectWrapper.classList.remove("hidden");
      }
    });
  });

  // Generate button
  generateChangeBtn.onclick = async () => {
    const selectedScope = document.querySelector('input[name="changeScope"]:checked')?.value;
    const fromYear = document.getElementById("fromYear").value;
    const fromMonth = document.getElementById("fromMonth").value;
    const toYear = document.getElementById("toYear").value;
    const toMonth = document.getElementById("toMonth").value;
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';

    // Validation
    if (!selectedScope) {
      return showChangeModal("Validation Error", "Please select a report scope!", true);
    }
    if (!fromYear || !fromMonth) {
      return showChangeModal("Validation Error", "Please select From period (year and month)!", true);
    }
    if (!toYear || !toMonth) {
      return showChangeModal("Validation Error", "Please select To period (year and month)!", true);
    }

    // Build query parameters
    let queryParams = `fromYear=${fromYear}&fromMonth=${fromMonth}&toYear=${toYear}&toMonth=${toMonth}&format=${exportFormat}`;

    // Add employee filter if selected
    if (selectedScope === "personnel") {
      const emplId = personnelSelect.value;
      if (!emplId) {
        return showChangeModal("Validation Error", "Please select a personnel!", true);
      }
      queryParams += `&emplId=${emplId}`;
    }

    // Show loading modal
    loadingModal.classList.remove("hidden");

    try {
      const token = localStorage.getItem('token') || '';
      const response = await fetch(`${API_BASE}?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to generate report');
      }

      // Handle file download for Excel/PDF
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `employee_changes_${fromYear}${fromMonth}_${toYear}${toMonth}.${exportFormat === 'excel' ? 'xlsx' : 'pdf'}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      loadingModal.classList.add("hidden");
      
      // Mark as generated
      hasGenerated = true;
      
      // Hide form content, show banner, show "Show Filter" button
      formContent.classList.add('hidden');
      showFilterBtn.classList.remove('hidden');
      nextStepBanner.classList.remove("hidden");
      
      showChangeModal(
        "Success", 
        `Report downloaded successfully!`
      );
    } catch (error) {
      loadingModal.classList.add("hidden");
      console.error('Error generating report:', error);
      showChangeModal("Error", error.message || 'Failed to generate report', true);
    }
  };

  // Cancel/Clear button
  cancelChangeBtn.onclick = () => {
    // Hide personnel wrapper
    personnelSelectWrapper.classList.add("hidden");

    // Reset all form fields
    document.getElementById("fromYear").value = "";
    document.getElementById("fromMonth").value = "";
    document.getElementById("toYear").value = "";
    document.getElementById("toMonth").value = "";
    document.getElementById("personnelSelect").value = "";
    
    // Reset radio to "all"
    document.querySelector('input[name="changeScope"][value="all"]').checked = true;
    
    // Reset export format to PDF
    document.querySelector('input[name="exportFormat"][value="pdf"]').checked = true;
    
    // If already generated, hide form and show banner
    if (hasGenerated) {
      formContent.classList.add('hidden');
      showFilterBtn.classList.remove('hidden');
    }
    
    // Reload filter options to reset defaults
    loadFilterOptions();
  };

  // Check payroll status
  async function checkPayrollStatus() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch('/status-payroll', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      currentStage = Number(data?.sun || 0);
      
      // If stage >= 775, report has already been generated at least once
      if (currentStage >= STAGE_PRINTED) {
        hasGenerated = true;
      }
      
      updateUIVisibility();
      
      // Load filter options if stage is ready (>= 666)
      if (currentStage >= STAGE_READY) {
        await loadFilterOptions();
      }
    } catch (err) {
      console.error('Error checking status:', err);
    }
  }

  // Initialize
  function initialize() {
    checkPayrollStatus();
  }
  
  document.addEventListener('DOMContentLoaded', initialize);
  if (document.readyState !== 'loading') initialize();
})();
</script>